 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 1 - 7/12/2023 13:23:49


       1/       0 :                     ;;; 
       2/       0 :                     ;;; Universal Monitor for Zilog Z80
       3/       0 :                     ;;;   Copyright (C) 2019,2020,2021 Haruo Asano
       4/       0 :                     ;;;
       5/       0 :                     
       6/       0 :                     	CPU	Z80
       7/       0 :                     
       8/       0 : ="Z80"              TARGET:	equ	"Z80"
       9/       0 :                     
      10/       0 :                     
      11/       0 :                     	INCLUDE	"config.inc"
(1)    1/       0 :                     ;;; -*- asm -*-
(1)    2/       0 :                     ;;;
(1)    3/       0 :                     ;;; Universal Monitor Z80 config file (for AKI-80)
(1)    4/       0 :                     ;;;
(1)    5/       0 :                     
(1)    6/       0 :                     ;;;
(1)    7/       0 :                     ;;; Memory
(1)    8/       0 :                     ;;;
(1)    9/       0 :                     
(1)   10/       0 : =80H                ENTRY:	EQU	0080H		; Entry point
(1)   11/       0 :                     
(1)   12/       0 : =8000H              RAM_B:	EQU	8000H
(1)   13/       0 : =0FF00H             WORK_B:	equ	0FF00H
(1)   14/       0 : =0H                 STACK:	equ	0000H
(1)   15/       0 :                     
(1)   16/       0 : =10H                BUFLEN:	equ	16
(1)   17/       0 :                     
(1)   18/       0 :                     ;;;
(1)   19/       0 :                     ;;; Options
(1)   20/       0 :                     ;;;
(1)   21/       0 :                     
(1)   22/       0 : =1H                 USE_IDENT = 1			; CPU Identification
(1)   23/       0 :                     
(1)   24/       0 : =1H                 USE_REGCMD = 1			; R(egister) command and related functions
(1)   25/       0 :                     
(1)   26/       0 : =1H                 USE_RAMCHK = 1			; Check RAM
(1)   27/       0 :                     
(1)   28/       0 : =0H                 USE_WARMUP = 0			; DRAM warming up
(1)   29/       0 : =>FALSE             	IF USE_WARMUP
(1)   30/       0 :                     WARMUP_ADDR = 8000H		;   Start address
(1)   31/       0 :                     WARMUP_INCR = 1			;   Address increment
(1)   32/       0 :                     WARMUP_CNT = 128 * 8		;   Count
(1)   33/       0 : [29]                	ENDIF
(1)   34/       0 :                     
(1)   35/       0 : =1H                 USE_NEWAPI = 1			; New API (RST 30H)
(1)   36/       0 :                     
(1)   37/       0 :                     ;;; HD64180 specific
(1)   38/       0 : =0H                 DCNTL_V: EQU	00H
(1)   39/       0 : =83H                RMR_V:	EQU	83H
(1)   40/       0 : =40H                OMCR_V:	EQU	40H
(1)   41/       0 : =0C0H               IOBASE:	EQU	0C0H		; Internal I/O BASE (00H,40H,80H,0C0H)
(1)   42/       0 :                     
(1)   43/       0 : =1H                 USE_180TRAP = 1			; Handle HD64180 TRAP (experimental)
(1)   44/       0 :                     
(1)   45/       0 :                     ;;; Z8S180 specific
(1)   46/       0 :                     	;; CPU Control Register
(1)   47/       0 : =0H                 CCR1_V:	EQU	00H
(1)   48/       0 :                     	
(1)   49/       0 :                     ;;; Z280 specific
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(config.inc) - Page 2 - 7/12/2023 13:23:49


(1)   50/       0 :                     	;; Bus Timing and Control Register: none additional WAIT
(1)   51/       0 : =30H                BTCR_V:	EQU	30H		; I/O=00, HM=00, DC=00
(1)   52/       0 :                     	;; Bus Timing and Initialization Register
(1)   53/       0 : =40H                BTIR_V:	EQU	40H		; (CS=00), LM=00, MP=0, (BS=1), (DIC=0)
(1)   54/       0 :                     	;; Cache Control Register
(1)   55/       0 : =0H                 CCR_V:	EQU	00H		; Instruction & data cache enable, no burst mode
(1)   56/       0 :                     	;; Refresh Rate Register
(1)   57/       0 : =38H                RRR_V:	EQU	38H		; Disable refresh
(1)   58/       0 :                     
(1)   59/       0 :                     ;;;
(1)   60/       0 :                     ;;; Special initialize routine
(1)   61/       0 :                     ;;;
(1)   62/       0 :                     
(1)   63/       0 : =0H                 USE_SPINIT = 0
(1)   64/       0 : =>FALSE             	IF USE_SPINIT
(1)   65/       0 :                     
(1)   66/       0 :                     SPINIT	MACRO
(1)   67/       0 :                     	ENDM
(1)   68/       0 :                     
(1)   69/       0 : [64]                	ENDIF
(1)   70/       0 :                     
(1)   71/       0 :                     ;;;
(1)   72/       0 :                     ;;; Console Drivers
(1)   73/       0 :                     ;;;
(1)   74/       0 :                     
(1)   75/       0 :                     ;;; Zilog Z80 SIO
(1)   76/       0 :                     	
(1)   77/       0 : =1H                 USE_DEV_Z80SIO = 1
(1)   78/       0 : =>TRUE              	IF USE_DEV_Z80SIO
(1)   79/       0 : =18H                SIOAD:	equ	18H		; 
(1)   80/       0 : =19H                SIOAC:	equ	19H		;
(1)   81/       0 : =1AH                SIOBD:	equ	1AH		; (Ch.B not supported)
(1)   82/       0 : =1BH                SIOBC:	equ	1BH		; (Ch.B not supported)
(1)   83/       0 : =1H                 USE_Z80CTC = 1			; Use Z80 CTC for baudrate generator
(1)   84/       0 : =>TRUE              	IF USE_Z80CTC
(1)   85/       0 : =13H                CTC0:	EQU	13H
(1)   86/       0 : =5H                 TC_V:	EQU	5		; 9600bps @ 12.228MHz
(1)   87/       0 : [84]                	ENDIF			; USE_Z80CTC
(1)   88/       0 : [78]                	ENDIF
(1)   89/       0 :                     
(1)   90/       0 :                     ;;; Intel 8251
(1)   91/       0 :                     
(1)   92/       0 : =0H                 USE_DEV_8251 = 0
(1)   93/       0 : =>FALSE             	IF USE_DEV_8251
(1)   94/       0 :                     USARTD:	equ	00H		; Data Register
(1)   95/       0 :                     USARTC:	equ	01H		; Control / Status Register
(1)   96/       0 : [93]                	ENDIF
(1)   97/       0 :                     	
(1)   98/       0 :                     ;;; NS NSC858
(1)   99/       0 :                     
(1)  100/       0 : =0H                 USE_DEV_NSC858 = 0
(1)  101/       0 : =>FALSE             	IF USE_DEV_NSC858
(1)  102/       0 :                     NSBASE:	EQU	00H
(1)  103/       0 :                     RTMR_V:	EQU	0B0H		; Internal clock, 8 bit, no parity (RMR/TMR)
(1)  104/       0 :                     GMR_V:	EQU	01H		; 1 stop bit, x16
(1)  105/       0 :                     BRGD_V:	EQU	26		; 9600bps @ 4MHz
(1)  106/       0 : [101]               	ENDIF
(1)  107/       0 :                     
(1)  108/       0 :                     ;;; Zilog Z280 (Internal)
(1)  109/       0 :                     
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(config.inc) - Page 3 - 7/12/2023 13:23:49


(1)  110/       0 : =0H                 USE_DEV_Z280 = 0
(1)  111/       0 : =>FALSE             	IF USE_DEV_Z280
(1)  112/       0 :                     TCR1:	EQU	(19-1)		; bps = CLK(Xtal) / 8 / (TCR1+1) / 16
(1)  113/       0 : [111]               	ENDIF
(1)  114/       0 :                     
(1)  115/       0 :                     ;;; Hitachi HD64180 (Internal)
(1)  116/       0 :                     
(1)  117/       0 : =0H                 USE_DEV_64180 = 0
(1)  118/       0 : =>FALSE             	IF USE_DEV_64180
(1)  119/       0 :                     ASBASE:	EQU	IOBASE+0	; IOBASE+1 for ASCI Ch.1
(1)  120/       0 :                     CNTLA_V: EQU	6CH		; 8bit 1 N
(1)  121/       0 :                     CNTLB_V: EQU	02H		; CLK/640
(1)  122/       0 : [118]               	ENDIF
(1)  123/       0 :                     
(1)  124/       0 :                     ;;; EMILY Board (Shared Memory)
(1)  125/       0 :                     
(1)  126/       0 : =0H                 USE_DEV_EMILY = 0
(1)  127/       0 : =>FALSE             	IF USE_DEV_EMILY
(1)  128/       0 :                     SMREG:	EQU	0FF0H
(1)  129/       0 : [127]               	ENDIF
(1)  130/       0 :                     
      12/       0 :                     
      13/       0 :                     	INCLUDE	"../common.inc"
(1)    1/       0 :                     ;;; -*- asm -*-
(1)    2/       0 :                     ;;;
(1)    3/       0 :                     ;;; Common header file
(1)    4/       0 :                     ;;;
(1)    5/       0 :                     
(1)    6/       0 :                     	RELAXED	ON
(1)    7/       0 :                     
(1)    8/       0 :                     ;;; Constants
(1)    9/       0 : =0DH                CR:	EQU	0x0D
(1)   10/       0 : =0AH                LF:	EQU	0x0A
(1)   11/       0 : =8H                 BS:	EQU	0x08
(1)   12/       0 : =7FH                DEL:	EQU	0x7F
(1)   13/       0 :                     
(1)   14/       0 :                     ;;; Functions
(1)   15/       0 :                     low	function	x,(x & 255)
(1)   16/       0 :                     high	function	x,(x >> 8)
(1)   17/       0 :                     
(1)   18/       0 :                     	RELAXED	OFF
(1)   19/       0 :                     
      14/       0 :                     
      15/       0 :                     	
      16/       0 :                     ;;; 
      17/       0 :                     ;;; ROM area
      18/       0 :                     ;;;
      19/       0 :                     
      20/       0 :                     	ORG	0000H
      21/       0 : F3                  	DI
      22/       1 : C3 00 01            	JP	CSTART
      23/       4 :                     
      24/       8 :                     	ORG	0008H
      25/       8 :                     
      26/       8 :                     
      27/      10 :                     	ORG	0010H
      28/      10 : C3 38 0D            	JP	CONIN
      29/      13 :                     
      30/      18 :                     	ORG	0018H
      31/      18 : C3 46 0D            	JP	CONOUT
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 4 - 7/12/2023 13:23:49


      32/      1B :                     
      33/      1B :                     	;; ORG	0020H
      34/      1B :                     	;; JP	EEREAD
      35/      1B :                     
      36/      1B :                     	;; ORG	0028H
      37/      1B :                     	;; JP	EEWRITE
      38/      1B :                     
      39/      30 :                     	ORG	0030H
      40/      30 : C3 3B 09            	JP	RST30H
      41/      33 :                     
      42/      38 :                     	ORG	0038H
      43/      38 : C3 66 09            	JP	RST38H
      44/      3B :                     
      45/      66 :                     	ORG	0066H
      46/      66 : C3 66 80            	JP	RAM_B+0066H
      47/      69 :                     
      48/      69 :                     	;;
      49/      69 :                     	;; Entry point
      50/      69 :                     	;;
      51/      69 :                     
      52/      80 :                     	ORG	ENTRY+0		; Cold start
      53/      80 :                     E_CSTART:
      54/      80 : C3 00 01            	JP	CSTART
      55/      83 :                     	
      56/      88 :                     	ORG	ENTRY+8		; Warm start
      57/      88 :                     E_WSTART:
      58/      88 : C3 5C 02            	JP	WSTART
      59/      8B :                     
      60/      90 :                     	ORG	ENTRY+16	; Console output
      61/      90 :                     E_CONOUT:
      62/      90 : C3 46 0D            	JP	CONOUT
      63/      93 :                     
      64/      98 :                     	ORG	ENTRY+24	; (Console) String output
      65/      98 :                     E_STROUT:
      66/      98 : C3 4F 08            	JP	STROUT
      67/      9B :                     
      68/      A0 :                     	ORG	ENTRY+32	; Console input
      69/      A0 :                     E_CONIN:
      70/      A0 : C3 38 0D            	JP	CONIN
      71/      A3 :                     
      72/      A8 :                     	ORG	ENTRY+40	; Console status
      73/      A8 :                     E_CONST:
      74/      A8 : C3 41 0D            	JP	CONST
      75/      AB :                     
      76/      AB :                     	;;
      77/      AB :                     	;;
      78/      AB :                     	;; 
      79/      AB :                     
      80/     100 :                     	ORG	0100H
      81/     100 :                     CSTART:
      82/     100 :                     	;; Identify HD64180/Z180 TRAP
      83/     100 : =>TRUE              	IF USE_180TRAP
      84/     100 :                     	SAVE
      85/     100 :                     	CPU	Z180
      86/     100 : ED 73 00 FF         	LD	(INBUF),SP	; Save SP
      87/     104 : 31 10 FF            	LD	SP,INBUF+BUFLEN	; Temporary stack on INBUF area
      88/     107 : F5                  	PUSH	AF
      89/     108 : ED 5F               	LD	A,R
      90/     10A : 32 02 FF            	LD	(INBUF+2),A	; Save R
      91/     10D : C5                  	PUSH	BC
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 5 - 7/12/2023 13:23:49


      92/     10E : 01 FF 00            	LD	BC,00FFH
      93/     111 : ED 4C               	MLT	BC
      94/     113 : 78                  	LD	A,B
      95/     114 : B1                  	OR	C
      96/     115 : 20 1A               	JR	NZ,CS0		; Not HD64180/Z180
      97/     117 :                     	;; HD64180/Z180
      98/     117 : 3E C0               	LD	A,IOBASE
      99/     119 : ED 39 3F            	OUT0	(3FH),A
     100/     11C : ED 38 F4            	IN0	A,(IOBASE+34H)	; ITC register
     101/     11F : 32 03 FF            	LD	(INBUF+3),A
     102/     122 : E6 80               	AND	80H
     103/     124 : 28 0B               	JR	Z,CS0		; Not TRAP
     104/     126 : 3A 03 FF            	LD	A,(INBUF+3)
     105/     129 : E6 7F               	AND	7FH
     106/     12B : ED 39 F4            	OUT0	(IOBASE+34H),A	; Reset TRAP bit
     107/     12E : C3 D5 09            	JP	TRAPH
     108/     131 :                     CS0:
     109/     131 : ALL                 	RESTORE
     110/     131 : [83]                	ENDIF
     111/     131 :                     
     112/     131 : 31 00 00            	LD	SP,STACK
     113/     134 :                     
     114/     134 : =>FALSE             	IF USE_SPINIT
     115/     134 :                     	SPINIT
     116/     134 : [114]               	ENDIF
     117/     134 :                     
     118/     134 :                     	;; DRAM warming up
     119/     134 : =>FALSE             	IF USE_WARMUP
     120/     134 :                     
     121/     134 :                     	LD	HL,WARMUP_ADDR
     122/     134 :                     	IF WARMUP_INCR > 1
     123/     134 :                     	LD	DE,WARMUP_INCR
     124/     134 : [122]               	ENDIF
     125/     134 :                     	LD	BC,WARMUP_CNT
     126/     134 :                     WU0:
     127/     134 :                     	LD	A,(HL)
     128/     134 :                     	IF WARMUP_INCR == 1
     129/     134 :                     	INC	HL
     130/     134 : [128]               	ENDIF
     131/     134 :                     	IF WARMUP_INCR > 1
     132/     134 :                     	ADD	HL,DE
     133/     134 : [131]               	ENDIF
     134/     134 :                     	DEC	BC
     135/     134 :                     	LD	A,B
     136/     134 :                     	OR	C
     137/     134 :                     	JR	NZ,WU0
     138/     134 :                     
     139/     134 : [119]               	ENDIF
     140/     134 :                     
     141/     134 :                     	;; Check RAM
     142/     134 : =>TRUE              	IF USE_RAMCHK
     143/     134 :                     
     144/     134 : 11 00 80            	LD	DE,RAM_B
     145/     137 : 21 01 80            	LD	HL,RAM_B+1
     146/     13A :                     RC0:
     147/     13A : 7E                  	LD	A,(HL)
     148/     13B : 47                  	LD	B,A
     149/     13C : 2F                  	CPL
     150/     13D : 77                  	LD	(HL),A
     151/     13E : BE                  	CP	(HL)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 6 - 7/12/2023 13:23:49


     152/     13F : 20 09               	JR	NZ,RC1		; Unwritable
     153/     141 : 1A                  	LD	A,(DE)
     154/     142 : BE                  	CP	(HL)
     155/     143 : 20 0A               	JR	NZ,RC2
     156/     145 : 70                  	LD	(HL),B
     157/     146 : 1A                  	LD	A,(DE)
     158/     147 : BE                  	CP	(HL)
     159/     148 : 20 05               	JR	NZ,RC2
     160/     14A :                     RC1:	
     161/     14A :                     	;; (HL) and (DE) points same memory or (HL) points no memory
     162/     14A : 22 38 FF            	LD	(RAMEND),HL
     163/     14D : 18 09               	JR	RCE
     164/     14F :                     RC2:
     165/     14F : 70                  	LD	(HL),B
     166/     150 : 23                  	INC	HL
     167/     151 : 7C                  	LD	A,H
     168/     152 : B5                  	OR	L
     169/     153 : 20 E5               	JR	NZ,RC0
     170/     155 : 22 38 FF            	LD	(RAMEND),HL
     171/     158 :                     RCE:	
     172/     158 : [142]               	ENDIF
     173/     158 :                     	
     174/     158 :                     	;; CPU identification
     175/     158 : AF                  	XOR	A
     176/     159 : 32 1B FF            	LD	(PSPEC),A
     177/     15C :                     
     178/     15C : =>TRUE              	IF USE_IDENT
     179/     15C : 01 FF 00            	LD	BC,00FFH
     180/     15F : ED 4C               	DB	0EDH,4CH	; MLT BC (HD64180)
     181/     161 : 78                  	LD	A,B
     182/     162 : B1                  	OR	C
     183/     163 : 28 17               	JR	Z,ID_180
     184/     165 : 3E 40               	LD	A,40H
     185/     167 : CB 37               	DB	0CBH,37H	; TEST A (Z280)
     186/     169 : F2 D7 01            	JP	P,ID_280
     187/     16C : 3E 7F               	LD	A,7FH
     188/     16E : ED 4F               	LD	R,A
     189/     170 : ED 5F               	LD	A,R
     190/     172 : FA 00 02            	JP	M,ID_NSC
     191/     175 :                     	;; Z80
     192/     175 : 21 9E 0A            	LD	HL,IM80
     193/     178 : AF                  	XOR	A
     194/     179 : C3 05 02            	JP	IDE
     195/     17C :                     	;; HD64180
     196/     17C :                     	SAVE			; HD64180 specific initialization
     197/     17C :                     	CPU	Z180
     198/     17C :                     ID_180:
     199/     17C : 3E C0               	LD	A,IOBASE
     200/     17E : ED 39 3F            	OUT0	(3FH),A
     201/     181 : 3E 00               	LD	A,DCNTL_V
     202/     183 : ED 39 F2            	OUT0	(IOBASE+32H),A
     203/     186 : 3E 83               	LD	A,RMR_V
     204/     188 : ED 39 F6            	OUT0	(IOBASE+36H),A
     205/     18B : 3E 7F               	LD	A,7FH		; Try to change OMCR bit 7 to 0
     206/     18D : ED 39 FE            	OUT0	(IOBASE+3EH),A
     207/     190 : ED 38 FE            	IN0	A,(IOBASE+3EH)
     208/     193 : E6 80               	AND	80H
     209/     195 : 28 07               	JR	Z,ID_180Z	; HD64180Z detected
     210/     197 :                     
     211/     197 : 21 A4 0A            	LD	HL,IM180
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 7 - 7/12/2023 13:23:49


     212/     19A : 3E 01               	LD	A,01H
     213/     19C : 18 67               	JR	IDE
     214/     19E :                     	;; HD64180Z
     215/     19E :                     ID_180Z:
     216/     19E : 3E 40               	LD	A,OMCR_V
     217/     1A0 : ED 39 FE            	OUT0	(IOBASE+3EH),A
     218/     1A3 : AF                  	XOR	A
     219/     1A4 : ED 39 D2            	OUT0	(IOBASE+12H),A
     220/     1A7 : ED 38 D2            	IN0	A,(IOBASE+12H)
     221/     1AA : E6 40               	AND	40H
     222/     1AC : 28 1D               	JR	Z,ID_Z8S	; Z8S180 (SL1919) detected
     223/     1AE :                     
     224/     1AE : AF                  	XOR	A
     225/     1AF : ED 39 DF            	OUT0	(IOBASE+1FH),A
     226/     1B2 : ED 38 DF            	IN0	A,(IOBASE+1FH)
     227/     1B5 : B7                  	OR	A
     228/     1B6 : 28 07               	JR	Z,ID_1960	; Z8S180 (SL1960) detected
     229/     1B8 :                     	
     230/     1B8 : 21 AF 0A            	LD	HL,IM180Z
     231/     1BB : 3E 02               	LD	A,02H
     232/     1BD : 18 46               	JR	IDE
     233/     1BF :                     	;; Z8S180 (SL1960)
     234/     1BF :                     ID_1960:
     235/     1BF : 3E 00               	LD	A,CCR1_V
     236/     1C1 : ED 39 DF            	OUT0	(IOBASE+1FH),A
     237/     1C4 : 21 BA 0A            	LD	HL,IM1960
     238/     1C7 : 3E 04               	LD	A,04H
     239/     1C9 : 18 3A               	JR	IDE
     240/     1CB :                     	
     241/     1CB :                     	;; Z8S180
     242/     1CB :                     ID_Z8S:
     243/     1CB : 3E 00               	LD	A,CCR1_V
     244/     1CD : ED 39 DF            	OUT0	(IOBASE+1FH),A
     245/     1D0 : 21 CA 0A            	LD	HL,IMZ8S
     246/     1D3 : 3E 05               	LD	A,05H
     247/     1D5 : 18 2E               	JR	IDE
     248/     1D7 :                     
     249/     1D7 : ALL                 	RESTORE
     250/     1D7 :                     	;; Z280
     251/     1D7 :                     ID_280:
     252/     1D7 : 2E 30               	LD	L,BTCR_V	; Z280 specific initialization
     253/     1D9 : 0E 02               	LD	C,02H		; BTCR
     254/     1DB : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     255/     1DD : 2E 40               	LD	L,BTIR_V
     256/     1DF : 0E FF               	LD	C,0FFH		; BTIR
     257/     1E1 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     258/     1E3 : 2E 00               	LD	L,CCR_V
     259/     1E5 : 0E 12               	LD	C,12H		; CCR
     260/     1E7 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     261/     1E9 :                     
     262/     1E9 : 2E FF               	LD	L,0FFH
     263/     1EB : 0E 08               	LD	C,08H		; IOBR
     264/     1ED : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     265/     1EF : 3E 38               	LD	A,RRR_V
     266/     1F1 : D3 E8               	OUT	(0E8H),A	; RRR
     267/     1F3 : 2E 00               	LD	L,00H
     268/     1F5 : 0E 08               	LD	C,08H
     269/     1F7 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     270/     1F9 :                     
     271/     1F9 : 21 D3 0A            	LD	HL,IM280
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 8 - 7/12/2023 13:23:49


     272/     1FC : 3E 08               	LD	A,08H
     273/     1FE : 18 05               	JR	IDE
     274/     200 :                     	;; NSC800
     275/     200 :                     ID_NSC:	
     276/     200 : 21 DA 0A            	LD	HL,IMNSC
     277/     203 : 3E 09               	LD	A,09H
     278/     205 :                     IDE:
     279/     205 : 32 1B FF            	LD	(PSPEC),A
     280/     208 : 22 00 FF            	LD	(INBUF),HL
     281/     20B : [178]               	ENDIF			; USE_IDENT
     282/     20B :                     
     283/     20B : CD 06 0D            	CALL    INIT
     284/     20E :                     
     285/     20E : 21 00 80            	LD	HL,8000H
     286/     211 : 22 10 FF            	LD	(DSADDR),HL
     287/     214 : 22 17 FF            	LD	(SADDR),HL
     288/     217 : 22 15 FF            	LD	(GADDR),HL
     289/     21A : 3E 49               	LD	A,'I'
     290/     21C : 32 19 FF            	LD	(HEXMOD),A
     291/     21F : AF                  	XOR	A
     292/     220 : 32 1D FF            	LD	(IOPAGE),A
     293/     223 :                     
     294/     223 : =>TRUE              	IF USE_REGCMD
     295/     223 :                     
     296/     223 :                     	;; Initialize register value
     297/     223 : AF                  	XOR	A
     298/     224 : 21 1E FF            	LD	HL,REG_B
     299/     227 : 06 1A               	LD	B,REG_E-REG_B
     300/     229 :                     IR0:
     301/     229 : 77                  	LD	(HL),A
     302/     22A : 23                  	INC	HL
     303/     22B : 10 FC               	DJNZ	IR0
     304/     22D :                     
     305/     22D : 21 00 00            	LD	HL,STACK
     306/     230 : 22 32 FF            	LD	(REGSP),HL
     307/     233 :                     
     308/     233 : [294]               	ENDIF
     309/     233 :                     
     310/     233 : 06 64               	LD	B,100
     311/     235 :                     TL:	
     312/     235 : AF                  	XOR	A
     313/     236 : CD 46 0D            	CALL	CONOUT
     314/     239 : 10 FA               	DJNZ	TL
     315/     23B :                     	
     316/     23B :                     	;; Opening message
     317/     23B : 21 3D 0A            	LD	HL,OPNMSG
     318/     23E : CD 4F 08            	CALL	STROUT
     319/     241 :                     
     320/     241 : =>TRUE              	IF USE_IDENT
     321/     241 : 2A 00 FF            	LD	HL,(INBUF)
     322/     244 : CD 4F 08            	CALL	STROUT
     323/     247 : [320]               	ENDIF
     324/     247 :                     
     325/     247 : =>TRUE              	IF USE_RAMCHK
     326/     247 : 21 00 80            	LD	HL,RAM_B
     327/     24A : CD 58 08            	CALL	HEXOUT4
     328/     24D : 3E 2D               	LD	A,'-'
     329/     24F : CD 46 0D            	CALL	CONOUT
     330/     252 : 2A 38 FF            	LD	HL,(RAMEND)
     331/     255 : 2B                  	DEC	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 9 - 7/12/2023 13:23:49


     332/     256 : CD 58 08            	CALL	HEXOUT4
     333/     259 : CD 9B 08            	CALL	CRLF
     334/     25C : [325]               	ENDIF
     335/     25C :                     
     336/     25C :                     WSTART:
     337/     25C : 21 57 0A            	LD	HL,PROMPT
     338/     25F : CD 4F 08            	CALL	STROUT
     339/     262 : CD A5 08            	CALL	GETLIN
     340/     265 : 21 00 FF            	LD	HL,INBUF
     341/     268 : CD F1 08            	CALL	SKIPSP
     342/     26B : CD F8 08            	CALL	UPPER
     343/     26E : B7                  	OR	A
     344/     26F : 28 EB               	JR	Z,WSTART
     345/     271 :                     
     346/     271 : FE 44               	CP	'D'
     347/     273 : 28 30               	JR	Z,DUMP
     348/     275 : FE 47               	CP	'G'
     349/     277 : CA AB 03            	JP	Z,GO
     350/     27A : FE 53               	CP	'S'
     351/     27C : CA 22 04            	JP	Z,SETM
     352/     27F :                     
     353/     27F : FE 4C               	CP	'L'
     354/     281 : CA 89 04            	JP	Z,LOADH
     355/     284 : FE 50               	CP	'P'
     356/     286 : CA 5A 05            	JP	Z,SAVEH
     357/     289 :                     
     358/     289 : FE 49               	CP	'I'
     359/     28B : CA 37 06            	JP	Z,PIN
     360/     28E : FE 4F               	CP	'O'
     361/     290 : CA C9 06            	JP	Z,POUT
     362/     293 : FE 5A               	CP	'Z'
     363/     295 : CA 61 07            	JP	Z,PBANK
     364/     298 :                     
     365/     298 : =>TRUE              	IF USE_REGCMD
     366/     298 : FE 52               	CP	'R'
     367/     29A : CA 8F 07            	JP	Z,REG
     368/     29D : [365]               	ENDIF
     369/     29D :                     
     370/     29D :                     ERR:
     371/     29D : 21 74 0A            	LD	HL,ERRMSG
     372/     2A0 : CD 4F 08            	CALL	STROUT
     373/     2A3 : 18 B7               	JR	WSTART
     374/     2A5 :                     
     375/     2A5 :                     ;;; 
     376/     2A5 :                     ;;; Dump memory
     377/     2A5 :                     ;;; 
     378/     2A5 :                     
     379/     2A5 :                     DUMP:
     380/     2A5 : 23                  	INC	HL
     381/     2A6 : CD F1 08            	CALL	SKIPSP
     382/     2A9 : CD 01 09            	CALL	RDHEX		; 1st arg.
     383/     2AC : 79                  	LD	A,C
     384/     2AD : B7                  	OR	A
     385/     2AE : 20 13               	JR	NZ,DP0
     386/     2B0 :                     	;; No arg.
     387/     2B0 : CD F1 08            	CALL	SKIPSP
     388/     2B3 : 7E                  	LD	A,(HL)
     389/     2B4 : B7                  	OR	A
     390/     2B5 : 20 E6               	JR	NZ,ERR
     391/     2B7 : 2A 10 FF            	LD	HL,(DSADDR)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 10 - 7/12/2023 13:23:49


     392/     2BA : 01 80 00            	LD	BC,128
     393/     2BD : 09                  	ADD	HL,BC
     394/     2BE : 22 12 FF            	LD	(DEADDR),HL
     395/     2C1 : 18 30               	JR	DPM
     396/     2C3 :                     
     397/     2C3 :                     	;; 1st arg. found
     398/     2C3 :                     DP0:
     399/     2C3 : ED 53 10 FF         	LD	(DSADDR),DE
     400/     2C7 : CD F1 08            	CALL	SKIPSP
     401/     2CA : 7E                  	LD	A,(HL)
     402/     2CB : FE 2C               	CP	','
     403/     2CD : 28 0C               	JR	Z,DP1
     404/     2CF : B7                  	OR	A
     405/     2D0 : 20 CB               	JR	NZ,ERR
     406/     2D2 :                     	;; No 2nd arg.
     407/     2D2 : 21 80 00            	LD	HL,128
     408/     2D5 : 19                  	ADD	HL,DE
     409/     2D6 : 22 12 FF            	LD	(DEADDR),HL
     410/     2D9 : 18 18               	JR	DPM
     411/     2DB :                     DP1:
     412/     2DB : 23                  	INC	HL
     413/     2DC : CD F1 08            	CALL	SKIPSP
     414/     2DF : CD 01 09            	CALL	RDHEX
     415/     2E2 : CD F1 08            	CALL	SKIPSP
     416/     2E5 : 79                  	LD	A,C
     417/     2E6 : B7                  	OR	A
     418/     2E7 : 28 B4               	JR	Z,ERR
     419/     2E9 : 7E                  	LD	A,(HL)
     420/     2EA : B7                  	OR	A
     421/     2EB : C2 9D 02            	JP	NZ,ERR
     422/     2EE : 13                  	INC	DE
     423/     2EF : ED 53 12 FF         	LD	(DEADDR),DE
     424/     2F3 :                     DPM:
     425/     2F3 :                     	;; DUMP main
     426/     2F3 : 2A 10 FF            	LD	HL,(DSADDR)
     427/     2F6 : 3E F0               	LD	A,0F0H
     428/     2F8 : A5                  	AND	A,L
     429/     2F9 : 6F                  	LD	L,A
     430/     2FA : AF                  	XOR	A
     431/     2FB : 32 14 FF            	LD	(DSTATE),A
     432/     2FE :                     DPM0:
     433/     2FE : E5                  	PUSH	HL
     434/     2FF : CD 25 03            	CALL	DPL
     435/     302 : E1                  	POP	HL
     436/     303 : 01 10 00            	LD	BC,16
     437/     306 : 09                  	ADD	HL,BC
     438/     307 : CD 41 0D            	CALL	CONST
     439/     30A : 20 10               	JR	NZ,DPM1
     440/     30C : 3A 14 FF            	LD	A,(DSTATE)
     441/     30F : FE 02               	CP	2
     442/     311 : 38 EB               	JR	C,DPM0
     443/     313 : 2A 12 FF            	LD	HL,(DEADDR)
     444/     316 : 22 10 FF            	LD	(DSADDR),HL
     445/     319 : C3 5C 02            	JP	WSTART
     446/     31C :                     DPM1:
     447/     31C : 22 10 FF            	LD	(DSADDR),HL
     448/     31F : CD 38 0D            	CALL	CONIN
     449/     322 : C3 5C 02            	JP	WSTART
     450/     325 :                     
     451/     325 :                     DPL:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 11 - 7/12/2023 13:23:49


     452/     325 :                     	;; DUMP line
     453/     325 : CD 58 08            	CALL	HEXOUT4
     454/     328 : E5                  	PUSH	HL
     455/     329 : 21 7C 0A            	LD	HL,DSEP0
     456/     32C : CD 4F 08            	CALL	STROUT
     457/     32F : E1                  	POP	HL
     458/     330 : DD 21 00 FF         	LD	IX,INBUF
     459/     334 : 06 10               	LD	B,16
     460/     336 :                     DPL0:
     461/     336 : CD 5F 03            	CALL	DPB
     462/     339 : 10 FB               	DJNZ	DPL0
     463/     33B :                     
     464/     33B : 21 7F 0A            	LD	HL,DSEP1
     465/     33E : CD 4F 08            	CALL	STROUT
     466/     341 :                     
     467/     341 : 21 00 FF            	LD	HL,INBUF
     468/     344 : 06 10               	LD	B,16
     469/     346 :                     DPL1:
     470/     346 : 7E                  	LD	A,(HL)
     471/     347 : 23                  	INC	HL
     472/     348 : FE 20               	CP	' '
     473/     34A : 38 09               	JR	C,DPL2
     474/     34C : FE 7F               	CP	7FH
     475/     34E : 30 05               	JR	NC,DPL2
     476/     350 : CD 46 0D            	CALL	CONOUT
     477/     353 : 18 05               	JR	DPL3
     478/     355 :                     DPL2:
     479/     355 : 3E 2E               	LD	A,'.'
     480/     357 : CD 46 0D            	CALL	CONOUT
     481/     35A :                     DPL3:
     482/     35A : 10 EA               	DJNZ	DPL1
     483/     35C : C3 9B 08            	JP	CRLF
     484/     35F :                     
     485/     35F :                     DPB:	; Dump byte
     486/     35F : 3E 20               	LD	A,' '
     487/     361 : CD 46 0D            	CALL	CONOUT
     488/     364 : 3A 14 FF            	LD	A,(DSTATE)
     489/     367 : B7                  	OR	A
     490/     368 : 20 20               	JR	NZ,DPB2
     491/     36A :                     	; Dump state 0
     492/     36A : 3A 10 FF            	LD	A,(DSADDR)	; Low byte
     493/     36D : BD                  	CP	L
     494/     36E : 20 06               	JR	NZ,DPB0
     495/     370 : 3A 11 FF            	LD	A,(DSADDR+1)	; High byte
     496/     373 : BC                  	CP	H
     497/     374 : 28 0F               	JR	Z,DPB1
     498/     376 :                     DPB0:	; Still 0 or 2
     499/     376 : 3E 20               	LD	A,' '
     500/     378 : CD 46 0D            	CALL	CONOUT
     501/     37B : CD 46 0D            	CALL	CONOUT
     502/     37E : DD 77 00            	LD	(IX),A
     503/     381 : 23                  	INC	HL
     504/     382 : DD 23               	INC	IX
     505/     384 : C9                  	RET
     506/     385 :                     DPB1:	; Found start address
     507/     385 : 3E 01               	LD	A,1
     508/     387 : 32 14 FF            	LD	(DSTATE),A
     509/     38A :                     DPB2:
     510/     38A : 3A 14 FF            	LD	A,(DSTATE)
     511/     38D : FE 01               	CP	1
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 12 - 7/12/2023 13:23:49


     512/     38F : 20 E5               	JR	NZ,DPB0
     513/     391 :                     	; Dump state 1
     514/     391 : 7E                  	LD	A,(HL)
     515/     392 : DD 77 00            	LD	(IX),A
     516/     395 : CD 5D 08            	CALL	HEXOUT2
     517/     398 : 23                  	INC	HL
     518/     399 : DD 23               	INC	IX
     519/     39B : 3A 12 FF            	LD	A,(DEADDR)	; Low byte
     520/     39E : BD                  	CP	L
     521/     39F : C0                  	RET	NZ
     522/     3A0 : 3A 13 FF            	LD	A,(DEADDR+1)	; High byte
     523/     3A3 : BC                  	CP	H
     524/     3A4 : C0                  	RET	NZ
     525/     3A5 :                     	; Found end address
     526/     3A5 : 3E 02               	LD	A,2
     527/     3A7 : 32 14 FF            	LD	(DSTATE),A
     528/     3AA : C9                  	RET
     529/     3AB :                     
     530/     3AB :                     ;;;
     531/     3AB :                     ;;; GO address
     532/     3AB :                     ;;; 
     533/     3AB :                     
     534/     3AB :                     GO:
     535/     3AB : 23                  	INC	HL
     536/     3AC : CD F1 08            	CALL	SKIPSP
     537/     3AF : CD 01 09            	CALL	RDHEX
     538/     3B2 : 7E                  	LD	A,(HL)
     539/     3B3 : B7                  	OR	A
     540/     3B4 : C2 9D 02            	JP	NZ,ERR
     541/     3B7 : 79                  	LD	A,C
     542/     3B8 : B7                  	OR	A
     543/     3B9 : 28 04               	JR	Z,G0
     544/     3BB :                     
     545/     3BB : =>TRUE              	IF USE_REGCMD
     546/     3BB :                     
     547/     3BB : ED 53 34 FF         	LD	(REGPC),DE
     548/     3BF :                     G0:
     549/     3BF :                     	;; R register adjustment
     550/     3BF : =>TRUE              	IF USE_IDENT
     551/     3BF : 3A 1B FF            	LD	A,(PSPEC)
     552/     3C2 : FE 08               	CP	08H		; Z280
     553/     3C4 : 28 1F               	JR	Z,G1
     554/     3C6 : FE 09               	CP	09H		; NSC800
     555/     3C8 : 28 13               	JR	Z,G01
     556/     3CA : 3A 37 FF            	LD	A,(REGR)
     557/     3CD : D6 02               	SUB	02H
     558/     3CF : E6 7F               	AND	7FH
     559/     3D1 : 47                  	LD	B,A
     560/     3D2 : 3A 37 FF            	LD	A,(REGR)
     561/     3D5 : E6 80               	AND	80H
     562/     3D7 : B0                  	OR	B
     563/     3D8 : 32 37 FF            	LD	(REGR),A
     564/     3DB : 18 08               	JR	G1
     565/     3DD :                     G01:
     566/     3DD : 3A 37 FF            	LD	A,(REGR)
     567/     3E0 : D6 02               	SUB	02H
     568/     3E2 : 32 37 FF            	LD	(REGR),A
     569/     3E5 :                     G1:
     570/     3E5 : [550]               	ENDIF
     571/     3E5 :                     	
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 13 - 7/12/2023 13:23:49


     572/     3E5 : 2A 32 FF            	LD	HL,(REGSP)
     573/     3E8 : F9                  	LD	SP,HL
     574/     3E9 : 2A 34 FF            	LD	HL,(REGPC)
     575/     3EC : E5                  	PUSH	HL
     576/     3ED : DD 2A 2E FF         	LD	IX,(REGIX)
     577/     3F1 : FD 2A 30 FF         	LD	IY,(REGIY)
     578/     3F5 : 2A 26 FF            	LD	HL,(REGAFX)
     579/     3F8 : E5                  	PUSH	HL
     580/     3F9 : ED 4B 28 FF         	LD	BC,(REGBCX)
     581/     3FD : ED 5B 2A FF         	LD	DE,(REGDEX)
     582/     401 : 2A 2C FF            	LD	HL,(REGHLX)
     583/     404 : D9                  	EXX
     584/     405 : F1                  	POP	AF
     585/     406 : 08                  	EX	AF,AF'
     586/     407 : 2A 1E FF            	LD	HL,(REGAF)
     587/     40A : E5                  	PUSH	HL
     588/     40B : ED 4B 20 FF         	LD	BC,(REGBC)
     589/     40F : ED 5B 22 FF         	LD	DE,(REGDE)
     590/     413 : 2A 24 FF            	LD	HL,(REGHL)
     591/     416 : 3A 36 FF            	LD	A,(REGI)
     592/     419 : ED 47               	LD	I,A
     593/     41B : 3A 37 FF            	LD	A,(REGR)
     594/     41E : ED 4F               	LD	R,A
     595/     420 : F1                  	POP	AF
     596/     421 : C9                  	RET			; POP PC
     597/     422 :                     
     598/     422 : =>FALSE             	ELSE
     599/     422 :                     	
     600/     422 :                     	LD	(GADDR),DE
     601/     422 :                     G0:
     602/     422 :                     	LD	HL,(GADDR)
     603/     422 :                     	JP	(HL)
     604/     422 :                     
     605/     422 : [545]               	ENDIF
     606/     422 :                     
     607/     422 :                     ;;;
     608/     422 :                     ;;; SET memory
     609/     422 :                     ;;; 
     610/     422 :                     
     611/     422 :                     SETM:
     612/     422 : 23                  	INC	HL
     613/     423 : CD F1 08            	CALL	SKIPSP
     614/     426 : CD 01 09            	CALL	RDHEX
     615/     429 : CD F1 08            	CALL	SKIPSP
     616/     42C : 7E                  	LD	A,(HL)
     617/     42D : B7                  	OR	A
     618/     42E : C2 9D 02            	JP	NZ,ERR
     619/     431 : 79                  	LD	A,C
     620/     432 : B7                  	OR	A
     621/     433 : 20 04               	JR	NZ,SM0
     622/     435 : ED 5B 17 FF         	LD	DE,(SADDR)
     623/     439 :                     SM0:
     624/     439 : EB                  	EX	DE,HL
     625/     43A :                     SM1:
     626/     43A : CD 58 08            	CALL	HEXOUT4
     627/     43D : E5                  	PUSH	HL
     628/     43E : 21 7F 0A            	LD	HL,DSEP1
     629/     441 : CD 4F 08            	CALL	STROUT
     630/     444 : E1                  	POP	HL
     631/     445 : 7E                  	LD	A,(HL)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 14 - 7/12/2023 13:23:49


     632/     446 : E5                  	PUSH	HL
     633/     447 : CD 5D 08            	CALL	HEXOUT2
     634/     44A : 3E 20               	LD	A,' '
     635/     44C : CD 46 0D            	CALL	CONOUT
     636/     44F : CD A5 08            	CALL	GETLIN
     637/     452 : 21 00 FF            	LD	HL,INBUF
     638/     455 : CD F1 08            	CALL	SKIPSP
     639/     458 : 7E                  	LD	A,(HL)
     640/     459 : B7                  	OR	A
     641/     45A : 20 07               	JR	NZ,SM2
     642/     45C :                     	;; Empty  (Increment address)
     643/     45C : E1                  	POP	HL
     644/     45D : 23                  	INC	HL
     645/     45E : 22 17 FF            	LD	(SADDR),HL
     646/     461 : 18 D7               	JR	SM1
     647/     463 :                     SM2:
     648/     463 : FE 2D               	CP	'-'
     649/     465 : 20 07               	JR	NZ,SM3
     650/     467 :                     	;; '-'  (Decrement address)
     651/     467 : E1                  	POP	HL
     652/     468 : 2B                  	DEC	HL
     653/     469 : 22 17 FF            	LD	(SADDR),HL
     654/     46C : 18 CC               	JR	SM1
     655/     46E :                     SM3:
     656/     46E : FE 2E               	CP	'.'
     657/     470 : 20 07               	JR	NZ,SM4
     658/     472 : E1                  	POP	HL
     659/     473 : 22 17 FF            	LD	(SADDR),HL
     660/     476 : C3 5C 02            	JP	WSTART
     661/     479 :                     SM4:
     662/     479 : CD 01 09            	CALL	RDHEX
     663/     47C : 79                  	LD	A,C
     664/     47D : B7                  	OR	A
     665/     47E : E1                  	POP	HL
     666/     47F : CA 9D 02            	JP	Z,ERR
     667/     482 : 73                  	LD	(HL),E
     668/     483 : 23                  	INC	HL
     669/     484 : 22 17 FF            	LD	(SADDR),HL
     670/     487 : 18 B1               	JR	SM1
     671/     489 :                     
     672/     489 :                     ;;;
     673/     489 :                     ;;; LOAD HEX file
     674/     489 :                     ;;;
     675/     489 :                     
     676/     489 :                     LOADH:
     677/     489 : 23                  	INC	HL
     678/     48A : CD F1 08            	CALL	SKIPSP
     679/     48D : CD 01 09            	CALL	RDHEX
     680/     490 : CD F1 08            	CALL	SKIPSP
     681/     493 : 7E                  	LD	A,(HL)
     682/     494 : B7                  	OR	A
     683/     495 : C2 9D 02            	JP	NZ,ERR
     684/     498 :                     
     685/     498 : 79                  	LD	A,C
     686/     499 : B7                  	OR	A
     687/     49A : 20 03               	JR	NZ,LH0
     688/     49C :                     
     689/     49C : 11 00 00            	LD	DE,0		;Offset
     690/     49F :                     LH0:
     691/     49F : CD 38 0D            	CALL	CONIN
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 15 - 7/12/2023 13:23:49


     692/     4A2 : CD F8 08            	CALL	UPPER
     693/     4A5 : FE 53               	CP	'S'
     694/     4A7 : 28 5C               	JR	Z,LHS0
     695/     4A9 :                     LH1:
     696/     4A9 : FE 3A               	CP	':'
     697/     4AB : 28 0D               	JR	Z,LHI0
     698/     4AD :                     LH2:
     699/     4AD :                     	;; Skip to EOL
     700/     4AD : FE 0D               	CP	CR
     701/     4AF : 28 EE               	JR	Z,LH0
     702/     4B1 : FE 0A               	CP	LF
     703/     4B3 : 28 EA               	JR	Z,LH0
     704/     4B5 :                     LH3:
     705/     4B5 : CD 38 0D            	CALL	CONIN
     706/     4B8 : 18 F3               	JR	LH2
     707/     4BA :                     
     708/     4BA :                     LHI0:
     709/     4BA : CD 74 08            	CALL	HEXIN
     710/     4BD : 4F                  	LD	C,A		; Checksum
     711/     4BE : 47                  	LD	B,A		; Length
     712/     4BF :                     
     713/     4BF : CD 74 08            	CALL	HEXIN
     714/     4C2 : 67                  	LD	H,A		; Address H
     715/     4C3 : 81                  	ADD	A,C
     716/     4C4 : 4F                  	LD	C,A
     717/     4C5 :                     
     718/     4C5 : CD 74 08            	CALL	HEXIN
     719/     4C8 : 6F                  	LD	L,A		; Address L
     720/     4C9 : 81                  	ADD	A,C
     721/     4CA : 4F                  	LD	C,A
     722/     4CB :                     
     723/     4CB :                     	;; Add offset
     724/     4CB : 19                  	ADD	HL,DE
     725/     4CC :                     
     726/     4CC : CD 74 08            	CALL	HEXIN
     727/     4CF : 32 1A FF            	LD	(RECTYP),A
     728/     4D2 : 81                  	ADD	A,C
     729/     4D3 : 4F                  	LD	C,A		; Checksum
     730/     4D4 :                     
     731/     4D4 : 78                  	LD	A,B
     732/     4D5 : B7                  	OR	A
     733/     4D6 : 28 14               	JR	Z,LHI3
     734/     4D8 :                     LHI1:
     735/     4D8 : CD 74 08            	CALL	HEXIN
     736/     4DB : F5                  	PUSH	AF
     737/     4DC : 81                  	ADD	A,C
     738/     4DD : 4F                  	LD	C,A		; Checksum
     739/     4DE :                     
     740/     4DE : 3A 1A FF            	LD	A,(RECTYP)
     741/     4E1 : B7                  	OR	A
     742/     4E2 : 20 05               	JR	NZ,LHI20
     743/     4E4 :                     
     744/     4E4 : F1                  	POP	AF
     745/     4E5 : 77                  	LD	(HL),A
     746/     4E6 : 23                  	INC	HL
     747/     4E7 : 18 01               	JR	LHI2
     748/     4E9 :                     LHI20:
     749/     4E9 : F1                  	POP	AF
     750/     4EA :                     LHI2:
     751/     4EA : 10 EC               	DJNZ	LHI1
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 16 - 7/12/2023 13:23:49


     752/     4EC :                     LHI3:
     753/     4EC : CD 74 08            	CALL	HEXIN
     754/     4EF : 81                  	ADD	A,C
     755/     4F0 : 20 0A               	JR	NZ,LHIE		; Checksum error
     756/     4F2 : 3A 1A FF            	LD	A,(RECTYP)
     757/     4F5 : B7                  	OR	A
     758/     4F6 : CA B5 04            	JP	Z,LH3
     759/     4F9 : C3 5C 02            	JP	WSTART
     760/     4FC :                     LHIE:
     761/     4FC : 21 5A 0A            	LD	HL,IHEMSG
     762/     4FF : CD 4F 08            	CALL	STROUT
     763/     502 : C3 5C 02            	JP	WSTART
     764/     505 :                     	
     765/     505 :                     LHS0:
     766/     505 : CD 38 0D            	CALL	CONIN
     767/     508 : 32 1A FF            	LD	(RECTYP),A
     768/     50B :                     
     769/     50B : CD 74 08            	CALL	HEXIN
     770/     50E : 47                  	LD	B,A		; Length+3
     771/     50F : 4F                  	LD	C,A		; Checksum
     772/     510 :                     
     773/     510 : CD 74 08            	CALL	HEXIN
     774/     513 : 67                  	LD	H,A
     775/     514 : 81                  	ADD	A,C
     776/     515 : 4F                  	LD	C,A
     777/     516 :                     	
     778/     516 : CD 74 08            	CALL	HEXIN
     779/     519 : 6F                  	LD	L,A
     780/     51A : 81                  	ADD	A,C
     781/     51B : 4F                  	LD	C,A
     782/     51C :                     
     783/     51C : 19                  	ADD	HL,DE
     784/     51D :                     
     785/     51D : 05                  	DEC	B
     786/     51E : 05                  	DEC	B
     787/     51F : 05                  	DEC	B
     788/     520 : 28 15               	JR	Z,LHS3
     789/     522 :                     LHS1:
     790/     522 : CD 74 08            	CALL	HEXIN
     791/     525 : F5                  	PUSH	AF
     792/     526 : 81                  	ADD	A,C
     793/     527 : 4F                  	LD	C,A		; Checksum
     794/     528 :                     
     795/     528 : 3A 1A FF            	LD	A,(RECTYP)
     796/     52B : FE 31               	CP	'1'
     797/     52D : 20 05               	JR	NZ,LHS2
     798/     52F :                     
     799/     52F : F1                  	POP	AF
     800/     530 : 77                  	LD	(HL),A
     801/     531 : 23                  	INC	HL
     802/     532 : 18 01               	JR	LHS20
     803/     534 :                     LHS2:
     804/     534 : F1                  	POP	AF
     805/     535 :                     LHS20:
     806/     535 : 10 EB               	DJNZ	LHS1
     807/     537 :                     LHS3:
     808/     537 : CD 74 08            	CALL	HEXIN
     809/     53A : 81                  	ADD	A,C
     810/     53B : FE FF               	CP	0FFH
     811/     53D : 20 12               	JR	NZ,LHSE
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 17 - 7/12/2023 13:23:49


     812/     53F :                     
     813/     53F : 3A 1A FF            	LD	A,(RECTYP)
     814/     542 : FE 37               	CP	'7'
     815/     544 : 28 11               	JR	Z,LHSR
     816/     546 : FE 38               	CP	'8'
     817/     548 : 28 0D               	JR	Z,LHSR
     818/     54A : FE 39               	CP	'9'
     819/     54C : 28 09               	JR	Z,LHSR
     820/     54E : C3 B5 04            	JP	LH3
     821/     551 :                     LHSE:
     822/     551 : 21 67 0A            	LD	HL,SHEMSG
     823/     554 : CD 4F 08            	CALL	STROUT
     824/     557 :                     LHSR:
     825/     557 : C3 5C 02            	JP	WSTART
     826/     55A :                     	
     827/     55A :                     ;;;
     828/     55A :                     ;;; SAVE HEX file
     829/     55A :                     ;;;
     830/     55A :                     
     831/     55A :                     SAVEH:
     832/     55A : 23                  	INC	HL
     833/     55B : 7E                  	LD	A,(HL)
     834/     55C : CD F8 08            	CALL	UPPER
     835/     55F : FE 49               	CP	'I'
     836/     561 : 28 04               	JR	Z,SH0
     837/     563 : FE 53               	CP	'S'
     838/     565 : 20 04               	JR	NZ,SH1
     839/     567 :                     SH0:
     840/     567 : 23                  	INC	HL
     841/     568 : 32 19 FF            	LD	(HEXMOD),A
     842/     56B :                     SH1:
     843/     56B : CD F1 08            	CALL	SKIPSP
     844/     56E : CD 01 09            	CALL	RDHEX
     845/     571 : 79                  	LD	A,C
     846/     572 : B7                  	OR	A
     847/     573 : 28 1D               	JR	Z,SHE
     848/     575 : D5                  	PUSH	DE
     849/     576 : DD E1               	POP	IX		; IX = Start address
     850/     578 : CD F1 08            	CALL	SKIPSP
     851/     57B : 7E                  	LD	A,(HL)
     852/     57C : FE 2C               	CP	','
     853/     57E : 20 12               	JR	NZ,SHE
     854/     580 : 23                  	INC	HL
     855/     581 : CD F1 08            	CALL	SKIPSP
     856/     584 : CD 01 09            	CALL	RDHEX		; DE = End address
     857/     587 : 79                  	LD	A,C
     858/     588 : B7                  	OR	A
     859/     589 : 28 07               	JR	Z,SHE
     860/     58B : CD F1 08            	CALL	SKIPSP
     861/     58E : 7E                  	LD	A,(HL)
     862/     58F : B7                  	OR	A
     863/     590 : 28 03               	JR	Z,SH2
     864/     592 :                     SHE:
     865/     592 : C3 9D 02            	JP	ERR
     866/     595 :                     
     867/     595 :                     SH2:
     868/     595 : DD E5               	PUSH	IX
     869/     597 : E1                  	POP	HL
     870/     598 : EB                  	EX	DE,HL
     871/     599 : 23                  	INC	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 18 - 7/12/2023 13:23:49


     872/     59A : B7                  	OR	A
     873/     59B : ED 52               	SBC	HL,DE		; HL = Length
     874/     59D :                     SH3:
     875/     59D : CD BD 05            	CALL	SHL
     876/     5A0 : 7C                  	LD	A,H
     877/     5A1 : B5                  	OR	L
     878/     5A2 : 20 F9               	JR	NZ,SH3
     879/     5A4 :                     
     880/     5A4 : 3A 19 FF            	LD	A,(HEXMOD)
     881/     5A7 : FE 49               	CP	'I'
     882/     5A9 : 20 09               	JR	NZ,SH4
     883/     5AB :                     	;; End record for Intel HEX
     884/     5AB : 21 83 0A            	LD	HL,IHEXER
     885/     5AE : CD 4F 08            	CALL	STROUT
     886/     5B1 : C3 5C 02            	JP	WSTART
     887/     5B4 :                     SH4:
     888/     5B4 :                     	;; End record for Motorola S record
     889/     5B4 : 21 91 0A            	LD	HL,SRECER
     890/     5B7 : CD 4F 08            	CALL	STROUT
     891/     5BA : C3 5C 02            	JP	WSTART
     892/     5BD :                     
     893/     5BD :                     SHL:
     894/     5BD : 0E 10               	LD	C,16
     895/     5BF : 7C                  	LD	A,H
     896/     5C0 : B7                  	OR	A
     897/     5C1 : 20 05               	JR	NZ,SHL0
     898/     5C3 : 7D                  	LD	A,L
     899/     5C4 : B9                  	CP	C
     900/     5C5 : 30 01               	JR	NC,SHL0
     901/     5C7 : 4F                  	LD	C,A
     902/     5C8 :                     SHL0:
     903/     5C8 : 06 00               	LD	B,0
     904/     5CA : B7                  	OR	A
     905/     5CB : ED 42               	SBC	HL,BC
     906/     5CD : 41                  	LD	B,C
     907/     5CE :                     
     908/     5CE : 3A 19 FF            	LD	A,(HEXMOD)
     909/     5D1 : FE 49               	CP	'I'
     910/     5D3 : 20 30               	JR	NZ,SHLS
     911/     5D5 :                     
     912/     5D5 :                     	;; Intel HEX
     913/     5D5 : 3E 3A               	LD	A,':'
     914/     5D7 : CD 46 0D            	CALL	CONOUT
     915/     5DA :                     
     916/     5DA : 78                  	LD	A,B
     917/     5DB : CD 5D 08            	CALL	HEXOUT2		; Length
     918/     5DE : 48                  	LD	C,B		; Checksum
     919/     5DF :                     
     920/     5DF : 7A                  	LD	A,D
     921/     5E0 : CD 5D 08            	CALL	HEXOUT2
     922/     5E3 : 7A                  	LD	A,D
     923/     5E4 : 81                  	ADD	A,C
     924/     5E5 : 4F                  	LD	C,A
     925/     5E6 :                     	
     926/     5E6 : 7B                  	LD	A,E
     927/     5E7 : CD 5D 08            	CALL	HEXOUT2
     928/     5EA : 7B                  	LD	A,E
     929/     5EB : 81                  	ADD	A,C
     930/     5EC : 4F                  	LD	C,A
     931/     5ED :                     	
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 19 - 7/12/2023 13:23:49


     932/     5ED : AF                  	XOR	A
     933/     5EE : CD 5D 08            	CALL	HEXOUT2
     934/     5F1 :                     SHLI0:
     935/     5F1 : 1A                  	LD	A,(DE)
     936/     5F2 : F5                  	PUSH	AF
     937/     5F3 : CD 5D 08            	CALL	HEXOUT2
     938/     5F6 : F1                  	POP	AF
     939/     5F7 : 81                  	ADD	A,C
     940/     5F8 : 4F                  	LD	C,A
     941/     5F9 :                     
     942/     5F9 : 13                  	INC	DE
     943/     5FA : 10 F5               	DJNZ	SHLI0
     944/     5FC :                     
     945/     5FC : 79                  	LD	A,C
     946/     5FD : ED 44               	NEG	A
     947/     5FF : CD 5D 08            	CALL	HEXOUT2
     948/     602 : C3 9B 08            	JP	CRLF
     949/     605 :                     
     950/     605 :                     SHLS:
     951/     605 :                     	;; Motorola S record
     952/     605 : 3E 53               	LD	A,'S'
     953/     607 : CD 46 0D            	CALL	CONOUT
     954/     60A : 3E 31               	LD	A,'1'
     955/     60C : CD 46 0D            	CALL	CONOUT
     956/     60F :                     
     957/     60F : 78                  	LD	A,B
     958/     610 : C6 03               	ADD	A,2+1		; DataLength + 2(Addr) + 1(Sum)
     959/     612 : 4F                  	LD	C,A
     960/     613 : CD 5D 08            	CALL	HEXOUT2
     961/     616 :                     
     962/     616 : 7A                  	LD	A,D
     963/     617 : CD 5D 08            	CALL	HEXOUT2
     964/     61A : 7A                  	LD	A,D
     965/     61B : 81                  	ADD	A,C
     966/     61C : 4F                  	LD	C,A
     967/     61D :                     	
     968/     61D : 7B                  	LD	A,E
     969/     61E : CD 5D 08            	CALL	HEXOUT2
     970/     621 : 7B                  	LD	A,E
     971/     622 : 81                  	ADD	A,C
     972/     623 : 4F                  	LD	C,A
     973/     624 :                     SHLS0:
     974/     624 : 1A                  	LD	A,(DE)
     975/     625 : F5                  	PUSH	AF
     976/     626 : CD 5D 08            	CALL	HEXOUT2		; Data
     977/     629 : F1                  	POP	AF
     978/     62A : 81                  	ADD	A,C
     979/     62B : 4F                  	LD	C,A
     980/     62C :                     
     981/     62C : 13                  	INC	DE
     982/     62D : 10 F5               	DJNZ	SHLS0
     983/     62F :                     
     984/     62F : 79                  	LD	A,C
     985/     630 : 2F                  	CPL
     986/     631 : CD 5D 08            	CALL	HEXOUT2
     987/     634 : C3 9B 08            	JP	CRLF
     988/     637 :                     
     989/     637 :                     ;;;
     990/     637 :                     ;;; Port in
     991/     637 :                     ;;; 
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 20 - 7/12/2023 13:23:49


     992/     637 :                     
     993/     637 :                     PIN:
     994/     637 : 23                  	INC	HL
     995/     638 : AF                  	XOR	A
     996/     639 : 32 1C FF            	LD	(SIZE),A
     997/     63C : 3A 1B FF            	LD	A,(PSPEC)
     998/     63F : FE 08               	CP	08H		; Z280
     999/     641 : 20 10               	JR	NZ,PI1
    1000/     643 : 7E                  	LD	A,(HL)
    1001/     644 : CD F8 08            	CALL	UPPER
    1002/     647 : FE 57               	CP	'W'
    1003/     649 : 28 04               	JR	Z,PI0
    1004/     64B : FE 53               	CP	'S'
    1005/     64D : 20 04               	JR	NZ,PI1
    1006/     64F :                     PI0:
    1007/     64F : 23                  	INC	HL
    1008/     650 : 32 1C FF            	LD	(SIZE),A
    1009/     653 :                     PI1:
    1010/     653 : CD F1 08            	CALL	SKIPSP
    1011/     656 : CD 01 09            	CALL	RDHEX
    1012/     659 : 79                  	LD	A,C
    1013/     65A : B7                  	OR	A
    1014/     65B : CA 9D 02            	JP	Z,ERR		; Port no. missing
    1015/     65E : CD F1 08            	CALL	SKIPSP
    1016/     661 : 7E                  	LD	A,(HL)
    1017/     662 : B7                  	OR	A
    1018/     663 : C2 9D 02            	JP	NZ,ERR
    1019/     666 :                     
    1020/     666 : 42                  	LD	B,D
    1021/     667 : 4B                  	LD	C,E
    1022/     668 :                     
    1023/     668 : 3A 1C FF            	LD	A,(SIZE)
    1024/     66B : FE 57               	CP	'W'
    1025/     66D : 28 32               	JR	Z,PIW
    1026/     66F : FE 53               	CP	'S'
    1027/     671 : 28 4B               	JR	Z,PIS
    1028/     673 : 3A 1B FF            	LD	A,(PSPEC)
    1029/     676 : FE 08               	CP	08H		; Z280
    1030/     678 : 28 0B               	JR	Z,PIB
    1031/     67A :                     	;; Byte
    1032/     67A : ED 78               	IN	A,(C)
    1033/     67C : CD 5D 08            	CALL	HEXOUT2
    1034/     67F : CD 9B 08            	CALL	CRLF
    1035/     682 : C3 5C 02            	JP	WSTART
    1036/     685 :                     	;; Byte (Z280 only)
    1037/     685 :                     PIB:
    1038/     685 : 0E 08               	LD	C,08		; I/O Bank register
    1039/     687 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1040/     689 : E5                  	PUSH	HL
    1041/     68A : 3A 1D FF            	LD	A,(IOPAGE)
    1042/     68D : 6F                  	LD	L,A
    1043/     68E : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1044/     690 : 4B                  	LD	C,E
    1045/     691 : ED 78               	IN	A,(C)
    1046/     693 : 0E 08               	LD	C,08H		; I/O Bank register
    1047/     695 : E1                  	POP	HL
    1048/     696 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1049/     698 : CD 5D 08            	CALL	HEXOUT2
    1050/     69B : CD 9B 08            	CALL	CRLF
    1051/     69E : C3 5C 02            	JP	WSTART
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 21 - 7/12/2023 13:23:49


    1052/     6A1 :                     	;; Word (Z280 only)
    1053/     6A1 :                     PIW:
    1054/     6A1 : 0E 08               	LD	C,08		; I/O Bank register
    1055/     6A3 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1056/     6A5 : E5                  	PUSH	HL
    1057/     6A6 : 3A 1D FF            	LD	A,(IOPAGE)
    1058/     6A9 : 6F                  	LD	L,A
    1059/     6AA : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1060/     6AC : 4B                  	LD	C,E
    1061/     6AD : ED B7               	DB	0EDH,0B7H	; IN HL,(C)
    1062/     6AF : E3                  	EX	(SP),HL
    1063/     6B0 : 0E 08               	LD	C,08H
    1064/     6B2 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1065/     6B4 : E1                  	POP	HL
    1066/     6B5 : CD 58 08            	CALL	HEXOUT4
    1067/     6B8 : CD 9B 08            	CALL	CRLF
    1068/     6BB : C3 5C 02            	JP	WSTART
    1069/     6BE :                     	;; Status (Z280 only)
    1070/     6BE :                     PIS:
    1071/     6BE : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1072/     6C0 : CD 58 08            	CALL	HEXOUT4
    1073/     6C3 : CD 9B 08            	CALL	CRLF
    1074/     6C6 : C3 5C 02            	JP	WSTART
    1075/     6C9 :                     
    1076/     6C9 :                     ;;;
    1077/     6C9 :                     ;;; Port out
    1078/     6C9 :                     ;;;
    1079/     6C9 :                     
    1080/     6C9 :                     POUT:
    1081/     6C9 : 23                  	INC	HL
    1082/     6CA : AF                  	XOR	A
    1083/     6CB : 32 1C FF            	LD	(SIZE),A
    1084/     6CE : 3A 1B FF            	LD	A,(PSPEC)
    1085/     6D1 : FE 08               	CP	08H		; Z280
    1086/     6D3 : 20 10               	JR	NZ,PO1
    1087/     6D5 : 7E                  	LD	A,(HL)
    1088/     6D6 : CD F8 08            	CALL	UPPER
    1089/     6D9 : FE 57               	CP	'W'
    1090/     6DB : 28 04               	JR	Z,PO0
    1091/     6DD : FE 53               	CP	'S'
    1092/     6DF : 20 04               	JR	NZ,PO1
    1093/     6E1 :                     PO0:
    1094/     6E1 : 23                  	INC	HL
    1095/     6E2 : 32 1C FF            	LD	(SIZE),A
    1096/     6E5 :                     PO1:
    1097/     6E5 : CD F1 08            	CALL	SKIPSP
    1098/     6E8 : CD 01 09            	CALL	RDHEX
    1099/     6EB : 79                  	LD	A,C
    1100/     6EC : B7                  	OR	A
    1101/     6ED : CA 9D 02            	JP	Z,ERR		; Port no. missing
    1102/     6F0 : D5                  	PUSH	DE
    1103/     6F1 : DD E1               	POP	IX
    1104/     6F3 : CD F1 08            	CALL	SKIPSP
    1105/     6F6 : 7E                  	LD	A,(HL)
    1106/     6F7 : FE 2C               	CP	','
    1107/     6F9 : C2 9D 02            	JP	NZ,ERR
    1108/     6FC : 23                  	INC	HL
    1109/     6FD : CD F1 08            	CALL	SKIPSP
    1110/     700 : CD 01 09            	CALL	RDHEX
    1111/     703 : 79                  	LD	A,C
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 22 - 7/12/2023 13:23:49


    1112/     704 : B7                  	OR	A
    1113/     705 : CA 9D 02            	JP	Z,ERR		; Data missing
    1114/     708 : CD F1 08            	CALL	SKIPSP
    1115/     70B : 7E                  	LD	A,(HL)
    1116/     70C : B7                  	OR	A
    1117/     70D : C2 9D 02            	JP	NZ,ERR
    1118/     710 :                     
    1119/     710 : DD E5               	PUSH	IX
    1120/     712 : C1                  	POP	BC
    1121/     713 :                     
    1122/     713 : 3A 1C FF            	LD	A,(SIZE)
    1123/     716 : FE 57               	CP	'W'
    1124/     718 : 28 27               	JR	Z,POW
    1125/     71A : FE 53               	CP	'S'
    1126/     71C : 28 3D               	JR	Z,POS
    1127/     71E : 3A 1B FF            	LD	A,(PSPEC)
    1128/     721 : FE 08               	CP	08H		; Z280
    1129/     723 : 28 05               	JR	Z,POB
    1130/     725 :                     	;; Byte
    1131/     725 : ED 59               	OUT	(C),E
    1132/     727 : C3 5C 02            	JP	WSTART
    1133/     72A :                     	;; Byte (Z280 only)
    1134/     72A :                     POB:
    1135/     72A : C5                  	PUSH	BC
    1136/     72B : 0E 08               	LD	C,08		; I/O Bank register
    1137/     72D : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1138/     72F : 55                  	LD	D,L
    1139/     730 : 3A 1D FF            	LD	A,(IOPAGE)
    1140/     733 : 6F                  	LD	L,A
    1141/     734 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1142/     736 : C1                  	POP	BC
    1143/     737 : ED 59               	OUT	(C),E
    1144/     739 : 0E 08               	LD	C,08H		; I/O Bank register
    1145/     73B : 6A                  	LD	L,D
    1146/     73C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1147/     73E : C3 5C 02            	JP	WSTART	
    1148/     741 :                     	;; Word (Z280 only)
    1149/     741 :                     POW:
    1150/     741 : DD 69               	DB	0DDH,69H	; LD IXL,C
    1151/     743 : 0E 08               	LD	C,08		; I/O Bank register
    1152/     745 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1153/     747 : E5                  	PUSH	HL
    1154/     748 : 3A 1D FF            	LD	A,(IOPAGE)
    1155/     74B : 6F                  	LD	L,A
    1156/     74C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1157/     74E : DD 4D               	DB	0DDH,4DH	; LD C,IXL
    1158/     750 : EB                  	EX	DE,HL
    1159/     751 : ED BF               	DB	0EDH,0BFH	; OUT (C),HL
    1160/     753 : 0E 08               	LD	C,08H		; I/O Bank register
    1161/     755 : E1                  	POP	HL
    1162/     756 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1163/     758 : C3 5C 02            	JP	WSTART
    1164/     75B :                     	;; Control (Z280 only)
    1165/     75B :                     POS:
    1166/     75B : EB                  	EX	DE,HL
    1167/     75C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1168/     75E : C3 5C 02            	JP	WSTART
    1169/     761 :                     
    1170/     761 :                     ;;;
    1171/     761 :                     ;;; I/O Bank
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 23 - 7/12/2023 13:23:49


    1172/     761 :                     ;;;
    1173/     761 :                     
    1174/     761 :                     PBANK:
    1175/     761 : 3A 1B FF            	LD	A,(PSPEC)
    1176/     764 : FE 08               	CP	08H		; Z280
    1177/     766 : C2 9D 02            	JP	NZ,ERR
    1178/     769 : 23                  	INC	HL
    1179/     76A : CD F1 08            	CALL	SKIPSP
    1180/     76D : CD 01 09            	CALL	RDHEX
    1181/     770 : CD F1 08            	CALL	SKIPSP
    1182/     773 : 7E                  	LD	A,(HL)
    1183/     774 : B7                  	OR	A
    1184/     775 : C2 9D 02            	JP	NZ,ERR
    1185/     778 : 79                  	LD	A,C
    1186/     779 : B7                  	OR	A
    1187/     77A : 28 07               	JR	Z,PB0
    1188/     77C : 7B                  	LD	A,E
    1189/     77D : 32 1D FF            	LD	(IOPAGE),A
    1190/     780 : C3 5C 02            	JP	WSTART
    1191/     783 :                     PB0:
    1192/     783 : 3A 1D FF            	LD	A,(IOPAGE)
    1193/     786 : CD 5D 08            	CALL	HEXOUT2
    1194/     789 : CD 9B 08            	CALL	CRLF
    1195/     78C : C3 5C 02            	JP	WSTART
    1196/     78F :                     
    1197/     78F :                     ;;;
    1198/     78F :                     ;;; Register
    1199/     78F :                     ;;;
    1200/     78F :                     
    1201/     78F : =>TRUE              	IF USE_REGCMD
    1202/     78F :                     
    1203/     78F :                     REG:
    1204/     78F : 23                  	INC	HL
    1205/     790 : CD F1 08            	CALL	SKIPSP
    1206/     793 : CD F8 08            	CALL	UPPER
    1207/     796 : B7                  	OR	A
    1208/     797 : 20 06               	JR	NZ,RG0
    1209/     799 : CD 1F 08            	CALL	RDUMP
    1210/     79C : C3 5C 02            	JP	WSTART
    1211/     79F :                     RG0:
    1212/     79F : EB                  	EX	DE,HL
    1213/     7A0 : 21 9F 0B            	LD	HL,RNTAB
    1214/     7A3 :                     RG1:
    1215/     7A3 : BE                  	CP	(HL)
    1216/     7A4 : 28 0D               	JR	Z,RG2		; Character match
    1217/     7A6 : 4F                  	LD	C,A
    1218/     7A7 : 23                  	INC	HL
    1219/     7A8 : 7E                  	LD	A,(HL)
    1220/     7A9 : B7                  	OR	A
    1221/     7AA : 28 70               	JR	Z,RGE		; Found end mark
    1222/     7AC : 79                  	LD	A,C
    1223/     7AD : 01 05 00            	LD	BC,5
    1224/     7B0 : 09                  	ADD	HL,BC		; Next entry
    1225/     7B1 : 18 F0               	JR	RG1
    1226/     7B3 :                     RG2:
    1227/     7B3 : 23                  	INC	HL
    1228/     7B4 : 7E                  	LD	A,(HL)
    1229/     7B5 : FE 0F               	CP	0FH		; Link code
    1230/     7B7 : 20 0C               	JR	NZ,RG3
    1231/     7B9 :                     	;; Next table
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 24 - 7/12/2023 13:23:49


    1232/     7B9 : 23                  	INC	HL
    1233/     7BA : 4E                  	LD	C,(HL)
    1234/     7BB : 23                  	INC	HL
    1235/     7BC : 66                  	LD	H,(HL)
    1236/     7BD : 69                  	LD	L,C
    1237/     7BE : 13                  	INC	DE
    1238/     7BF : 1A                  	LD	A,(DE)
    1239/     7C0 : CD F8 08            	CALL	UPPER
    1240/     7C3 : 18 DE               	JR	RG1
    1241/     7C5 :                     RG3:
    1242/     7C5 : B7                  	OR	A
    1243/     7C6 : 28 54               	JR	Z,RGE		; Found end mark
    1244/     7C8 :                     
    1245/     7C8 : 4E                  	LD	C,(HL)		; LD C,A???
    1246/     7C9 : 23                  	INC	HL
    1247/     7CA : 5E                  	LD	E,(HL)
    1248/     7CB : 23                  	INC	HL
    1249/     7CC : 56                  	LD	D,(HL)
    1250/     7CD : D5                  	PUSH	DE		; Reg storage address
    1251/     7CE : 23                  	INC	HL
    1252/     7CF : 7E                  	LD	A,(HL)
    1253/     7D0 : 23                  	INC	HL
    1254/     7D1 : 66                  	LD	H,(HL)
    1255/     7D2 : 6F                  	LD	L,A		; HL: Reg name
    1256/     7D3 : CD 4F 08            	CALL	STROUT
    1257/     7D6 : 3E 3D               	LD	A,'='
    1258/     7D8 : CD 46 0D            	CALL	CONOUT
    1259/     7DB :                     
    1260/     7DB : 79                  	LD	A,C
    1261/     7DC : E6 07               	AND	07H
    1262/     7DE : FE 01               	CP	1
    1263/     7E0 : 20 08               	JR	NZ,RG4
    1264/     7E2 :                     	;; 8 bit register
    1265/     7E2 : E1                  	POP	HL
    1266/     7E3 : 7E                  	LD	A,(HL)
    1267/     7E4 : E5                  	PUSH	HL
    1268/     7E5 : CD 5D 08            	CALL	HEXOUT2
    1269/     7E8 : 18 0C               	JR	RG5
    1270/     7EA :                     RG4:
    1271/     7EA :                     	;; 16 bit register
    1272/     7EA : E1                  	POP	HL
    1273/     7EB : E5                  	PUSH	HL
    1274/     7EC : 23                  	INC	HL
    1275/     7ED : 7E                  	LD	A,(HL)
    1276/     7EE : CD 5D 08            	CALL	HEXOUT2
    1277/     7F1 : 2B                  	DEC	HL
    1278/     7F2 : 7E                  	LD	A,(HL)
    1279/     7F3 : CD 5D 08            	CALL	HEXOUT2
    1280/     7F6 :                     RG5:
    1281/     7F6 : 3E 20               	LD	A,' '
    1282/     7F8 : CD 46 0D            	CALL	CONOUT
    1283/     7FB : C5                  	PUSH	BC		; C: reg size
    1284/     7FC : CD A5 08            	CALL	GETLIN
    1285/     7FF : 21 00 FF            	LD	HL,INBUF
    1286/     802 : CD F1 08            	CALL	SKIPSP
    1287/     805 : CD 01 09            	CALL	RDHEX
    1288/     808 : 79                  	LD	A,C
    1289/     809 : B7                  	OR	A
    1290/     80A : 28 0D               	JR	Z,RGR
    1291/     80C : C1                  	POP	BC
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 25 - 7/12/2023 13:23:49


    1292/     80D : E1                  	POP	HL
    1293/     80E : 79                  	LD	A,C
    1294/     80F : FE 01               	CP	1
    1295/     811 : 20 03               	JR	NZ,RG6
    1296/     813 :                     	;; 8 bit register
    1297/     813 : 73                  	LD	(HL),E
    1298/     814 : 18 03               	JR	RG7
    1299/     816 :                     RG6:
    1300/     816 :                     	;; 16 bit register
    1301/     816 : 73                  	LD	(HL),E
    1302/     817 : 23                  	INC	HL
    1303/     818 : 72                  	LD	(HL),D
    1304/     819 :                     RG7:
    1305/     819 :                     RGR:
    1306/     819 : C3 5C 02            	JP	WSTART
    1307/     81C :                     RGE:
    1308/     81C : C3 9D 02            	JP	ERR
    1309/     81F :                     
    1310/     81F :                     RDUMP:
    1311/     81F : 21 F4 0A            	LD	HL,RDTAB
    1312/     822 :                     RD0:
    1313/     822 : 5E                  	LD	E,(HL)
    1314/     823 : 23                  	INC	HL
    1315/     824 : 56                  	LD	D,(HL)
    1316/     825 : 23                  	INC	HL
    1317/     826 : 7A                  	LD	A,D
    1318/     827 : B3                  	OR	E
    1319/     828 : CA 9B 08            	JP	Z,CRLF		; End
    1320/     82B : EB                  	EX	DE,HL
    1321/     82C : CD 4F 08            	CALL	STROUT
    1322/     82F : EB                  	EX	DE,HL
    1323/     830 :                     
    1324/     830 : 5E                  	LD	E,(HL)
    1325/     831 : 23                  	INC	HL
    1326/     832 : 56                  	LD	D,(HL)
    1327/     833 : 23                  	INC	HL
    1328/     834 : 7E                  	LD	A,(HL)
    1329/     835 : 23                  	INC	HL
    1330/     836 : EB                  	EX	DE,HL
    1331/     837 : FE 01               	CP	1
    1332/     839 : 20 07               	JR	NZ,RD1
    1333/     83B :                     	;; 1 byte
    1334/     83B : 7E                  	LD	A,(HL)
    1335/     83C : CD 5D 08            	CALL	HEXOUT2
    1336/     83F : EB                  	EX	DE,HL
    1337/     840 : 18 E0               	JR	RD0
    1338/     842 :                     RD1:
    1339/     842 :                     	;; 2 byte
    1340/     842 : 23                  	INC	HL
    1341/     843 : 7E                  	LD	A,(HL)
    1342/     844 : CD 5D 08            	CALL	HEXOUT2		; High byte
    1343/     847 : 2B                  	DEC	HL
    1344/     848 : 7E                  	LD	A,(HL)
    1345/     849 : CD 5D 08            	CALL	HEXOUT2		; Low byte
    1346/     84C : EB                  	EX	DE,HL
    1347/     84D : 18 D3               	JR	RD0
    1348/     84F :                     
    1349/     84F : [1201]              	ENDIF
    1350/     84F :                     
    1351/     84F :                     ;;;
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 26 - 7/12/2023 13:23:49


    1352/     84F :                     ;;; Other support routines
    1353/     84F :                     ;;;
    1354/     84F :                     
    1355/     84F :                     STROUT:
    1356/     84F : 7E                  	LD	A,(HL)
    1357/     850 : A7                  	AND	A
    1358/     851 : C8                  	RET	Z
    1359/     852 : CD 46 0D            	CALL	CONOUT
    1360/     855 : 23                  	INC	HL
    1361/     856 : 18 F7               	JR	STROUT
    1362/     858 :                     
    1363/     858 :                     HEXOUT4:
    1364/     858 : 7C                  	LD	A,H
    1365/     859 : CD 5D 08            	CALL	HEXOUT2
    1366/     85C : 7D                  	LD	A,L
    1367/     85D :                     HEXOUT2:
    1368/     85D : F5                  	PUSH	AF
    1369/     85E : 1F                  	RRA
    1370/     85F : 1F                  	RRA
    1371/     860 : 1F                  	RRA
    1372/     861 : 1F                  	RRA
    1373/     862 : CD 66 08            	CALL	HEXOUT1
    1374/     865 : F1                  	POP	AF
    1375/     866 :                     HEXOUT1:
    1376/     866 : E6 0F               	AND	0FH
    1377/     868 : C6 30               	ADD	A,'0'
    1378/     86A : FE 3A               	CP	'9'+1
    1379/     86C : DA 46 0D            	JP	C,CONOUT
    1380/     86F : C6 07               	ADD	A,'A'-'9'-1
    1381/     871 : C3 46 0D            	JP	CONOUT
    1382/     874 :                     
    1383/     874 :                     HEXIN:
    1384/     874 : AF                  	XOR	A
    1385/     875 : CD 7C 08            	CALL	HI0
    1386/     878 : 07                  	RLCA
    1387/     879 : 07                  	RLCA
    1388/     87A : 07                  	RLCA
    1389/     87B : 07                  	RLCA
    1390/     87C :                     HI0:
    1391/     87C : C5                  	PUSH	BC
    1392/     87D : 4F                  	LD	C,A
    1393/     87E : CD 38 0D            	CALL	CONIN
    1394/     881 : CD F8 08            	CALL	UPPER
    1395/     884 : FE 30               	CP	'0'
    1396/     886 : 38 11               	JR	C,HIR
    1397/     888 : FE 3A               	CP	'9'+1
    1398/     88A : 38 0A               	JR	C,HI1
    1399/     88C : FE 41               	CP	'A'
    1400/     88E : 38 09               	JR	C,HIR
    1401/     890 : FE 47               	CP	'F'+1
    1402/     892 : 30 05               	JR	NC,HIR
    1403/     894 : D6 07               	SUB	A,'A'-'9'-1
    1404/     896 :                     HI1:
    1405/     896 : D6 30               	SUB	A,'0'
    1406/     898 : B1                  	OR	C
    1407/     899 :                     HIR:
    1408/     899 : C1                  	POP	BC
    1409/     89A : C9                  	RET
    1410/     89B :                     	
    1411/     89B :                     CRLF:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 27 - 7/12/2023 13:23:49


    1412/     89B : 3E 0D               	LD	A,CR
    1413/     89D : CD 46 0D            	CALL	CONOUT
    1414/     8A0 : 3E 0A               	LD	A,LF
    1415/     8A2 : C3 46 0D            	JP	CONOUT
    1416/     8A5 :                     
    1417/     8A5 :                     GETLIN:
    1418/     8A5 : 21 00 FF            	LD	HL,INBUF
    1419/     8A8 : 06 00               	LD	B,0
    1420/     8AA :                     GL0:
    1421/     8AA : CD 38 0D            	CALL	CONIN
    1422/     8AD : FE 0D               	CP	CR
    1423/     8AF : 28 3A               	JR	Z,GLE
    1424/     8B1 : FE 0A               	CP	LF
    1425/     8B3 : 28 36               	JR	Z,GLE
    1426/     8B5 : FE 08               	CP	BS
    1427/     8B7 : 28 1B               	JR	Z,GLB
    1428/     8B9 : FE 7F               	CP	DEL
    1429/     8BB : 28 17               	JR	Z,GLB
    1430/     8BD : FE 20               	CP	' '
    1431/     8BF : 38 E9               	JR	C,GL0
    1432/     8C1 : FE 80               	CP	80H
    1433/     8C3 : 30 E5               	JR	NC,GL0
    1434/     8C5 : 4F                  	LD	C,A
    1435/     8C6 : 78                  	LD	A,B
    1436/     8C7 : FE 0F               	CP	BUFLEN-1
    1437/     8C9 : 30 DF               	JR	NC,GL0	; Too long
    1438/     8CB : 04                  	INC	B
    1439/     8CC : 79                  	LD	A,C
    1440/     8CD : CD 46 0D            	CALL	CONOUT
    1441/     8D0 : 77                  	LD	(HL),A
    1442/     8D1 : 23                  	INC	HL
    1443/     8D2 : 18 D6               	JR	GL0
    1444/     8D4 :                     GLB:
    1445/     8D4 : 78                  	LD	A,B
    1446/     8D5 : A7                  	AND	A
    1447/     8D6 : 28 D2               	JR	Z,GL0
    1448/     8D8 : 05                  	DEC	B
    1449/     8D9 : 2B                  	DEC	HL
    1450/     8DA : 3E 08               	LD	A,08H
    1451/     8DC : CD 46 0D            	CALL	CONOUT
    1452/     8DF : 3E 20               	LD	A,' '
    1453/     8E1 : CD 46 0D            	CALL	CONOUT
    1454/     8E4 : 3E 08               	LD	A,08H
    1455/     8E6 : CD 46 0D            	CALL	CONOUT
    1456/     8E9 : 18 BF               	JR	GL0
    1457/     8EB :                     GLE:
    1458/     8EB : CD 9B 08            	CALL	CRLF
    1459/     8EE : 36 00               	LD	(HL),00H
    1460/     8F0 : C9                  	RET
    1461/     8F1 :                     
    1462/     8F1 :                     SKIPSP:
    1463/     8F1 : 7E                  	LD	A,(HL)
    1464/     8F2 : FE 20               	CP	A,' '
    1465/     8F4 : C0                  	RET	NZ
    1466/     8F5 : 23                  	INC	HL
    1467/     8F6 : 18 F9               	JR	SKIPSP
    1468/     8F8 :                     
    1469/     8F8 :                     UPPER:
    1470/     8F8 : FE 61               	CP	'a'
    1471/     8FA : D8                  	RET	C
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 28 - 7/12/2023 13:23:49


    1472/     8FB : FE 7B               	CP	'z'+1
    1473/     8FD : D0                  	RET	NC
    1474/     8FE : C6 E0               	ADD	A,'A'-'a'
    1475/     900 : C9                  	RET
    1476/     901 :                     
    1477/     901 :                     RDHEX:
    1478/     901 : 0E 00               	LD	C,0
    1479/     903 : 11 00 00            	LD	DE,0
    1480/     906 :                     RH0:
    1481/     906 : 7E                  	LD	A,(HL)
    1482/     907 : CD F8 08            	CALL	UPPER
    1483/     90A : FE 30               	CP	'0'
    1484/     90C : 38 2C               	JR	C,RHE
    1485/     90E : FE 3A               	CP	'9'+1
    1486/     910 : 38 0A               	JR	C,RH1
    1487/     912 : FE 41               	CP	'A'
    1488/     914 : 38 24               	JR	C,RHE
    1489/     916 : FE 47               	CP	'F'+1
    1490/     918 : 30 20               	JR	NC,RHE
    1491/     91A : D6 07               	SUB	'A'-'9'-1
    1492/     91C :                     RH1:
    1493/     91C : D6 30               	SUB	'0'
    1494/     91E : 17                  	RLA
    1495/     91F : 17                  	RLA
    1496/     920 : 17                  	RLA
    1497/     921 : 17                  	RLA
    1498/     922 : 17                  	RLA
    1499/     923 : CB 13               	RL	E
    1500/     925 : CB 12               	RL	D
    1501/     927 : 17                  	RLA
    1502/     928 : CB 13               	RL	E
    1503/     92A : CB 12               	RL	D
    1504/     92C : 17                  	RLA
    1505/     92D : CB 13               	RL	E
    1506/     92F : CB 12               	RL	D
    1507/     931 : 17                  	RLA
    1508/     932 : CB 13               	RL	E
    1509/     934 : CB 12               	RL	D
    1510/     936 : 23                  	INC	HL
    1511/     937 : 0C                  	INC	C
    1512/     938 : 18 CC               	JR	RH0
    1513/     93A :                     RHE:
    1514/     93A : C9                  	RET
    1515/     93B :                     
    1516/     93B :                     ;;;
    1517/     93B :                     ;;; RST 30H Handler
    1518/     93B :                     ;;;
    1519/     93B :                     
    1520/     93B :                     RST30H:
    1521/     93B : =>TRUE              	IF USE_NEWAPI
    1522/     93B :                     
    1523/     93B : E5                  	PUSH	HL
    1524/     93C : C5                  	PUSH	BC
    1525/     93D : 21 4B 09            	LD	HL,APITBL
    1526/     940 : 06 00               	LD	B,0
    1527/     942 : 09                  	ADD	HL,BC
    1528/     943 : 09                  	ADD	HL,BC
    1529/     944 : 46                  	LD	B,(HL)
    1530/     945 : 23                  	INC	HL
    1531/     946 : 66                  	LD	H,(HL)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 29 - 7/12/2023 13:23:49


    1532/     947 : 68                  	LD	L,B
    1533/     948 : C1                  	POP	BC
    1534/     949 : E3                  	EX	(SP),HL		; Restore HL, jump address on stack top
    1535/     94A : C9                  	RET
    1536/     94B :                     
    1537/     94B :                     APITBL:
    1538/     94B : 59 09               	DW	API00		; 00: CSTART
    1539/     94D : 5E 09               	DW	API01		; 01: WSTART
    1540/     94F : 46 0D               	DW	CONOUT		; 02: CONOUT
    1541/     951 : 4F 08               	DW	STROUT		; 03: STROUT
    1542/     953 : 38 0D               	DW	CONIN		; 04: CONIN
    1543/     955 : 41 0D               	DW	CONST		; 05: CONST
    1544/     957 : 62 09               	DW	API06		; 06: PSPEC
    1545/     959 :                     
    1546/     959 :                     	;; CSTART
    1547/     959 :                     API00:
    1548/     959 : E1                  	POP	HL		; Drop return address
    1549/     95A : F3                  	DI
    1550/     95B : C3 00 01            	JP	CSTART
    1551/     95E :                     
    1552/     95E :                     	;; WSTART
    1553/     95E :                     API01:
    1554/     95E : E1                  	POP	HL		; Drop return address
    1555/     95F : C3 5C 02            	JP	WSTART
    1556/     962 :                     
    1557/     962 :                     	;; PSPEC
    1558/     962 :                     API06:
    1559/     962 : 3A 1B FF            	LD	A,(PSPEC)
    1560/     965 : C9                  	RET
    1561/     966 :                     
    1562/     966 : =>FALSE             	ELSE			; USE_NEWAPI
    1563/     966 :                     
    1564/     966 :                     	RET
    1565/     966 :                     
    1566/     966 : [1521]              	ENDIF			; USE_NEWAPI
    1567/     966 :                     
    1568/     966 :                     ;;;
    1569/     966 :                     ;;; RST 38H Handler
    1570/     966 :                     ;;;
    1571/     966 :                     
    1572/     966 :                     RST38H:
    1573/     966 : =>TRUE              	IF USE_REGCMD
    1574/     966 :                     
    1575/     966 : F5                  	PUSH	AF
    1576/     967 : ED 5F               	LD	A,R
    1577/     969 : 32 37 FF            	LD	(REGR),A
    1578/     96C : ED 57               	LD	A,I
    1579/     96E : 32 36 FF            	LD	(REGI),A
    1580/     971 : 22 24 FF            	LD	(REGHL),HL
    1581/     974 : ED 53 22 FF         	LD	(REGDE),DE
    1582/     978 : ED 43 20 FF         	LD	(REGBC),BC
    1583/     97C : E1                  	POP	HL
    1584/     97D : 22 1E FF            	LD	(REGAF),HL
    1585/     980 : 08                  	EX	AF,AF'
    1586/     981 : F5                  	PUSH	AF
    1587/     982 : D9                  	EXX
    1588/     983 : 22 2C FF            	LD	(REGHLX),HL
    1589/     986 : ED 53 2A FF         	LD	(REGDEX),DE
    1590/     98A : ED 43 28 FF         	LD	(REGBCX),BC
    1591/     98E : E1                  	POP	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 30 - 7/12/2023 13:23:49


    1592/     98F : 22 26 FF            	LD	(REGAFX),HL
    1593/     992 : DD 22 2E FF         	LD	(REGIX),IX
    1594/     996 : FD 22 30 FF         	LD	(REGIY),IY
    1595/     99A : E1                  	POP	HL
    1596/     99B : 2B                  	DEC	HL
    1597/     99C : 22 34 FF            	LD	(REGPC),HL
    1598/     99F : ED 73 32 FF         	LD	(REGSP),SP
    1599/     9A3 :                     
    1600/     9A3 :                     	;; R register adjustment
    1601/     9A3 : =>TRUE              	IF USE_IDENT
    1602/     9A3 : 3A 1B FF            	LD	A,(PSPEC)
    1603/     9A6 : FE 08               	CP	08H		; Z280
    1604/     9A8 : 28 1F               	JR	Z,R381
    1605/     9AA : FE 09               	CP	09H		; NSC800
    1606/     9AC : 28 13               	JR	Z,R380
    1607/     9AE : 3A 37 FF            	LD	A,(REGR)
    1608/     9B1 : D6 05               	SUB	05H
    1609/     9B3 : E6 7F               	AND	7FH
    1610/     9B5 : 47                  	LD	B,A
    1611/     9B6 : 3A 37 FF            	LD	A,(REGR)
    1612/     9B9 : E6 80               	AND	80H
    1613/     9BB : B0                  	OR	B
    1614/     9BC : 32 37 FF            	LD	(REGR),A
    1615/     9BF : 18 08               	JR	R381
    1616/     9C1 :                     R380:
    1617/     9C1 : 3A 37 FF            	LD	A,(REGR)
    1618/     9C4 : D6 05               	SUB	05H
    1619/     9C6 : 32 37 FF            	LD	(REGR),A
    1620/     9C9 :                     R381:
    1621/     9C9 : [1601]              	ENDIF
    1622/     9C9 :                     
    1623/     9C9 : 21 E3 0A            	LD	HL,RST38MSG
    1624/     9CC : CD 4F 08            	CALL	STROUT
    1625/     9CF : CD 1F 08            	CALL	RDUMP
    1626/     9D2 : C3 5C 02            	JP	WSTART
    1627/     9D5 :                     
    1628/     9D5 : =>FALSE             	ELSE
    1629/     9D5 :                     
    1630/     9D5 :                     	RET
    1631/     9D5 :                     
    1632/     9D5 : [1573]              	ENDIF
    1633/     9D5 :                     
    1634/     9D5 :                     ;;; HD64180/Z180 TRAP Handler
    1635/     9D5 :                     
    1636/     9D5 : =>TRUE              	IF USE_180TRAP
    1637/     9D5 :                     TRAPH:
    1638/     9D5 : =>TRUE              	IF USE_REGCMD
    1639/     9D5 :                     
    1640/     9D5 : 3A 02 FF            	LD	A,(INBUF+2)
    1641/     9D8 : 32 37 FF            	LD	(REGR),A
    1642/     9DB : ED 57               	LD	A,I
    1643/     9DD : 32 36 FF            	LD	(REGI),A
    1644/     9E0 : 22 24 FF            	LD	(REGHL),HL
    1645/     9E3 : ED 53 22 FF         	LD	(REGDE),DE
    1646/     9E7 : E1                  	POP	HL
    1647/     9E8 : 22 20 FF            	LD	(REGBC),HL
    1648/     9EB : E1                  	POP	HL
    1649/     9EC : 22 1E FF            	LD	(REGAF),HL
    1650/     9EF : 08                  	EX	AF,AF'
    1651/     9F0 : F5                  	PUSH	AF
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 31 - 7/12/2023 13:23:49


    1652/     9F1 : D9                  	EXX
    1653/     9F2 : 22 2C FF            	LD	(REGHLX),HL
    1654/     9F5 : ED 53 2A FF         	LD	(REGDEX),DE
    1655/     9F9 : ED 43 28 FF         	LD	(REGBCX),BC
    1656/     9FD : E1                  	POP	HL
    1657/     9FE : 22 26 FF            	LD	(REGAFX),HL
    1658/     A01 : DD 22 2E FF         	LD	(REGIX),IX
    1659/     A05 : FD 22 30 FF         	LD	(REGIY),IY
    1660/     A09 :                     
    1661/     A09 : ED 7B 00 FF         	LD	SP,(INBUF)	; Recover SP
    1662/     A0D : E1                  	POP	HL
    1663/     A0E : 06 0A               	LD	B,10		; for R register adjustment
    1664/     A10 : 3A 03 FF            	LD	A,(INBUF+3)	; ITC
    1665/     A13 : E6 40               	AND	40H
    1666/     A15 : 28 02               	JR	Z,TH0
    1667/     A17 : 2B                  	DEC	HL
    1668/     A18 : 04                  	INC	B
    1669/     A19 :                     TH0:
    1670/     A19 : 2B                  	DEC	HL
    1671/     A1A : 22 34 FF            	LD	(REGPC),HL
    1672/     A1D : ED 73 32 FF         	LD	(REGSP),SP
    1673/     A21 :                     
    1674/     A21 :                     	;; R register adjustment
    1675/     A21 : 3A 37 FF            	LD	A,(REGR)
    1676/     A24 : 90                  	SUB	B
    1677/     A25 : E6 7F               	AND	7FH
    1678/     A27 : 47                  	LD	B,A
    1679/     A28 : 3A 37 FF            	LD	A,(REGR)
    1680/     A2B : E6 80               	AND	80H
    1681/     A2D : B0                  	OR	B
    1682/     A2E : 32 37 FF            	LD	(REGR),A
    1683/     A31 :                     
    1684/     A31 : 21 ED 0A            	LD	HL,TRAPMSG
    1685/     A34 : CD 4F 08            	CALL	STROUT
    1686/     A37 : CD 1F 08            	CALL	RDUMP
    1687/     A3A : C3 5C 02            	JP	WSTART
    1688/     A3D :                     
    1689/     A3D : =>FALSE             	ELSE			; USE_REGCMD
    1690/     A3D :                     
    1691/     A3D :                     	LD	SP,(INBUF)	; Recover SP
    1692/     A3D :                     	POP	HL		; Drop return address
    1693/     A3D :                     	
    1694/     A3D :                     	LD	HL,TRAPMSG
    1695/     A3D :                     	CALL	STROUT
    1696/     A3D :                     	JP	WSTART
    1697/     A3D :                     	
    1698/     A3D : [1638]              	ENDIF			; USE_REGCMD
    1699/     A3D :                     
    1700/     A3D : [1636]              	ENDIF			; USE_180TRAP
    1701/     A3D :                     
    1702/     A3D :                     ;;;
    1703/     A3D :                     ;;; Messages
    1704/     A3D :                     ;;;
    1705/     A3D :                     	
    1706/     A3D :                     OPNMSG:
    1707/     A3D : 0D 0A 55 6E 69 76   	DB	CR,LF,"Universal Monitor Z80",CR,LF,00H
              A43 : 65 72 73 61 6C 20 
              A49 : 4D 6F 6E 69 74 6F 
              A4F : 72 20 5A 38 30 0D 
              A55 : 0A 00             
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 32 - 7/12/2023 13:23:49


    1708/     A57 :                     
    1709/     A57 :                     PROMPT:
    1710/     A57 : 5D 20 00            	DB	"] ",00H
    1711/     A5A :                     
    1712/     A5A :                     IHEMSG:
    1713/     A5A : 45 72 72 6F 72 20   	DB	"Error ihex",CR,LF,00H
              A60 : 69 68 65 78 0D 0A 
              A66 : 00                
    1714/     A67 :                     SHEMSG:
    1715/     A67 : 45 72 72 6F 72 20   	DB	"Error srec",CR,LF,00H
              A6D : 73 72 65 63 0D 0A 
              A73 : 00                
    1716/     A74 :                     ERRMSG:
    1717/     A74 : 45 72 72 6F 72 0D   	DB	"Error",CR,LF,00H
              A7A : 0A 00             
    1718/     A7C :                     
    1719/     A7C :                     DSEP0:
    1720/     A7C : 20 3A 00            	DB	" :",00H
    1721/     A7F :                     DSEP1:
    1722/     A7F : 20 3A 20 00         	DB	" : ",00H
    1723/     A83 :                     IHEXER:
    1724/     A83 : 3A 30 30 30 30 30           DB	":00000001FF",CR,LF,00H
              A89 : 30 30 31 46 46 0D 
              A8F : 0A 00             
    1725/     A91 :                     SRECER:
    1726/     A91 : 53 39 30 33 30 30           DB	"S9030000FC",CR,LF,00H
              A97 : 30 30 46 43 0D 0A 
              A9D : 00                
    1727/     A9E :                     
    1728/     A9E : =>TRUE              	IF USE_IDENT
    1729/     A9E :                     IM80:
    1730/     A9E : 5A 38 30 0D 0A 00   	DB	"Z80",CR,LF,00H
    1731/     AA4 :                     IM180:
    1732/     AA4 : 48 44 36 34 31 38   	DB	"HD64180R",CR,LF,00H
              AAA : 30 52 0D 0A 00    
    1733/     AAF :                     IM180Z:
    1734/     AAF : 48 44 36 34 31 38   	DB	"HD64180Z",CR,LF,00H
              AB5 : 30 5A 0D 0A 00    
    1735/     ABA :                     IM1960:
    1736/     ABA : 5A 38 53 31 38 30   	DB	"Z8S180 SL1960",CR,LF,00H
              AC0 : 20 53 4C 31 39 36 
              AC6 : 30 0D 0A 00       
    1737/     ACA :                     IMZ8S:
    1738/     ACA : 5A 38 53 31 38 30   	DB	"Z8S180",CR,LF,00H
              AD0 : 0D 0A 00          
    1739/     AD3 :                     IM280:
    1740/     AD3 : 5A 32 38 30 0D 0A   	DB	"Z280",CR,LF,00H
              AD9 : 00                
    1741/     ADA :                     IMNSC:
    1742/     ADA : 4E 53 43 38 30 30   	DB	"NSC800",CR,LF,00H
              AE0 : 0D 0A 00          
    1743/     AE3 : [1728]              	ENDIF
    1744/     AE3 :                     
    1745/     AE3 :                     RST38MSG:
    1746/     AE3 : 52 53 54 20 33 38   	DB	"RST 38H",CR,LF,00H
              AE9 : 48 0D 0A 00       
    1747/     AED :                     
    1748/     AED : =>TRUE              	IF USE_180TRAP
    1749/     AED :                     TRAPMSG:
    1750/     AED : 54 52 41 50 0D 0A   	DB	"TRAP",CR,LF,00H
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 33 - 7/12/2023 13:23:49


              AF3 : 00                
    1751/     AF4 : [1748]              	ENDIF
    1752/     AF4 :                     
    1753/     AF4 : =>TRUE              	IF USE_REGCMD
    1754/     AF4 :                     
    1755/     AF4 :                     	;; Register dump table
    1756/     AF4 : 49 0B 1F FF         RDTAB:	DW	RDSA,   REGAF+1
    1757/     AF8 : 01                  	DB	1
    1758/     AF9 : 4D 0B 20 FF         	DW	RDSBC,  REGBC
    1759/     AFD : 02                  	DB	2
    1760/     AFE : 53 0B 22 FF         	DW	RDSDE,  REGDE
    1761/     B02 : 02                  	DB	2
    1762/     B03 : 59 0B 24 FF         	DW	RDSHL,  REGHL
    1763/     B07 : 02                  	DB	2
    1764/     B08 : 5F 0B 1E FF         	DW	RDSF,   REGAF
    1765/     B0C : 01                  	DB	1
    1766/     B0D :                     
    1767/     B0D : 64 0B 2E FF         	DW	RDSIX,  REGIX
    1768/     B11 : 02                  	DB	2
    1769/     B12 : 6A 0B 30 FF         	DW	RDSIY,  REGIY
    1770/     B16 : 02                  	DB	2
    1771/     B17 :                     
    1772/     B17 : 6F 0B 27 FF         	DW	RDSAX,  REGAFX+1
    1773/     B1B : 01                  	DB	1
    1774/     B1C : 75 0B 28 FF         	DW	RDSBCX, REGBCX
    1775/     B20 : 02                  	DB	2
    1776/     B21 : 7B 0B 2A FF         	DW	RDSDEX, REGDEX
    1777/     B25 : 02                  	DB	2
    1778/     B26 : 81 0B 2C FF         	DW	RDSHLX, REGHLX
    1779/     B2A : 02                  	DB	2
    1780/     B2B : 87 0B 26 FF         	DW	RDSFX,  REGAFX
    1781/     B2F : 01                  	DB	1
    1782/     B30 :                     
    1783/     B30 : 8C 0B 32 FF         	DW	RDSSP,  REGSP
    1784/     B34 : 02                  	DB	2
    1785/     B35 : 92 0B 34 FF         	DW	RDSPC,  REGPC
    1786/     B39 : 02                  	DB	2
    1787/     B3A : 97 0B 36 FF         	DW	RDSI,   REGI
    1788/     B3E : 01                  	DB	1
    1789/     B3F : 9B 0B 37 FF         	DW	RDSR,   REGR
    1790/     B43 : 01                  	DB	1
    1791/     B44 :                     
    1792/     B44 : 00 00 00 00         	DW	0000H,  0000H
    1793/     B48 : 00                  	DB	0
    1794/     B49 :                     
    1795/     B49 : 41 20 3D 00         RDSA:	DB	"A =",00H
    1796/     B4D : 20 42 43 20 3D 00   RDSBC:	DB	" BC =",00H
    1797/     B53 : 20 44 45 20 3D 00   RDSDE:	DB	" DE =",00H
    1798/     B59 : 20 48 4C 20 3D 00   RDSHL:	DB	" HL =",00H
    1799/     B5F : 20 46 20 3D 00      RDSF:	DB	" F =",00H
    1800/     B64 : 20 20 49 58 3D 00   RDSIX:	DB	"  IX=",00H
    1801/     B6A : 20 49 59 3D 00      RDSIY:	DB	" IY=",00H
    1802/     B6F : 0D 0A 41 27 3D 00   RDSAX:	DB	CR,LF,"A'=",00H
    1803/     B75 : 20 42 43 27 3D 00   RDSBCX:	DB	" BC'=",00H
    1804/     B7B : 20 44 45 27 3D 00   RDSDEX:	DB	" DE'=",00H
    1805/     B81 : 20 48 4C 27 3D 00   RDSHLX:	DB	" HL'=",00H
    1806/     B87 : 20 46 27 3D 00      RDSFX:	DB	" F'=",00H
    1807/     B8C : 20 20 53 50 3D 00   RDSSP:	DB	"  SP=",00H
    1808/     B92 : 20 50 43 3D 00      RDSPC:	DB	" PC=",00H
    1809/     B97 : 20 49 3D 00         RDSI:	DB	" I=",00H
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 34 - 7/12/2023 13:23:49


    1810/     B9B : 20 52 3D 00         RDSR:	DB	" R=",00H
    1811/     B9F :                     
    1812/     B9F :                     RNTAB:
    1813/     B9F : 41 0F               	DB	'A',0FH		; "A?"
    1814/     BA1 : E9 0B 00 00         	DW	RNTABA,0
    1815/     BA5 : 42 0F               	DB	'B',0FH		; "B?"
    1816/     BA7 : F7 0B 00 00         	DW	RNTABB,0
    1817/     BAB : 43 0F               	DB	'C',0FH		; "C?"
    1818/     BAD : 19 0C 00 00         	DW	RNTABC,0
    1819/     BB1 : 44 0F               	DB	'D',0FH		; "D?"
    1820/     BB3 : 27 0C 00 00         	DW	RNTABD,0
    1821/     BB7 : 45 0F               	DB	'E',0FH		; "E?"
    1822/     BB9 : 49 0C 00 00         	DW	RNTABE,0
    1823/     BBD : 46 0F               	DB	'F',0FH		; "F?"
    1824/     BBF : 57 0C 00 00         	DW	RNTABF,0
    1825/     BC3 : 48 0F               	DB	'H',0FH		; "H?"
    1826/     BC5 : 65 0C 00 00         	DW	RNTABH,0
    1827/     BC9 : 49 0F               	DB	'I',0FH		; "I?"
    1828/     BCB : 95 0C 00 00         	DW	RNTABI,0
    1829/     BCF : 4C 0F               	DB	'L',0FH		; "L?"
    1830/     BD1 : 87 0C 00 00         	DW	RNTABL,0
    1831/     BD5 : 50 0F               	DB	'P',0FH		; "P?"
    1832/     BD7 : A9 0C 00 00         	DW	RNTABP,0
    1833/     BDB : 52 01               	DB	'R',1		; "R"
    1834/     BDD : 37 FF 04 0D         	DW	REGR,RNR
    1835/     BE1 : 53 0F               	DB	'S',0FH		; "S?"
    1836/     BE3 : B1 0C 00 00         	DW	RNTABS,0
    1837/     BE7 :                     
    1838/     BE7 : 00 00               	DB	00H,0		; End mark
    1839/     BE9 :                     
    1840/     BE9 :                     RNTABA:
    1841/     BE9 : 00 01               	DB	00H,1		; "A"
    1842/     BEB : 1F FF B9 0C         	DW	REGAF+1,RNA
    1843/     BEF : 27 01               	DB	'\'',1		; "A'"
    1844/     BF1 : 27 FF D2 0C         	DW	REGAFX+1,RNAX
    1845/     BF5 :                     
    1846/     BF5 : 00 00               	DB	00H,0
    1847/     BF7 :                     	
    1848/     BF7 :                     RNTABB:
    1849/     BF7 : 00 01               	DB	00H,1		; "B"
    1850/     BF9 : 21 FF BE 0C         	DW	REGBC+1,RNB
    1851/     BFD : 27 01               	DB	'\'',1		; "B'"
    1852/     BFF : 29 FF D9 0C         	DW	REGBCX+1,RNBX
    1853/     C03 : 43 0F               	DB	'C',0FH		; "BC?"
    1854/     C05 : 0B 0C 00 00         	DW	RNTABBC,0
    1855/     C09 :                     
    1856/     C09 : 00 00               	DB	00H,0		; End mark
    1857/     C0B :                     
    1858/     C0B :                     RNTABBC:
    1859/     C0B : 00 02               	DB	00H,2		; "BC"
    1860/     C0D : 20 FF BB 0C         	DW	REGBC,RNBC
    1861/     C11 : 27 02               	DB	'\'',2		; "BC'"
    1862/     C13 : 28 FF D5 0C         	DW	REGBCX,RNBCX
    1863/     C17 :                     
    1864/     C17 : 00 00               	DB	00H,0
    1865/     C19 :                     	
    1866/     C19 :                     RNTABC:
    1867/     C19 : 00 01               	DB	00H,1		; "C"
    1868/     C1B : 20 FF C0 0C         	DW	REGBC,RNC
    1869/     C1F : 27 01               	DB	'\'',1		; "C'"
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 35 - 7/12/2023 13:23:49


    1870/     C21 : 28 FF DC 0C         	DW	REGBCX,RNCX
    1871/     C25 :                     
    1872/     C25 : 00 00               	DB	00H,0
    1873/     C27 :                     	
    1874/     C27 :                     RNTABD:
    1875/     C27 : 00 01               	DB	00H,1		; "D"
    1876/     C29 : 23 FF C5 0C         	DW	REGDE+1,RND
    1877/     C2D : 27 01               	DB	'\'',1		; "D'"
    1878/     C2F : 2B FF E3 0C         	DW	REGDEX+1,RNDX
    1879/     C33 : 45 0F               	DB	'E',0FH		; "DE?"
    1880/     C35 : 3B 0C 00 00         	DW	RNTABDE,0
    1881/     C39 :                     
    1882/     C39 : 00 00               	DB	00H,0
    1883/     C3B :                     
    1884/     C3B :                     RNTABDE:
    1885/     C3B : 00 02               	DB	00H,2		; "DE"
    1886/     C3D : 22 FF C2 0C         	DW	REGDE,RNDE
    1887/     C41 : 27 02               	DB	'\'',2		; "DE'"
    1888/     C43 : 2A FF DF 0C         	DW	REGDEX,RNDEX
    1889/     C47 :                     
    1890/     C47 : 00 00               	DB	00H,0
    1891/     C49 :                     	
    1892/     C49 :                     RNTABE:
    1893/     C49 : 00 01               	DB	00H,1		; "E"
    1894/     C4B : 22 FF C7 0C         	DW	REGDE,RNE
    1895/     C4F : 27 01               	DB	'\'',1		; "E'"
    1896/     C51 : 2A FF E6 0C         	DW	REGDEX,RNEX
    1897/     C55 :                     
    1898/     C55 : 00 00               	DB	00H,0
    1899/     C57 :                     	
    1900/     C57 :                     RNTABF:
    1901/     C57 : 00 01               	DB	00H,1		; "F"
    1902/     C59 : 1E FF D0 0C         	DW	REGAF,RNF
    1903/     C5D : 27 01               	DB	'\'',1		; "F'"
    1904/     C5F : 26 FF F3 0C         	DW	REGAFX,RNFX
    1905/     C63 :                     
    1906/     C63 : 00 00               	DB	00H,0
    1907/     C65 :                     	
    1908/     C65 :                     RNTABH:
    1909/     C65 : 00 01               	DB	00H,1		; "H"
    1910/     C67 : 25 FF CC 0C         	DW	REGHL+1,RNH
    1911/     C6B : 27 01               	DB	'\'',1		; "H'"
    1912/     C6D : 2D FF ED 0C         	DW	REGHLX+1,RNHX
    1913/     C71 : 4C 0F               	DB	'L',0FH		; "HL?"
    1914/     C73 : 79 0C 00 00         	DW	RNTABHL,0
    1915/     C77 :                     
    1916/     C77 : 00 00               	DB	00H,0
    1917/     C79 :                     
    1918/     C79 :                     RNTABHL:
    1919/     C79 : 00 02               	DB	00H,2		; "HL"
    1920/     C7B : 24 FF C9 0C         	DW	REGHL,RNHL
    1921/     C7F : 27 02               	DB	'\'',2		; "HL'"
    1922/     C81 : 2C FF E9 0C         	DW	REGHLX,RNHLX
    1923/     C85 :                     
    1924/     C85 : 00 00               	DB	00H,0
    1925/     C87 :                     	
    1926/     C87 :                     RNTABL:
    1927/     C87 : 00 01               	DB	00H,1		; "L"
    1928/     C89 : 24 FF CE 0C         	DW	REGHL,RNL
    1929/     C8D : 27 01               	DB	'\'',1		; "L'"
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 36 - 7/12/2023 13:23:49


    1930/     C8F : 2C FF F0 0C         	DW	REGHLX,RNLX
    1931/     C93 :                     
    1932/     C93 : 00 00               	DB	00H,0
    1933/     C95 :                     	
    1934/     C95 :                     RNTABI:
    1935/     C95 : 00 01               	DB	00H,1		; "I"
    1936/     C97 : 36 FF 02 0D         	DW	REGI,RNI
    1937/     C9B : 58 02               	DB	'X',2		; "IX"
    1938/     C9D : 2E FF F6 0C         	DW	REGIX,RNIX
    1939/     CA1 : 59 02               	DB	'Y',2		; "IY"
    1940/     CA3 : 30 FF F9 0C         	DW	REGIY,RNIY
    1941/     CA7 :                     	
    1942/     CA7 : 00 00               	DB	00H,0
    1943/     CA9 :                     
    1944/     CA9 :                     RNTABP:
    1945/     CA9 : 43 02               	DB	'C',2		; "PC"
    1946/     CAB : 34 FF FF 0C         	DW	REGPC,RNPC
    1947/     CAF :                     
    1948/     CAF : 00 00               	DB	00H,0
    1949/     CB1 :                     
    1950/     CB1 :                     RNTABS:
    1951/     CB1 : 50 02               	DB	'P',2		; "SP"
    1952/     CB3 : 32 FF FC 0C         	DW	REGSP,RNSP
    1953/     CB7 :                     
    1954/     CB7 : 00 00               	DB	00H,0
    1955/     CB9 :                     
    1956/     CB9 : 41 00               RNA:	DB	"A",00H
    1957/     CBB : 42 43 00            RNBC:	DB	"BC",00H
    1958/     CBE : 42 00               RNB:	DB	"B",00H
    1959/     CC0 : 43 00               RNC:	DB	"C",00H
    1960/     CC2 : 44 45 00            RNDE:	DB	"DE",00H
    1961/     CC5 : 44 00               RND:	DB	"D",00H
    1962/     CC7 : 45 00               RNE:	DB	"E",00H
    1963/     CC9 : 48 4C 00            RNHL:	DB	"HL",00H
    1964/     CCC : 48 00               RNH:	DB	"H",00H
    1965/     CCE : 4C 00               RNL:	DB	"L",00H
    1966/     CD0 : 46 00               RNF:	DB	"F",00H
    1967/     CD2 : 41 27 00            RNAX:	DB	"A'",00H
    1968/     CD5 : 42 43 27 00         RNBCX:	DB	"BC'",00H
    1969/     CD9 : 42 27 00            RNBX:	DB	"B'",00H
    1970/     CDC : 43 27 00            RNCX:	DB	"C'",00H
    1971/     CDF : 44 45 27 00         RNDEX:	DB	"DE'",00H
    1972/     CE3 : 44 27 00            RNDX:	DB	"D'",00H
    1973/     CE6 : 45 27 00            RNEX:	DB	"E'",00H
    1974/     CE9 : 48 4C 27 00         RNHLX:	DB	"HL'",00H
    1975/     CED : 48 27 00            RNHX:	DB	"H'",00H
    1976/     CF0 : 4C 27 00            RNLX:	DB	"L'",00H
    1977/     CF3 : 46 27 00            RNFX:	DB	"F'",00H
    1978/     CF6 : 49 58 00            RNIX:	DB	"IX",00H
    1979/     CF9 : 49 59 00            RNIY:	DB	"IY",00H
    1980/     CFC : 53 50 00            RNSP:	DB	"SP",00H
    1981/     CFF : 50 43 00            RNPC:	DB	"PC",00H
    1982/     D02 : 49 00               RNI:	DB	"I",00H
    1983/     D04 : 52 00               RNR:	DB	"R",00H
    1984/     D06 :                     
    1985/     D06 : [1753]              	ENDIF
    1986/     D06 :                     
    1987/     D06 :                     ;;;
    1988/     D06 :                     ;;; Console drivers
    1989/     D06 :                     ;;;
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 37 - 7/12/2023 13:23:49


    1990/     D06 :                     
    1991/     D06 : =>FALSE             	IF USE_DEV_8251
    1992/     D06 :                     	INCLUDE	"dev/dev_8251.asm"
    1993/     D06 : [1991]              	ENDIF
    1994/     D06 :                     
    1995/     D06 : =>TRUE              	IF USE_DEV_Z80SIO
    1996/     D06 :                     	INCLUDE	"dev/dev_z80sio.asm"
(1)    1/     D06 :                     ;;;
(1)    2/     D06 :                     ;;;	Z80 SIO Console Driver
(1)    3/     D06 :                     ;;; 
(1)    4/     D06 :                     
(1)    5/     D06 :                     INIT:
(1)    6/     D06 :                     	;; Initialize SIO
(1)    7/     D06 : DB 19               	IN	A,(SIOAC)
(1)    8/     D08 : DB 1B               	IN	A,(SIOBC)
(1)    9/     D0A :                     	;; Reset both Ch.
(1)   10/     D0A : 3E 18               	LD	A,18H
(1)   11/     D0C : D3 19               	OUT	(SIOAC),A
(1)   12/     D0E : D3 1B               	OUT	(SIOBC),A
(1)   13/     D10 :                     
(1)   14/     D10 : =>TRUE              	IF USE_Z80CTC
(1)   15/     D10 : 3E 07               	LD	A,07H		; Timer mode, 1/16, fall-edge, no ext trigger
(1)   16/     D12 : D3 13               	OUT	(CTC0),A
(1)   17/     D14 : 3E 05               	LD	A,TC_V
(1)   18/     D16 : D3 13               	OUT	(CTC0),A
(1)   19/     D18 : [14]                	ENDIF			; USE_CTC
(1)   20/     D18 :                     	
(1)   21/     D18 :                     	;; Ch.A WR1
(1)   22/     D18 : 3E 01               	LD	A,01H
(1)   23/     D1A : D3 19               	OUT	(SIOAC),A
(1)   24/     D1C : AF                  	XOR	A
(1)   25/     D1D : D3 19               	OUT	(SIOAC),A
(1)   26/     D1F :                     
(1)   27/     D1F :                     	;; Ch.A WR4
(1)   28/     D1F : 3E 04               	LD	A,04H
(1)   29/     D21 : D3 19               	OUT	(SIOAC),A
(1)   30/     D23 : 3E 44               	LD	A,44H		; x16 1 N
(1)   31/     D25 : D3 19               	OUT	(SIOAC),A
(1)   32/     D27 :                     
(1)   33/     D27 :                     	;; Ch.A WR3
(1)   34/     D27 : 3E 03               	LD	A,03H
(1)   35/     D29 : D3 19               	OUT	(SIOAC),A
(1)   36/     D2B : 3E C1               	LD	A,0C1H		; 8bit Receiver enable
(1)   37/     D2D : D3 19               	OUT	(SIOAC),A
(1)   38/     D2F :                     	
(1)   39/     D2F :                     	;; Ch.A WR5
(1)   40/     D2F : 3E 05               	LD	A,05H
(1)   41/     D31 : D3 19               	OUT	(SIOAC),A
(1)   42/     D33 : 3E EA               	LD	A,0EAH		; 8bit Transmitter enable
(1)   43/     D35 : D3 19               	OUT	(SIOAC),A
(1)   44/     D37 :                     
(1)   45/     D37 : C9                  	RET
(1)   46/     D38 :                     
(1)   47/     D38 :                     ;;;
(1)   48/     D38 :                     ;;; SIO Ch.A conin/const/conout w/o interrupt
(1)   49/     D38 :                     ;;;
(1)   50/     D38 :                     
(1)   51/     D38 :                     CONIN:
(1)   52/     D38 : DB 19               	IN	A,(SIOAC)
(1)   53/     D3A : E6 01               	AND	01H
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(dev/dev_z80sio.asm) - Page 38 - 7/12/2023 13:23:49


(1)   54/     D3C : 28 FA               	JR	Z,CONIN
(1)   55/     D3E : DB 18               	IN	A,(SIOAD)
(1)   56/     D40 : C9                  	RET
(1)   57/     D41 :                     
(1)   58/     D41 :                     CONST:
(1)   59/     D41 : DB 19               	IN	A,(SIOAC)
(1)   60/     D43 : E6 01               	AND	01H
(1)   61/     D45 : C9                  	RET
(1)   62/     D46 :                     
(1)   63/     D46 :                     CONOUT:
(1)   64/     D46 : F5                  	PUSH	AF
(1)   65/     D47 :                     CO0:
(1)   66/     D47 : DB 19               	IN	A,(SIOAC)
(1)   67/     D49 : E6 04               	AND	04H
(1)   68/     D4B : 28 FA               	JR	Z,CO0
(1)   69/     D4D : F1                  	POP	AF
(1)   70/     D4E : D3 18               	OUT	(SIOAD),A
(1)   71/     D50 : C9                  	RET
(1)   72/     D51 :                     
    1997/     D51 : [1995]              	ENDIF
    1998/     D51 :                     
    1999/     D51 : =>FALSE             	IF USE_DEV_NSC858
    2000/     D51 :                     	INCLUDE	"dev/dev_nsc858.asm"
    2001/     D51 : [1999]              	ENDIF
    2002/     D51 :                     
    2003/     D51 : =>FALSE             	IF USE_DEV_Z280
    2004/     D51 :                     	INCLUDE	"dev/dev_z280.asm"
    2005/     D51 : [2003]              	ENDIF
    2006/     D51 :                     
    2007/     D51 : =>FALSE             	IF USE_DEV_64180
    2008/     D51 :                     	INCLUDE	"dev/dev_64180.asm"
    2009/     D51 : [2007]              	ENDIF
    2010/     D51 :                     
    2011/     D51 : =>FALSE             	IF USE_DEV_EMILY
    2012/     D51 :                     	INCLUDE	"dev/dev_emily.asm"
    2013/     D51 : [2011]              	ENDIF
    2014/     D51 :                     
    2015/     D51 :                     ;;;
    2016/     D51 :                     ;;; RAM area
    2017/     D51 :                     ;;;
    2018/     D51 :                     
    2019/     D51 :                     	;;
    2020/     D51 :                     	;; Work Area
    2021/     D51 :                     	;;
    2022/     D51 :                     	
    2023/    FF00 :                     	ORG	WORK_B
    2024/    FF00 :                     
    2025/    FF00 :                     INBUF:	DS	BUFLEN	; Line input buffer
    2026/    FF10 :                     DSADDR:	DS	2	; Dump start address
    2027/    FF12 :                     DEADDR:	DS	2	; Dump end address
    2028/    FF14 :                     DSTATE:	DS	1	; Dump state
    2029/    FF15 :                     GADDR:	DS	2	; Go address
    2030/    FF17 :                     SADDR:	DS	2	; Set address
    2031/    FF19 :                     HEXMOD:	DS	1	; HEX file mode
    2032/    FF1A :                     RECTYP:	DS	1	; Record type
    2033/    FF1B :                     PSPEC:	DS	1	; Processor spec.
    2034/    FF1C :                     SIZE:	DS	1	; I/O Size 00H,'W','S'
    2035/    FF1D :                     IOPAGE:	DS	1	; I/O Page (for Z280)
    2036/    FF1E :                     
    2037/    FF1E : =>TRUE              	IF USE_REGCMD
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 39 - 7/12/2023 13:23:49


    2038/    FF1E :                     
    2039/    FF1E :                     REG_B:	
    2040/    FF1E :                     REGAF:	DS	2
    2041/    FF20 :                     REGBC:	DS	2
    2042/    FF22 :                     REGDE:	DS	2
    2043/    FF24 :                     REGHL:	DS	2
    2044/    FF26 :                     REGAFX:	DS	2		; Register AF'
    2045/    FF28 :                     REGBCX:	DS	2
    2046/    FF2A :                     REGDEX:	DS	2
    2047/    FF2C :                     REGHLX:	DS	2		; Register HL'
    2048/    FF2E :                     REGIX:	DS	2
    2049/    FF30 :                     REGIY:	DS	2
    2050/    FF32 :                     REGSP:	DS	2
    2051/    FF34 :                     REGPC:	DS	2
    2052/    FF36 :                     REGI:	DS	1
    2053/    FF37 :                     REGR:	DS	1
    2054/    FF38 :                     REG_E:
    2055/    FF38 : [2037]              	ENDIF
    2056/    FF38 :                     
    2057/    FF38 : =>TRUE              	IF USE_RAMCHK
    2058/    FF38 :                     RAMEND:	DS	2
    2059/    FF3A : [2057]              	ENDIF
    2060/    FF3A :                     	
    2061/    FF3A :                     	END
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 40 - 7/12/2023 13:23:49


  Symbol Table (* = unused):
  --------------------------

 API00 :                        959 C |  API01 :                        95E C |
 API06 :                        962 C |  APITBL :                       94B C |
*ARCHITECTURE :                                        "i386-unknown-win32" - |
 BS :                             8 - |  BTCR_V :                        30 - |
 BTIR_V :                        40 - |  BUFLEN :                        10 - |
*CASESENSITIVE :                  0 - |  CCR1_V :                         0 - |
 CCR_V :                          0 - |  CO0 :                         0D47 C |
 CONIN :                       0D38 C |  CONOUT :                      0D46 C |
 CONST :                       0D41 C | *CONSTPI :        3.141592653589793 - |
 CR :                            0D - |  CRLF :                         89B C |
 CS0 :                          131 C |  CSTART :                       100 C |
 CTC0 :                          13 - | *DATE :                 "7/12/2023" - |
 DCNTL_V :                        0 - |  DEADDR :                     0FF12 C |
 DEL :                           7F - |  DP0 :                          2C3 C |
 DP1 :                          2DB C |  DPB :                          35F C |
 DPB0 :                         376 C |  DPB1 :                         385 C |
 DPB2 :                         38A C |  DPL :                          325 C |
 DPL0 :                         336 C |  DPL1 :                         346 C |
 DPL2 :                         355 C |  DPL3 :                         35A C |
 DPM :                          2F3 C |  DPM0 :                         2FE C |
 DPM1 :                         31C C |  DSADDR :                     0FF10 C |
 DSEP0 :                       0A7C C |  DSEP1 :                       0A7F C |
 DSTATE :                     0FF14 C |  DUMP :                         2A5 C |
 ENTRY :                         80 - |  ERR :                          29D C |
 ERRMSG :                      0A74 C | *E_CONIN :                      0A0 C |
*E_CONOUT :                      90 C | *E_CONST :                      0A8 C |
*E_CSTART :                      80 C | *E_STROUT :                      98 C |
*E_WSTART :                      88 C | *FALSE :                          0 - |
*FULLPMMU :                       1 - |  G0 :                           3BF C |
 G01 :                          3DD C |  G1 :                           3E5 C |
 GADDR :                      0FF15 C |  GETLIN :                       8A5 C |
 GL0 :                          8AA C |  GLB :                          8D4 C |
 GLE :                          8EB C |  GO :                           3AB C |
*HAS64 :                          0 - | *HASFPU :                         0 - |
*HASPMMU :                        0 - |  HEXIN :                        874 C |
 HEXMOD :                     0FF19 C |  HEXOUT1 :                      866 C |
 HEXOUT2 :                      85D C |  HEXOUT4 :                      858 C |
 HI0 :                          87C C |  HI1 :                          896 C |
 HIR :                          899 C |  IDE :                          205 C |
 ID_180 :                       17C C |  ID_180Z :                      19E C |
 ID_1960 :                      1BF C |  ID_280 :                       1D7 C |
 ID_NSC :                       200 C |  ID_Z8S :                       1CB C |
 IHEMSG :                      0A5A C |  IHEXER :                      0A83 C |
 IM180 :                       0AA4 C |  IM180Z :                      0AAF C |
 IM1960 :                      0ABA C |  IM280 :                       0AD3 C |
 IM80 :                        0A9E C |  IMNSC :                       0ADA C |
 IMZ8S :                       0ACA C |  INBUF :                      0FF00 C |
 INIT :                        0D06 C | *INSUPMODE :                      0 - |
 IOBASE :                       0C0 - |  IOPAGE :                     0FF1D C |
 IR0 :                          229 C |  LF :                            0A - |
 LH0 :                          49F C | *LH1 :                          4A9 C |
 LH2 :                          4AD C |  LH3 :                          4B5 C |
 LHI0 :                         4BA C |  LHI1 :                         4D8 C |
 LHI2 :                         4EA C |  LHI20 :                        4E9 C |
 LHI3 :                         4EC C |  LHIE :                         4FC C |
 LHS0 :                         505 C |  LHS1 :                         522 C |
 LHS2 :                         534 C |  LHS20 :                        535 C |
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 41 - 7/12/2023 13:23:49


 LHS3 :                         537 C |  LHSE :                         551 C |
 LHSR :                         557 C | *LISTON :                         1 - |
 LOADH :                        489 C | *MACEXP :                         7 - |
*MOMCPU :                        80 - | *MOMCPUNAME :                 "Z80" - |
*NESTMAX :                      100 - |  OMCR_V :                        40 - |
 OPNMSG :                      0A3D C | *PADDING :                        1 - |
 PB0 :                          783 C |  PBANK :                        761 C |
 PI0 :                          64F C |  PI1 :                          653 C |
 PIB :                          685 C |  PIN :                          637 C |
 PIS :                          6BE C |  PIW :                          6A1 C |
 PO0 :                          6E1 C |  PO1 :                          6E5 C |
 POB :                          72A C |  POS :                          75B C |
 POUT :                         6C9 C |  POW :                          741 C |
 PROMPT :                      0A57 C |  PSPEC :                      0FF1B C |
 R380 :                         9C1 C |  R381 :                         9C9 C |
 RAMEND :                     0FF38 C |  RAM_B :                       8000 - |
 RC0 :                          13A C |  RC1 :                          14A C |
 RC2 :                          14F C |  RCE :                          158 C |
 RD0 :                          822 C |  RD1 :                          842 C |
 RDHEX :                        901 C |  RDSA :                        0B49 C |
 RDSAX :                       0B6F C |  RDSBC :                       0B4D C |
 RDSBCX :                      0B75 C |  RDSDE :                       0B53 C |
 RDSDEX :                      0B7B C |  RDSF :                        0B5F C |
 RDSFX :                       0B87 C |  RDSHL :                       0B59 C |
 RDSHLX :                      0B81 C |  RDSI :                        0B97 C |
 RDSIX :                       0B64 C |  RDSIY :                       0B6A C |
 RDSPC :                       0B92 C |  RDSR :                        0B9B C |
 RDSSP :                       0B8C C |  RDTAB :                       0AF4 C |
 RDUMP :                        81F C |  RECTYP :                     0FF1A C |
 REG :                          78F C |  REGAF :                      0FF1E C |
 REGAFX :                     0FF26 C |  REGBC :                      0FF20 C |
 REGBCX :                     0FF28 C |  REGDE :                      0FF22 C |
 REGDEX :                     0FF2A C |  REGHL :                      0FF24 C |
 REGHLX :                     0FF2C C |  REGI :                       0FF36 C |
 REGIX :                      0FF2E C |  REGIY :                      0FF30 C |
 REGPC :                      0FF34 C |  REGR :                       0FF37 C |
 REGSP :                      0FF32 C |  REG_B :                      0FF1E C |
 REG_E :                      0FF38 C | *RELAXED :                        0 - |
 RG0 :                          79F C |  RG1 :                          7A3 C |
 RG2 :                          7B3 C |  RG3 :                          7C5 C |
 RG4 :                          7EA C |  RG5 :                          7F6 C |
 RG6 :                          816 C |  RG7 :                          819 C |
 RGE :                          81C C |  RGR :                          819 C |
 RH0 :                          906 C |  RH1 :                          91C C |
 RHE :                          93A C |  RMR_V :                         83 - |
 RNA :                         0CB9 C |  RNAX :                        0CD2 C |
 RNB :                         0CBE C |  RNBC :                        0CBB C |
 RNBCX :                       0CD5 C |  RNBX :                        0CD9 C |
 RNC :                         0CC0 C |  RNCX :                        0CDC C |
 RND :                         0CC5 C |  RNDE :                        0CC2 C |
 RNDEX :                       0CDF C |  RNDX :                        0CE3 C |
 RNE :                         0CC7 C |  RNEX :                        0CE6 C |
 RNF :                         0CD0 C |  RNFX :                        0CF3 C |
 RNH :                         0CCC C |  RNHL :                        0CC9 C |
 RNHLX :                       0CE9 C |  RNHX :                        0CED C |
 RNI :                         0D02 C |  RNIX :                        0CF6 C |
 RNIY :                        0CF9 C |  RNL :                         0CCE C |
 RNLX :                        0CF0 C |  RNPC :                        0CFF C |
 RNR :                         0D04 C |  RNSP :                        0CFC C |
 RNTAB :                       0B9F C |  RNTABA :                      0BE9 C |
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 42 - 7/12/2023 13:23:49


 RNTABB :                      0BF7 C |  RNTABBC :                     0C0B C |
 RNTABC :                      0C19 C |  RNTABD :                      0C27 C |
 RNTABDE :                     0C3B C |  RNTABE :                      0C49 C |
 RNTABF :                      0C57 C |  RNTABH :                      0C65 C |
 RNTABHL :                     0C79 C |  RNTABI :                      0C95 C |
 RNTABL :                      0C87 C |  RNTABP :                      0CA9 C |
 RNTABS :                      0CB1 C |  RRR_V :                         38 - |
 RST30H :                       93B C |  RST38H :                       966 C |
 RST38MSG :                    0AE3 C |  SADDR :                      0FF17 C |
 SAVEH :                        55A C |  SETM :                         422 C |
 SH0 :                          567 C |  SH1 :                          56B C |
 SH2 :                          595 C |  SH3 :                          59D C |
 SH4 :                          5B4 C |  SHE :                          592 C |
 SHEMSG :                      0A67 C |  SHL :                          5BD C |
 SHL0 :                         5C8 C |  SHLI0 :                        5F1 C |
 SHLS :                         605 C |  SHLS0 :                        624 C |
 SIOAC :                         19 - |  SIOAD :                         18 - |
 SIOBC :                         1B - | *SIOBD :                         1A - |
 SIZE :                       0FF1C C |  SKIPSP :                       8F1 C |
 SM0 :                          439 C |  SM1 :                          43A C |
 SM2 :                          463 C |  SM3 :                          46E C |
 SM4 :                          479 C |  SRECER :                      0A91 C |
 STACK :                          0 - |  STROUT :                       84F C |
*TARGET :                     "Z80" - |  TC_V :                           5 - |
 TH0 :                         0A19 C | *TIME :                  "13:23:49" - |
 TL :                           235 C |  TRAPH :                        9D5 C |
 TRAPMSG :                     0AED C | *TRUE :                           1 - |
 UPPER :                        8F8 C |  USE_180TRAP :                    1 - |
 USE_DEV_64180 :                  0 - |  USE_DEV_8251 :                   0 - |
 USE_DEV_EMILY :                  0 - |  USE_DEV_NSC858 :                 0 - |
 USE_DEV_Z280 :                   0 - |  USE_DEV_Z80SIO :                 1 - |
 USE_IDENT :                      1 - |  USE_NEWAPI :                     1 - |
 USE_RAMCHK :                     1 - |  USE_REGCMD :                     1 - |
 USE_SPINIT :                     0 - |  USE_WARMUP :                     0 - |
 USE_Z80CTC :                     1 - | *VERSION :                     142F - |
 WORK_B :                     0FF00 - |  WSTART :                       25C C |

    305 symbols
     29 unused symbols

 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 43 - 7/12/2023 13:23:49


  Defined Functions:
  ------------------

HIGH                                  | LOW                                  

 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 44 - 7/12/2023 13:23:49


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.10 seconds assembly time

   2283 lines source file
      2 passes
      0 errors
      0 warnings
