 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 1 - 7/9/2023 8:51:44


       1/       0 :                     ;;; 
       2/       0 :                     ;;; Universal Monitor for Zilog Z80
       3/       0 :                     ;;;   Copyright (C) 2019,2020,2021 Haruo Asano
       4/       0 :                     ;;;
       5/       0 :                     
       6/       0 :                     	CPU	Z80
       7/       0 :                     
       8/       0 : ="Z80"              TARGET:	equ	"Z80"
       9/       0 :                     
      10/       0 :                     
      11/       0 :                     	INCLUDE	"config.inc"
(1)    1/       0 :                     ;;; -*- asm -*-
(1)    2/       0 :                     ;;;
(1)    3/       0 :                     ;;; Universal Monitor Z80 config file (for AKI-80)
(1)    4/       0 :                     ;;;
(1)    5/       0 :                     
(1)    6/       0 :                     ;;;
(1)    7/       0 :                     ;;; Memory
(1)    8/       0 :                     ;;;
(1)    9/       0 :                     
(1)   10/       0 : =80H                ENTRY:	EQU	0080H		; Entry point
(1)   11/       0 :                     
(1)   12/       0 : =8000H              RAM_B:	EQU	8000H
(1)   13/       0 : =0FF00H             WORK_B:	equ	0FF00H
(1)   14/       0 : =0H                 STACK:	equ	0000H
(1)   15/       0 :                     
(1)   16/       0 : =10H                BUFLEN:	equ	16
(1)   17/       0 :                     
(1)   18/       0 :                     ;;;
(1)   19/       0 :                     ;;; Options
(1)   20/       0 :                     ;;;
(1)   21/       0 :                     
(1)   22/       0 : =1H                 USE_IDENT = 1			; CPU Identification
(1)   23/       0 :                     
(1)   24/       0 : =1H                 USE_REGCMD = 1			; R(egister) command and related functions
(1)   25/       0 :                     
(1)   26/       0 : =1H                 USE_RAMCHK = 1			; Check RAM
(1)   27/       0 :                     
(1)   28/       0 : =0H                 USE_WARMUP = 0			; DRAM warming up
(1)   29/       0 : =>FALSE             	IF USE_WARMUP
(1)   30/       0 :                     WARMUP_ADDR = 8000H		;   Start address
(1)   31/       0 :                     WARMUP_INCR = 1			;   Address increment
(1)   32/       0 :                     WARMUP_CNT = 128 * 8		;   Count
(1)   33/       0 : [29]                	ENDIF
(1)   34/       0 :                     
(1)   35/       0 : =1H                 USE_NEWAPI = 1			; New API (RST 30H)
(1)   36/       0 :                     
(1)   37/       0 :                     ;;; HD64180 specific
(1)   38/       0 : =0H                 DCNTL_V: EQU	00H
(1)   39/       0 : =83H                RMR_V:	EQU	83H
(1)   40/       0 : =40H                OMCR_V:	EQU	40H
(1)   41/       0 : =0C0H               IOBASE:	EQU	0C0H		; Internal I/O BASE (00H,40H,80H,0C0H)
(1)   42/       0 :                     
(1)   43/       0 : =1H                 USE_180TRAP = 1			; Handle HD64180 TRAP (experimental)
(1)   44/       0 :                     
(1)   45/       0 :                     ;;; Z8S180 specific
(1)   46/       0 :                     	;; CPU Control Register
(1)   47/       0 : =0H                 CCR1_V:	EQU	00H
(1)   48/       0 :                     	
(1)   49/       0 :                     ;;; Z280 specific
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(config.inc) - Page 2 - 7/9/2023 8:51:44


(1)   50/       0 :                     	;; Bus Timing and Control Register: none additional WAIT
(1)   51/       0 : =30H                BTCR_V:	EQU	30H		; I/O=00, HM=00, DC=00
(1)   52/       0 :                     	;; Bus Timing and Initialization Register
(1)   53/       0 : =40H                BTIR_V:	EQU	40H		; (CS=00), LM=00, MP=0, (BS=1), (DIC=0)
(1)   54/       0 :                     	;; Cache Control Register
(1)   55/       0 : =0H                 CCR_V:	EQU	00H		; Instruction & data cache enable, no burst mode
(1)   56/       0 :                     	;; Refresh Rate Register
(1)   57/       0 : =38H                RRR_V:	EQU	38H		; Disable refresh
(1)   58/       0 :                     
(1)   59/       0 :                     ;;;
(1)   60/       0 :                     ;;; Special initialize routine
(1)   61/       0 :                     ;;;
(1)   62/       0 :                     
(1)   63/       0 : =0H                 USE_SPINIT = 0
(1)   64/       0 : =>FALSE             	IF USE_SPINIT
(1)   65/       0 :                     
(1)   66/       0 :                     SPINIT	MACRO
(1)   67/       0 :                     	ENDM
(1)   68/       0 :                     
(1)   69/       0 : [64]                	ENDIF
(1)   70/       0 :                     
(1)   71/       0 :                     ;;;
(1)   72/       0 :                     ;;; Console Drivers
(1)   73/       0 :                     ;;;
(1)   74/       0 :                     
(1)   75/       0 :                     ;;; Zilog Z80 SIO
(1)   76/       0 :                     	
(1)   77/       0 : =1H                 USE_DEV_Z80SIO = 1
(1)   78/       0 : =>TRUE              	IF USE_DEV_Z80SIO
(1)   79/       0 : =18H                SIOAD:	equ	18H		; 
(1)   80/       0 : =19H                SIOAC:	equ	19H		;
(1)   81/       0 : =1AH                SIOBD:	equ	1AH		; (Ch.B not supported)
(1)   82/       0 : =1BH                SIOBC:	equ	1BH		; (Ch.B not supported)
(1)   83/       0 : =1H                 USE_Z80CTC = 1			; Use Z80 CTC for baudrate generator
(1)   84/       0 : =>TRUE              	IF USE_Z80CTC
(1)   85/       0 : =13H                CTC0:	EQU	13H
(1)   86/       0 : =5H                 TC_V:	EQU	5		; 9600bps @ 12.228MHz
(1)   87/       0 : [84]                	ENDIF			; USE_Z80CTC
(1)   88/       0 : [78]                	ENDIF
(1)   89/       0 :                     
(1)   90/       0 :                     ;;; Intel 8251
(1)   91/       0 :                     
(1)   92/       0 : =0H                 USE_DEV_8251 = 0
(1)   93/       0 : =>FALSE             	IF USE_DEV_8251
(1)   94/       0 :                     USARTD:	equ	00H		; Data Register
(1)   95/       0 :                     USARTC:	equ	01H		; Control / Status Register
(1)   96/       0 : [93]                	ENDIF
(1)   97/       0 :                     	
(1)   98/       0 :                     ;;; NS NSC858
(1)   99/       0 :                     
(1)  100/       0 : =0H                 USE_DEV_NSC858 = 0
(1)  101/       0 : =>FALSE             	IF USE_DEV_NSC858
(1)  102/       0 :                     NSBASE:	EQU	00H
(1)  103/       0 :                     RTMR_V:	EQU	0B0H		; Internal clock, 8 bit, no parity (RMR/TMR)
(1)  104/       0 :                     GMR_V:	EQU	01H		; 1 stop bit, x16
(1)  105/       0 :                     BRGD_V:	EQU	26		; 9600bps @ 4MHz
(1)  106/       0 : [101]               	ENDIF
(1)  107/       0 :                     
(1)  108/       0 :                     ;;; Zilog Z280 (Internal)
(1)  109/       0 :                     
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(config.inc) - Page 3 - 7/9/2023 8:51:44


(1)  110/       0 : =0H                 USE_DEV_Z280 = 0
(1)  111/       0 : =>FALSE             	IF USE_DEV_Z280
(1)  112/       0 :                     TCR1:	EQU	(19-1)		; bps = CLK(Xtal) / 8 / (TCR1+1) / 16
(1)  113/       0 : [111]               	ENDIF
(1)  114/       0 :                     
(1)  115/       0 :                     ;;; Hitachi HD64180 (Internal)
(1)  116/       0 :                     
(1)  117/       0 : =0H                 USE_DEV_64180 = 0
(1)  118/       0 : =>FALSE             	IF USE_DEV_64180
(1)  119/       0 :                     ASBASE:	EQU	IOBASE+0	; IOBASE+1 for ASCI Ch.1
(1)  120/       0 :                     CNTLA_V: EQU	6CH		; 8bit 1 N
(1)  121/       0 :                     CNTLB_V: EQU	02H		; CLK/640
(1)  122/       0 : [118]               	ENDIF
(1)  123/       0 :                     
(1)  124/       0 :                     ;;; EMILY Board (Shared Memory)
(1)  125/       0 :                     
(1)  126/       0 : =0H                 USE_DEV_EMILY = 0
(1)  127/       0 : =>FALSE             	IF USE_DEV_EMILY
(1)  128/       0 :                     SMREG:	EQU	0FF0H
(1)  129/       0 : [127]               	ENDIF
(1)  130/       0 :                     
      12/       0 :                     
      13/       0 :                     	INCLUDE	"../common.inc"
(1)    1/       0 :                     ;;; -*- asm -*-
(1)    2/       0 :                     ;;;
(1)    3/       0 :                     ;;; Common header file
(1)    4/       0 :                     ;;;
(1)    5/       0 :                     
(1)    6/       0 :                     	RELAXED	ON
(1)    7/       0 :                     
(1)    8/       0 :                     ;;; Constants
(1)    9/       0 : =0DH                CR:	EQU	0x0D
(1)   10/       0 : =0AH                LF:	EQU	0x0A
(1)   11/       0 : =8H                 BS:	EQU	0x08
(1)   12/       0 : =7FH                DEL:	EQU	0x7F
(1)   13/       0 :                     
(1)   14/       0 :                     ;;; Functions
(1)   15/       0 :                     low	function	x,(x & 255)
(1)   16/       0 :                     high	function	x,(x >> 8)
(1)   17/       0 :                     
(1)   18/       0 :                     	RELAXED	OFF
(1)   19/       0 :                     
      14/       0 :                     
      15/       0 :                     	
      16/       0 :                     ;;; 
      17/       0 :                     ;;; ROM area
      18/       0 :                     ;;;
      19/       0 :                     
      20/       0 :                     	ORG	0000H
      21/       0 : F3                  	DI
      22/       1 : C3 00 01            	JP	CSTART
      23/       4 :                     
      24/       8 :                     	ORG	0008H
      25/       8 :                     
      26/       8 :                     
      27/      10 :                     	ORG	0010H
      28/      10 : C3 38 0D            	JP	CONIN
      29/      13 :                     
      30/      18 :                     	ORG	0018H
      31/      18 : C3 46 0D            	JP	CONOUT
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 4 - 7/9/2023 8:51:44


      32/      1B :                     
      33/      1B :                     	;; ORG	0020H
      34/      1B :                     	;; JP	EEREAD
      35/      1B :                     
      36/      1B :                     	;; ORG	0028H
      37/      1B :                     	;; JP	EEWRITE
      38/      1B :                     
      39/      30 :                     	ORG	0030H
      40/      30 : C3 3B 09            	JP	RST30H
      41/      33 :                     
      42/      38 :                     	ORG	0038H
      43/      38 : C3 66 09            	JP	RST38H
      44/      3B :                     
      45/      3B :                     	;;
      46/      3B :                     	;; Entry point
      47/      3B :                     	;;
      48/      3B :                     
      49/      80 :                     	ORG	ENTRY+0		; Cold start
      50/      80 :                     E_CSTART:
      51/      80 : C3 00 01            	JP	CSTART
      52/      83 :                     	
      53/      88 :                     	ORG	ENTRY+8		; Warm start
      54/      88 :                     E_WSTART:
      55/      88 : C3 5C 02            	JP	WSTART
      56/      8B :                     
      57/      90 :                     	ORG	ENTRY+16	; Console output
      58/      90 :                     E_CONOUT:
      59/      90 : C3 46 0D            	JP	CONOUT
      60/      93 :                     
      61/      98 :                     	ORG	ENTRY+24	; (Console) String output
      62/      98 :                     E_STROUT:
      63/      98 : C3 4F 08            	JP	STROUT
      64/      9B :                     
      65/      A0 :                     	ORG	ENTRY+32	; Console input
      66/      A0 :                     E_CONIN:
      67/      A0 : C3 38 0D            	JP	CONIN
      68/      A3 :                     
      69/      A8 :                     	ORG	ENTRY+40	; Console status
      70/      A8 :                     E_CONST:
      71/      A8 : C3 41 0D            	JP	CONST
      72/      AB :                     
      73/      AB :                     	;;
      74/      AB :                     	;;
      75/      AB :                     	;; 
      76/      AB :                     
      77/     100 :                     	ORG	0100H
      78/     100 :                     CSTART:
      79/     100 :                     	;; Identify HD64180/Z180 TRAP
      80/     100 : =>TRUE              	IF USE_180TRAP
      81/     100 :                     	SAVE
      82/     100 :                     	CPU	Z180
      83/     100 : ED 73 00 FF         	LD	(INBUF),SP	; Save SP
      84/     104 : 31 10 FF            	LD	SP,INBUF+BUFLEN	; Temporary stack on INBUF area
      85/     107 : F5                  	PUSH	AF
      86/     108 : ED 5F               	LD	A,R
      87/     10A : 32 02 FF            	LD	(INBUF+2),A	; Save R
      88/     10D : C5                  	PUSH	BC
      89/     10E : 01 FF 00            	LD	BC,00FFH
      90/     111 : ED 4C               	MLT	BC
      91/     113 : 78                  	LD	A,B
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 5 - 7/9/2023 8:51:44


      92/     114 : B1                  	OR	C
      93/     115 : 20 1A               	JR	NZ,CS0		; Not HD64180/Z180
      94/     117 :                     	;; HD64180/Z180
      95/     117 : 3E C0               	LD	A,IOBASE
      96/     119 : ED 39 3F            	OUT0	(3FH),A
      97/     11C : ED 38 F4            	IN0	A,(IOBASE+34H)	; ITC register
      98/     11F : 32 03 FF            	LD	(INBUF+3),A
      99/     122 : E6 80               	AND	80H
     100/     124 : 28 0B               	JR	Z,CS0		; Not TRAP
     101/     126 : 3A 03 FF            	LD	A,(INBUF+3)
     102/     129 : E6 7F               	AND	7FH
     103/     12B : ED 39 F4            	OUT0	(IOBASE+34H),A	; Reset TRAP bit
     104/     12E : C3 D5 09            	JP	TRAPH
     105/     131 :                     CS0:
     106/     131 : ALL                 	RESTORE
     107/     131 : [80]                	ENDIF
     108/     131 :                     
     109/     131 : 31 00 00            	LD	SP,STACK
     110/     134 :                     
     111/     134 : =>FALSE             	IF USE_SPINIT
     112/     134 :                     	SPINIT
     113/     134 : [111]               	ENDIF
     114/     134 :                     
     115/     134 :                     	;; DRAM warming up
     116/     134 : =>FALSE             	IF USE_WARMUP
     117/     134 :                     
     118/     134 :                     	LD	HL,WARMUP_ADDR
     119/     134 :                     	IF WARMUP_INCR > 1
     120/     134 :                     	LD	DE,WARMUP_INCR
     121/     134 : [119]               	ENDIF
     122/     134 :                     	LD	BC,WARMUP_CNT
     123/     134 :                     WU0:
     124/     134 :                     	LD	A,(HL)
     125/     134 :                     	IF WARMUP_INCR == 1
     126/     134 :                     	INC	HL
     127/     134 : [125]               	ENDIF
     128/     134 :                     	IF WARMUP_INCR > 1
     129/     134 :                     	ADD	HL,DE
     130/     134 : [128]               	ENDIF
     131/     134 :                     	DEC	BC
     132/     134 :                     	LD	A,B
     133/     134 :                     	OR	C
     134/     134 :                     	JR	NZ,WU0
     135/     134 :                     
     136/     134 : [116]               	ENDIF
     137/     134 :                     
     138/     134 :                     	;; Check RAM
     139/     134 : =>TRUE              	IF USE_RAMCHK
     140/     134 :                     
     141/     134 : 11 00 80            	LD	DE,RAM_B
     142/     137 : 21 01 80            	LD	HL,RAM_B+1
     143/     13A :                     RC0:
     144/     13A : 7E                  	LD	A,(HL)
     145/     13B : 47                  	LD	B,A
     146/     13C : 2F                  	CPL
     147/     13D : 77                  	LD	(HL),A
     148/     13E : BE                  	CP	(HL)
     149/     13F : 20 09               	JR	NZ,RC1		; Unwritable
     150/     141 : 1A                  	LD	A,(DE)
     151/     142 : BE                  	CP	(HL)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 6 - 7/9/2023 8:51:44


     152/     143 : 20 0A               	JR	NZ,RC2
     153/     145 : 70                  	LD	(HL),B
     154/     146 : 1A                  	LD	A,(DE)
     155/     147 : BE                  	CP	(HL)
     156/     148 : 20 05               	JR	NZ,RC2
     157/     14A :                     RC1:	
     158/     14A :                     	;; (HL) and (DE) points same memory or (HL) points no memory
     159/     14A : 22 38 FF            	LD	(RAMEND),HL
     160/     14D : 18 09               	JR	RCE
     161/     14F :                     RC2:
     162/     14F : 70                  	LD	(HL),B
     163/     150 : 23                  	INC	HL
     164/     151 : 7C                  	LD	A,H
     165/     152 : B5                  	OR	L
     166/     153 : 20 E5               	JR	NZ,RC0
     167/     155 : 22 38 FF            	LD	(RAMEND),HL
     168/     158 :                     RCE:	
     169/     158 : [139]               	ENDIF
     170/     158 :                     	
     171/     158 :                     	;; CPU identification
     172/     158 : AF                  	XOR	A
     173/     159 : 32 1B FF            	LD	(PSPEC),A
     174/     15C :                     
     175/     15C : =>TRUE              	IF USE_IDENT
     176/     15C : 01 FF 00            	LD	BC,00FFH
     177/     15F : ED 4C               	DB	0EDH,4CH	; MLT BC (HD64180)
     178/     161 : 78                  	LD	A,B
     179/     162 : B1                  	OR	C
     180/     163 : 28 17               	JR	Z,ID_180
     181/     165 : 3E 40               	LD	A,40H
     182/     167 : CB 37               	DB	0CBH,37H	; TEST A (Z280)
     183/     169 : F2 D7 01            	JP	P,ID_280
     184/     16C : 3E 7F               	LD	A,7FH
     185/     16E : ED 4F               	LD	R,A
     186/     170 : ED 5F               	LD	A,R
     187/     172 : FA 00 02            	JP	M,ID_NSC
     188/     175 :                     	;; Z80
     189/     175 : 21 9E 0A            	LD	HL,IM80
     190/     178 : AF                  	XOR	A
     191/     179 : C3 05 02            	JP	IDE
     192/     17C :                     	;; HD64180
     193/     17C :                     	SAVE			; HD64180 specific initialization
     194/     17C :                     	CPU	Z180
     195/     17C :                     ID_180:
     196/     17C : 3E C0               	LD	A,IOBASE
     197/     17E : ED 39 3F            	OUT0	(3FH),A
     198/     181 : 3E 00               	LD	A,DCNTL_V
     199/     183 : ED 39 F2            	OUT0	(IOBASE+32H),A
     200/     186 : 3E 83               	LD	A,RMR_V
     201/     188 : ED 39 F6            	OUT0	(IOBASE+36H),A
     202/     18B : 3E 7F               	LD	A,7FH		; Try to change OMCR bit 7 to 0
     203/     18D : ED 39 FE            	OUT0	(IOBASE+3EH),A
     204/     190 : ED 38 FE            	IN0	A,(IOBASE+3EH)
     205/     193 : E6 80               	AND	80H
     206/     195 : 28 07               	JR	Z,ID_180Z	; HD64180Z detected
     207/     197 :                     
     208/     197 : 21 A4 0A            	LD	HL,IM180
     209/     19A : 3E 01               	LD	A,01H
     210/     19C : 18 67               	JR	IDE
     211/     19E :                     	;; HD64180Z
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 7 - 7/9/2023 8:51:44


     212/     19E :                     ID_180Z:
     213/     19E : 3E 40               	LD	A,OMCR_V
     214/     1A0 : ED 39 FE            	OUT0	(IOBASE+3EH),A
     215/     1A3 : AF                  	XOR	A
     216/     1A4 : ED 39 D2            	OUT0	(IOBASE+12H),A
     217/     1A7 : ED 38 D2            	IN0	A,(IOBASE+12H)
     218/     1AA : E6 40               	AND	40H
     219/     1AC : 28 1D               	JR	Z,ID_Z8S	; Z8S180 (SL1919) detected
     220/     1AE :                     
     221/     1AE : AF                  	XOR	A
     222/     1AF : ED 39 DF            	OUT0	(IOBASE+1FH),A
     223/     1B2 : ED 38 DF            	IN0	A,(IOBASE+1FH)
     224/     1B5 : B7                  	OR	A
     225/     1B6 : 28 07               	JR	Z,ID_1960	; Z8S180 (SL1960) detected
     226/     1B8 :                     	
     227/     1B8 : 21 AF 0A            	LD	HL,IM180Z
     228/     1BB : 3E 02               	LD	A,02H
     229/     1BD : 18 46               	JR	IDE
     230/     1BF :                     	;; Z8S180 (SL1960)
     231/     1BF :                     ID_1960:
     232/     1BF : 3E 00               	LD	A,CCR1_V
     233/     1C1 : ED 39 DF            	OUT0	(IOBASE+1FH),A
     234/     1C4 : 21 BA 0A            	LD	HL,IM1960
     235/     1C7 : 3E 04               	LD	A,04H
     236/     1C9 : 18 3A               	JR	IDE
     237/     1CB :                     	
     238/     1CB :                     	;; Z8S180
     239/     1CB :                     ID_Z8S:
     240/     1CB : 3E 00               	LD	A,CCR1_V
     241/     1CD : ED 39 DF            	OUT0	(IOBASE+1FH),A
     242/     1D0 : 21 CA 0A            	LD	HL,IMZ8S
     243/     1D3 : 3E 05               	LD	A,05H
     244/     1D5 : 18 2E               	JR	IDE
     245/     1D7 :                     
     246/     1D7 : ALL                 	RESTORE
     247/     1D7 :                     	;; Z280
     248/     1D7 :                     ID_280:
     249/     1D7 : 2E 30               	LD	L,BTCR_V	; Z280 specific initialization
     250/     1D9 : 0E 02               	LD	C,02H		; BTCR
     251/     1DB : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     252/     1DD : 2E 40               	LD	L,BTIR_V
     253/     1DF : 0E FF               	LD	C,0FFH		; BTIR
     254/     1E1 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     255/     1E3 : 2E 00               	LD	L,CCR_V
     256/     1E5 : 0E 12               	LD	C,12H		; CCR
     257/     1E7 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     258/     1E9 :                     
     259/     1E9 : 2E FF               	LD	L,0FFH
     260/     1EB : 0E 08               	LD	C,08H		; IOBR
     261/     1ED : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     262/     1EF : 3E 38               	LD	A,RRR_V
     263/     1F1 : D3 E8               	OUT	(0E8H),A	; RRR
     264/     1F3 : 2E 00               	LD	L,00H
     265/     1F5 : 0E 08               	LD	C,08H
     266/     1F7 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
     267/     1F9 :                     
     268/     1F9 : 21 D3 0A            	LD	HL,IM280
     269/     1FC : 3E 08               	LD	A,08H
     270/     1FE : 18 05               	JR	IDE
     271/     200 :                     	;; NSC800
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 8 - 7/9/2023 8:51:44


     272/     200 :                     ID_NSC:	
     273/     200 : 21 DA 0A            	LD	HL,IMNSC
     274/     203 : 3E 09               	LD	A,09H
     275/     205 :                     IDE:
     276/     205 : 32 1B FF            	LD	(PSPEC),A
     277/     208 : 22 00 FF            	LD	(INBUF),HL
     278/     20B : [175]               	ENDIF			; USE_IDENT
     279/     20B :                     
     280/     20B : CD 06 0D            	CALL    INIT
     281/     20E :                     
     282/     20E : 21 00 80            	LD	HL,8000H
     283/     211 : 22 10 FF            	LD	(DSADDR),HL
     284/     214 : 22 17 FF            	LD	(SADDR),HL
     285/     217 : 22 15 FF            	LD	(GADDR),HL
     286/     21A : 3E 49               	LD	A,'I'
     287/     21C : 32 19 FF            	LD	(HEXMOD),A
     288/     21F : AF                  	XOR	A
     289/     220 : 32 1D FF            	LD	(IOPAGE),A
     290/     223 :                     
     291/     223 : =>TRUE              	IF USE_REGCMD
     292/     223 :                     
     293/     223 :                     	;; Initialize register value
     294/     223 : AF                  	XOR	A
     295/     224 : 21 1E FF            	LD	HL,REG_B
     296/     227 : 06 1A               	LD	B,REG_E-REG_B
     297/     229 :                     IR0:
     298/     229 : 77                  	LD	(HL),A
     299/     22A : 23                  	INC	HL
     300/     22B : 10 FC               	DJNZ	IR0
     301/     22D :                     
     302/     22D : 21 00 00            	LD	HL,STACK
     303/     230 : 22 32 FF            	LD	(REGSP),HL
     304/     233 :                     
     305/     233 : [291]               	ENDIF
     306/     233 :                     
     307/     233 : 06 64               	LD	B,100
     308/     235 :                     TL:	
     309/     235 : AF                  	XOR	A
     310/     236 : CD 46 0D            	CALL	CONOUT
     311/     239 : 10 FA               	DJNZ	TL
     312/     23B :                     	
     313/     23B :                     	;; Opening message
     314/     23B : 21 3D 0A            	LD	HL,OPNMSG
     315/     23E : CD 4F 08            	CALL	STROUT
     316/     241 :                     
     317/     241 : =>TRUE              	IF USE_IDENT
     318/     241 : 2A 00 FF            	LD	HL,(INBUF)
     319/     244 : CD 4F 08            	CALL	STROUT
     320/     247 : [317]               	ENDIF
     321/     247 :                     
     322/     247 : =>TRUE              	IF USE_RAMCHK
     323/     247 : 21 00 80            	LD	HL,RAM_B
     324/     24A : CD 58 08            	CALL	HEXOUT4
     325/     24D : 3E 2D               	LD	A,'-'
     326/     24F : CD 46 0D            	CALL	CONOUT
     327/     252 : 2A 38 FF            	LD	HL,(RAMEND)
     328/     255 : 2B                  	DEC	HL
     329/     256 : CD 58 08            	CALL	HEXOUT4
     330/     259 : CD 9B 08            	CALL	CRLF
     331/     25C : [322]               	ENDIF
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 9 - 7/9/2023 8:51:44


     332/     25C :                     
     333/     25C :                     WSTART:
     334/     25C : 21 57 0A            	LD	HL,PROMPT
     335/     25F : CD 4F 08            	CALL	STROUT
     336/     262 : CD A5 08            	CALL	GETLIN
     337/     265 : 21 00 FF            	LD	HL,INBUF
     338/     268 : CD F1 08            	CALL	SKIPSP
     339/     26B : CD F8 08            	CALL	UPPER
     340/     26E : B7                  	OR	A
     341/     26F : 28 EB               	JR	Z,WSTART
     342/     271 :                     
     343/     271 : FE 44               	CP	'D'
     344/     273 : 28 30               	JR	Z,DUMP
     345/     275 : FE 47               	CP	'G'
     346/     277 : CA AB 03            	JP	Z,GO
     347/     27A : FE 53               	CP	'S'
     348/     27C : CA 22 04            	JP	Z,SETM
     349/     27F :                     
     350/     27F : FE 4C               	CP	'L'
     351/     281 : CA 89 04            	JP	Z,LOADH
     352/     284 : FE 50               	CP	'P'
     353/     286 : CA 5A 05            	JP	Z,SAVEH
     354/     289 :                     
     355/     289 : FE 49               	CP	'I'
     356/     28B : CA 37 06            	JP	Z,PIN
     357/     28E : FE 4F               	CP	'O'
     358/     290 : CA C9 06            	JP	Z,POUT
     359/     293 : FE 5A               	CP	'Z'
     360/     295 : CA 61 07            	JP	Z,PBANK
     361/     298 :                     
     362/     298 : =>TRUE              	IF USE_REGCMD
     363/     298 : FE 52               	CP	'R'
     364/     29A : CA 8F 07            	JP	Z,REG
     365/     29D : [362]               	ENDIF
     366/     29D :                     
     367/     29D :                     ERR:
     368/     29D : 21 74 0A            	LD	HL,ERRMSG
     369/     2A0 : CD 4F 08            	CALL	STROUT
     370/     2A3 : 18 B7               	JR	WSTART
     371/     2A5 :                     
     372/     2A5 :                     ;;; 
     373/     2A5 :                     ;;; Dump memory
     374/     2A5 :                     ;;; 
     375/     2A5 :                     
     376/     2A5 :                     DUMP:
     377/     2A5 : 23                  	INC	HL
     378/     2A6 : CD F1 08            	CALL	SKIPSP
     379/     2A9 : CD 01 09            	CALL	RDHEX		; 1st arg.
     380/     2AC : 79                  	LD	A,C
     381/     2AD : B7                  	OR	A
     382/     2AE : 20 13               	JR	NZ,DP0
     383/     2B0 :                     	;; No arg.
     384/     2B0 : CD F1 08            	CALL	SKIPSP
     385/     2B3 : 7E                  	LD	A,(HL)
     386/     2B4 : B7                  	OR	A
     387/     2B5 : 20 E6               	JR	NZ,ERR
     388/     2B7 : 2A 10 FF            	LD	HL,(DSADDR)
     389/     2BA : 01 80 00            	LD	BC,128
     390/     2BD : 09                  	ADD	HL,BC
     391/     2BE : 22 12 FF            	LD	(DEADDR),HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 10 - 7/9/2023 8:51:44


     392/     2C1 : 18 30               	JR	DPM
     393/     2C3 :                     
     394/     2C3 :                     	;; 1st arg. found
     395/     2C3 :                     DP0:
     396/     2C3 : ED 53 10 FF         	LD	(DSADDR),DE
     397/     2C7 : CD F1 08            	CALL	SKIPSP
     398/     2CA : 7E                  	LD	A,(HL)
     399/     2CB : FE 2C               	CP	','
     400/     2CD : 28 0C               	JR	Z,DP1
     401/     2CF : B7                  	OR	A
     402/     2D0 : 20 CB               	JR	NZ,ERR
     403/     2D2 :                     	;; No 2nd arg.
     404/     2D2 : 21 80 00            	LD	HL,128
     405/     2D5 : 19                  	ADD	HL,DE
     406/     2D6 : 22 12 FF            	LD	(DEADDR),HL
     407/     2D9 : 18 18               	JR	DPM
     408/     2DB :                     DP1:
     409/     2DB : 23                  	INC	HL
     410/     2DC : CD F1 08            	CALL	SKIPSP
     411/     2DF : CD 01 09            	CALL	RDHEX
     412/     2E2 : CD F1 08            	CALL	SKIPSP
     413/     2E5 : 79                  	LD	A,C
     414/     2E6 : B7                  	OR	A
     415/     2E7 : 28 B4               	JR	Z,ERR
     416/     2E9 : 7E                  	LD	A,(HL)
     417/     2EA : B7                  	OR	A
     418/     2EB : C2 9D 02            	JP	NZ,ERR
     419/     2EE : 13                  	INC	DE
     420/     2EF : ED 53 12 FF         	LD	(DEADDR),DE
     421/     2F3 :                     DPM:
     422/     2F3 :                     	;; DUMP main
     423/     2F3 : 2A 10 FF            	LD	HL,(DSADDR)
     424/     2F6 : 3E F0               	LD	A,0F0H
     425/     2F8 : A5                  	AND	A,L
     426/     2F9 : 6F                  	LD	L,A
     427/     2FA : AF                  	XOR	A
     428/     2FB : 32 14 FF            	LD	(DSTATE),A
     429/     2FE :                     DPM0:
     430/     2FE : E5                  	PUSH	HL
     431/     2FF : CD 25 03            	CALL	DPL
     432/     302 : E1                  	POP	HL
     433/     303 : 01 10 00            	LD	BC,16
     434/     306 : 09                  	ADD	HL,BC
     435/     307 : CD 41 0D            	CALL	CONST
     436/     30A : 20 10               	JR	NZ,DPM1
     437/     30C : 3A 14 FF            	LD	A,(DSTATE)
     438/     30F : FE 02               	CP	2
     439/     311 : 38 EB               	JR	C,DPM0
     440/     313 : 2A 12 FF            	LD	HL,(DEADDR)
     441/     316 : 22 10 FF            	LD	(DSADDR),HL
     442/     319 : C3 5C 02            	JP	WSTART
     443/     31C :                     DPM1:
     444/     31C : 22 10 FF            	LD	(DSADDR),HL
     445/     31F : CD 38 0D            	CALL	CONIN
     446/     322 : C3 5C 02            	JP	WSTART
     447/     325 :                     
     448/     325 :                     DPL:
     449/     325 :                     	;; DUMP line
     450/     325 : CD 58 08            	CALL	HEXOUT4
     451/     328 : E5                  	PUSH	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 11 - 7/9/2023 8:51:44


     452/     329 : 21 7C 0A            	LD	HL,DSEP0
     453/     32C : CD 4F 08            	CALL	STROUT
     454/     32F : E1                  	POP	HL
     455/     330 : DD 21 00 FF         	LD	IX,INBUF
     456/     334 : 06 10               	LD	B,16
     457/     336 :                     DPL0:
     458/     336 : CD 5F 03            	CALL	DPB
     459/     339 : 10 FB               	DJNZ	DPL0
     460/     33B :                     
     461/     33B : 21 7F 0A            	LD	HL,DSEP1
     462/     33E : CD 4F 08            	CALL	STROUT
     463/     341 :                     
     464/     341 : 21 00 FF            	LD	HL,INBUF
     465/     344 : 06 10               	LD	B,16
     466/     346 :                     DPL1:
     467/     346 : 7E                  	LD	A,(HL)
     468/     347 : 23                  	INC	HL
     469/     348 : FE 20               	CP	' '
     470/     34A : 38 09               	JR	C,DPL2
     471/     34C : FE 7F               	CP	7FH
     472/     34E : 30 05               	JR	NC,DPL2
     473/     350 : CD 46 0D            	CALL	CONOUT
     474/     353 : 18 05               	JR	DPL3
     475/     355 :                     DPL2:
     476/     355 : 3E 2E               	LD	A,'.'
     477/     357 : CD 46 0D            	CALL	CONOUT
     478/     35A :                     DPL3:
     479/     35A : 10 EA               	DJNZ	DPL1
     480/     35C : C3 9B 08            	JP	CRLF
     481/     35F :                     
     482/     35F :                     DPB:	; Dump byte
     483/     35F : 3E 20               	LD	A,' '
     484/     361 : CD 46 0D            	CALL	CONOUT
     485/     364 : 3A 14 FF            	LD	A,(DSTATE)
     486/     367 : B7                  	OR	A
     487/     368 : 20 20               	JR	NZ,DPB2
     488/     36A :                     	; Dump state 0
     489/     36A : 3A 10 FF            	LD	A,(DSADDR)	; Low byte
     490/     36D : BD                  	CP	L
     491/     36E : 20 06               	JR	NZ,DPB0
     492/     370 : 3A 11 FF            	LD	A,(DSADDR+1)	; High byte
     493/     373 : BC                  	CP	H
     494/     374 : 28 0F               	JR	Z,DPB1
     495/     376 :                     DPB0:	; Still 0 or 2
     496/     376 : 3E 20               	LD	A,' '
     497/     378 : CD 46 0D            	CALL	CONOUT
     498/     37B : CD 46 0D            	CALL	CONOUT
     499/     37E : DD 77 00            	LD	(IX),A
     500/     381 : 23                  	INC	HL
     501/     382 : DD 23               	INC	IX
     502/     384 : C9                  	RET
     503/     385 :                     DPB1:	; Found start address
     504/     385 : 3E 01               	LD	A,1
     505/     387 : 32 14 FF            	LD	(DSTATE),A
     506/     38A :                     DPB2:
     507/     38A : 3A 14 FF            	LD	A,(DSTATE)
     508/     38D : FE 01               	CP	1
     509/     38F : 20 E5               	JR	NZ,DPB0
     510/     391 :                     	; Dump state 1
     511/     391 : 7E                  	LD	A,(HL)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 12 - 7/9/2023 8:51:44


     512/     392 : DD 77 00            	LD	(IX),A
     513/     395 : CD 5D 08            	CALL	HEXOUT2
     514/     398 : 23                  	INC	HL
     515/     399 : DD 23               	INC	IX
     516/     39B : 3A 12 FF            	LD	A,(DEADDR)	; Low byte
     517/     39E : BD                  	CP	L
     518/     39F : C0                  	RET	NZ
     519/     3A0 : 3A 13 FF            	LD	A,(DEADDR+1)	; High byte
     520/     3A3 : BC                  	CP	H
     521/     3A4 : C0                  	RET	NZ
     522/     3A5 :                     	; Found end address
     523/     3A5 : 3E 02               	LD	A,2
     524/     3A7 : 32 14 FF            	LD	(DSTATE),A
     525/     3AA : C9                  	RET
     526/     3AB :                     
     527/     3AB :                     ;;;
     528/     3AB :                     ;;; GO address
     529/     3AB :                     ;;; 
     530/     3AB :                     
     531/     3AB :                     GO:
     532/     3AB : 23                  	INC	HL
     533/     3AC : CD F1 08            	CALL	SKIPSP
     534/     3AF : CD 01 09            	CALL	RDHEX
     535/     3B2 : 7E                  	LD	A,(HL)
     536/     3B3 : B7                  	OR	A
     537/     3B4 : C2 9D 02            	JP	NZ,ERR
     538/     3B7 : 79                  	LD	A,C
     539/     3B8 : B7                  	OR	A
     540/     3B9 : 28 04               	JR	Z,G0
     541/     3BB :                     
     542/     3BB : =>TRUE              	IF USE_REGCMD
     543/     3BB :                     
     544/     3BB : ED 53 34 FF         	LD	(REGPC),DE
     545/     3BF :                     G0:
     546/     3BF :                     	;; R register adjustment
     547/     3BF : =>TRUE              	IF USE_IDENT
     548/     3BF : 3A 1B FF            	LD	A,(PSPEC)
     549/     3C2 : FE 08               	CP	08H		; Z280
     550/     3C4 : 28 1F               	JR	Z,G1
     551/     3C6 : FE 09               	CP	09H		; NSC800
     552/     3C8 : 28 13               	JR	Z,G01
     553/     3CA : 3A 37 FF            	LD	A,(REGR)
     554/     3CD : D6 02               	SUB	02H
     555/     3CF : E6 7F               	AND	7FH
     556/     3D1 : 47                  	LD	B,A
     557/     3D2 : 3A 37 FF            	LD	A,(REGR)
     558/     3D5 : E6 80               	AND	80H
     559/     3D7 : B0                  	OR	B
     560/     3D8 : 32 37 FF            	LD	(REGR),A
     561/     3DB : 18 08               	JR	G1
     562/     3DD :                     G01:
     563/     3DD : 3A 37 FF            	LD	A,(REGR)
     564/     3E0 : D6 02               	SUB	02H
     565/     3E2 : 32 37 FF            	LD	(REGR),A
     566/     3E5 :                     G1:
     567/     3E5 : [547]               	ENDIF
     568/     3E5 :                     	
     569/     3E5 : 2A 32 FF            	LD	HL,(REGSP)
     570/     3E8 : F9                  	LD	SP,HL
     571/     3E9 : 2A 34 FF            	LD	HL,(REGPC)
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 13 - 7/9/2023 8:51:44


     572/     3EC : E5                  	PUSH	HL
     573/     3ED : DD 2A 2E FF         	LD	IX,(REGIX)
     574/     3F1 : FD 2A 30 FF         	LD	IY,(REGIY)
     575/     3F5 : 2A 26 FF            	LD	HL,(REGAFX)
     576/     3F8 : E5                  	PUSH	HL
     577/     3F9 : ED 4B 28 FF         	LD	BC,(REGBCX)
     578/     3FD : ED 5B 2A FF         	LD	DE,(REGDEX)
     579/     401 : 2A 2C FF            	LD	HL,(REGHLX)
     580/     404 : D9                  	EXX
     581/     405 : F1                  	POP	AF
     582/     406 : 08                  	EX	AF,AF'
     583/     407 : 2A 1E FF            	LD	HL,(REGAF)
     584/     40A : E5                  	PUSH	HL
     585/     40B : ED 4B 20 FF         	LD	BC,(REGBC)
     586/     40F : ED 5B 22 FF         	LD	DE,(REGDE)
     587/     413 : 2A 24 FF            	LD	HL,(REGHL)
     588/     416 : 3A 36 FF            	LD	A,(REGI)
     589/     419 : ED 47               	LD	I,A
     590/     41B : 3A 37 FF            	LD	A,(REGR)
     591/     41E : ED 4F               	LD	R,A
     592/     420 : F1                  	POP	AF
     593/     421 : C9                  	RET			; POP PC
     594/     422 :                     
     595/     422 : =>FALSE             	ELSE
     596/     422 :                     	
     597/     422 :                     	LD	(GADDR),DE
     598/     422 :                     G0:
     599/     422 :                     	LD	HL,(GADDR)
     600/     422 :                     	JP	(HL)
     601/     422 :                     
     602/     422 : [542]               	ENDIF
     603/     422 :                     
     604/     422 :                     ;;;
     605/     422 :                     ;;; SET memory
     606/     422 :                     ;;; 
     607/     422 :                     
     608/     422 :                     SETM:
     609/     422 : 23                  	INC	HL
     610/     423 : CD F1 08            	CALL	SKIPSP
     611/     426 : CD 01 09            	CALL	RDHEX
     612/     429 : CD F1 08            	CALL	SKIPSP
     613/     42C : 7E                  	LD	A,(HL)
     614/     42D : B7                  	OR	A
     615/     42E : C2 9D 02            	JP	NZ,ERR
     616/     431 : 79                  	LD	A,C
     617/     432 : B7                  	OR	A
     618/     433 : 20 04               	JR	NZ,SM0
     619/     435 : ED 5B 17 FF         	LD	DE,(SADDR)
     620/     439 :                     SM0:
     621/     439 : EB                  	EX	DE,HL
     622/     43A :                     SM1:
     623/     43A : CD 58 08            	CALL	HEXOUT4
     624/     43D : E5                  	PUSH	HL
     625/     43E : 21 7F 0A            	LD	HL,DSEP1
     626/     441 : CD 4F 08            	CALL	STROUT
     627/     444 : E1                  	POP	HL
     628/     445 : 7E                  	LD	A,(HL)
     629/     446 : E5                  	PUSH	HL
     630/     447 : CD 5D 08            	CALL	HEXOUT2
     631/     44A : 3E 20               	LD	A,' '
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 14 - 7/9/2023 8:51:44


     632/     44C : CD 46 0D            	CALL	CONOUT
     633/     44F : CD A5 08            	CALL	GETLIN
     634/     452 : 21 00 FF            	LD	HL,INBUF
     635/     455 : CD F1 08            	CALL	SKIPSP
     636/     458 : 7E                  	LD	A,(HL)
     637/     459 : B7                  	OR	A
     638/     45A : 20 07               	JR	NZ,SM2
     639/     45C :                     	;; Empty  (Increment address)
     640/     45C : E1                  	POP	HL
     641/     45D : 23                  	INC	HL
     642/     45E : 22 17 FF            	LD	(SADDR),HL
     643/     461 : 18 D7               	JR	SM1
     644/     463 :                     SM2:
     645/     463 : FE 2D               	CP	'-'
     646/     465 : 20 07               	JR	NZ,SM3
     647/     467 :                     	;; '-'  (Decrement address)
     648/     467 : E1                  	POP	HL
     649/     468 : 2B                  	DEC	HL
     650/     469 : 22 17 FF            	LD	(SADDR),HL
     651/     46C : 18 CC               	JR	SM1
     652/     46E :                     SM3:
     653/     46E : FE 2E               	CP	'.'
     654/     470 : 20 07               	JR	NZ,SM4
     655/     472 : E1                  	POP	HL
     656/     473 : 22 17 FF            	LD	(SADDR),HL
     657/     476 : C3 5C 02            	JP	WSTART
     658/     479 :                     SM4:
     659/     479 : CD 01 09            	CALL	RDHEX
     660/     47C : 79                  	LD	A,C
     661/     47D : B7                  	OR	A
     662/     47E : E1                  	POP	HL
     663/     47F : CA 9D 02            	JP	Z,ERR
     664/     482 : 73                  	LD	(HL),E
     665/     483 : 23                  	INC	HL
     666/     484 : 22 17 FF            	LD	(SADDR),HL
     667/     487 : 18 B1               	JR	SM1
     668/     489 :                     
     669/     489 :                     ;;;
     670/     489 :                     ;;; LOAD HEX file
     671/     489 :                     ;;;
     672/     489 :                     
     673/     489 :                     LOADH:
     674/     489 : 23                  	INC	HL
     675/     48A : CD F1 08            	CALL	SKIPSP
     676/     48D : CD 01 09            	CALL	RDHEX
     677/     490 : CD F1 08            	CALL	SKIPSP
     678/     493 : 7E                  	LD	A,(HL)
     679/     494 : B7                  	OR	A
     680/     495 : C2 9D 02            	JP	NZ,ERR
     681/     498 :                     
     682/     498 : 79                  	LD	A,C
     683/     499 : B7                  	OR	A
     684/     49A : 20 03               	JR	NZ,LH0
     685/     49C :                     
     686/     49C : 11 00 00            	LD	DE,0		;Offset
     687/     49F :                     LH0:
     688/     49F : CD 38 0D            	CALL	CONIN
     689/     4A2 : CD F8 08            	CALL	UPPER
     690/     4A5 : FE 53               	CP	'S'
     691/     4A7 : 28 5C               	JR	Z,LHS0
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 15 - 7/9/2023 8:51:44


     692/     4A9 :                     LH1:
     693/     4A9 : FE 3A               	CP	':'
     694/     4AB : 28 0D               	JR	Z,LHI0
     695/     4AD :                     LH2:
     696/     4AD :                     	;; Skip to EOL
     697/     4AD : FE 0D               	CP	CR
     698/     4AF : 28 EE               	JR	Z,LH0
     699/     4B1 : FE 0A               	CP	LF
     700/     4B3 : 28 EA               	JR	Z,LH0
     701/     4B5 :                     LH3:
     702/     4B5 : CD 38 0D            	CALL	CONIN
     703/     4B8 : 18 F3               	JR	LH2
     704/     4BA :                     
     705/     4BA :                     LHI0:
     706/     4BA : CD 74 08            	CALL	HEXIN
     707/     4BD : 4F                  	LD	C,A		; Checksum
     708/     4BE : 47                  	LD	B,A		; Length
     709/     4BF :                     
     710/     4BF : CD 74 08            	CALL	HEXIN
     711/     4C2 : 67                  	LD	H,A		; Address H
     712/     4C3 : 81                  	ADD	A,C
     713/     4C4 : 4F                  	LD	C,A
     714/     4C5 :                     
     715/     4C5 : CD 74 08            	CALL	HEXIN
     716/     4C8 : 6F                  	LD	L,A		; Address L
     717/     4C9 : 81                  	ADD	A,C
     718/     4CA : 4F                  	LD	C,A
     719/     4CB :                     
     720/     4CB :                     	;; Add offset
     721/     4CB : 19                  	ADD	HL,DE
     722/     4CC :                     
     723/     4CC : CD 74 08            	CALL	HEXIN
     724/     4CF : 32 1A FF            	LD	(RECTYP),A
     725/     4D2 : 81                  	ADD	A,C
     726/     4D3 : 4F                  	LD	C,A		; Checksum
     727/     4D4 :                     
     728/     4D4 : 78                  	LD	A,B
     729/     4D5 : B7                  	OR	A
     730/     4D6 : 28 14               	JR	Z,LHI3
     731/     4D8 :                     LHI1:
     732/     4D8 : CD 74 08            	CALL	HEXIN
     733/     4DB : F5                  	PUSH	AF
     734/     4DC : 81                  	ADD	A,C
     735/     4DD : 4F                  	LD	C,A		; Checksum
     736/     4DE :                     
     737/     4DE : 3A 1A FF            	LD	A,(RECTYP)
     738/     4E1 : B7                  	OR	A
     739/     4E2 : 20 05               	JR	NZ,LHI20
     740/     4E4 :                     
     741/     4E4 : F1                  	POP	AF
     742/     4E5 : 77                  	LD	(HL),A
     743/     4E6 : 23                  	INC	HL
     744/     4E7 : 18 01               	JR	LHI2
     745/     4E9 :                     LHI20:
     746/     4E9 : F1                  	POP	AF
     747/     4EA :                     LHI2:
     748/     4EA : 10 EC               	DJNZ	LHI1
     749/     4EC :                     LHI3:
     750/     4EC : CD 74 08            	CALL	HEXIN
     751/     4EF : 81                  	ADD	A,C
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 16 - 7/9/2023 8:51:44


     752/     4F0 : 20 0A               	JR	NZ,LHIE		; Checksum error
     753/     4F2 : 3A 1A FF            	LD	A,(RECTYP)
     754/     4F5 : B7                  	OR	A
     755/     4F6 : CA B5 04            	JP	Z,LH3
     756/     4F9 : C3 5C 02            	JP	WSTART
     757/     4FC :                     LHIE:
     758/     4FC : 21 5A 0A            	LD	HL,IHEMSG
     759/     4FF : CD 4F 08            	CALL	STROUT
     760/     502 : C3 5C 02            	JP	WSTART
     761/     505 :                     	
     762/     505 :                     LHS0:
     763/     505 : CD 38 0D            	CALL	CONIN
     764/     508 : 32 1A FF            	LD	(RECTYP),A
     765/     50B :                     
     766/     50B : CD 74 08            	CALL	HEXIN
     767/     50E : 47                  	LD	B,A		; Length+3
     768/     50F : 4F                  	LD	C,A		; Checksum
     769/     510 :                     
     770/     510 : CD 74 08            	CALL	HEXIN
     771/     513 : 67                  	LD	H,A
     772/     514 : 81                  	ADD	A,C
     773/     515 : 4F                  	LD	C,A
     774/     516 :                     	
     775/     516 : CD 74 08            	CALL	HEXIN
     776/     519 : 6F                  	LD	L,A
     777/     51A : 81                  	ADD	A,C
     778/     51B : 4F                  	LD	C,A
     779/     51C :                     
     780/     51C : 19                  	ADD	HL,DE
     781/     51D :                     
     782/     51D : 05                  	DEC	B
     783/     51E : 05                  	DEC	B
     784/     51F : 05                  	DEC	B
     785/     520 : 28 15               	JR	Z,LHS3
     786/     522 :                     LHS1:
     787/     522 : CD 74 08            	CALL	HEXIN
     788/     525 : F5                  	PUSH	AF
     789/     526 : 81                  	ADD	A,C
     790/     527 : 4F                  	LD	C,A		; Checksum
     791/     528 :                     
     792/     528 : 3A 1A FF            	LD	A,(RECTYP)
     793/     52B : FE 31               	CP	'1'
     794/     52D : 20 05               	JR	NZ,LHS2
     795/     52F :                     
     796/     52F : F1                  	POP	AF
     797/     530 : 77                  	LD	(HL),A
     798/     531 : 23                  	INC	HL
     799/     532 : 18 01               	JR	LHS20
     800/     534 :                     LHS2:
     801/     534 : F1                  	POP	AF
     802/     535 :                     LHS20:
     803/     535 : 10 EB               	DJNZ	LHS1
     804/     537 :                     LHS3:
     805/     537 : CD 74 08            	CALL	HEXIN
     806/     53A : 81                  	ADD	A,C
     807/     53B : FE FF               	CP	0FFH
     808/     53D : 20 12               	JR	NZ,LHSE
     809/     53F :                     
     810/     53F : 3A 1A FF            	LD	A,(RECTYP)
     811/     542 : FE 37               	CP	'7'
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 17 - 7/9/2023 8:51:44


     812/     544 : 28 11               	JR	Z,LHSR
     813/     546 : FE 38               	CP	'8'
     814/     548 : 28 0D               	JR	Z,LHSR
     815/     54A : FE 39               	CP	'9'
     816/     54C : 28 09               	JR	Z,LHSR
     817/     54E : C3 B5 04            	JP	LH3
     818/     551 :                     LHSE:
     819/     551 : 21 67 0A            	LD	HL,SHEMSG
     820/     554 : CD 4F 08            	CALL	STROUT
     821/     557 :                     LHSR:
     822/     557 : C3 5C 02            	JP	WSTART
     823/     55A :                     	
     824/     55A :                     ;;;
     825/     55A :                     ;;; SAVE HEX file
     826/     55A :                     ;;;
     827/     55A :                     
     828/     55A :                     SAVEH:
     829/     55A : 23                  	INC	HL
     830/     55B : 7E                  	LD	A,(HL)
     831/     55C : CD F8 08            	CALL	UPPER
     832/     55F : FE 49               	CP	'I'
     833/     561 : 28 04               	JR	Z,SH0
     834/     563 : FE 53               	CP	'S'
     835/     565 : 20 04               	JR	NZ,SH1
     836/     567 :                     SH0:
     837/     567 : 23                  	INC	HL
     838/     568 : 32 19 FF            	LD	(HEXMOD),A
     839/     56B :                     SH1:
     840/     56B : CD F1 08            	CALL	SKIPSP
     841/     56E : CD 01 09            	CALL	RDHEX
     842/     571 : 79                  	LD	A,C
     843/     572 : B7                  	OR	A
     844/     573 : 28 1D               	JR	Z,SHE
     845/     575 : D5                  	PUSH	DE
     846/     576 : DD E1               	POP	IX		; IX = Start address
     847/     578 : CD F1 08            	CALL	SKIPSP
     848/     57B : 7E                  	LD	A,(HL)
     849/     57C : FE 2C               	CP	','
     850/     57E : 20 12               	JR	NZ,SHE
     851/     580 : 23                  	INC	HL
     852/     581 : CD F1 08            	CALL	SKIPSP
     853/     584 : CD 01 09            	CALL	RDHEX		; DE = End address
     854/     587 : 79                  	LD	A,C
     855/     588 : B7                  	OR	A
     856/     589 : 28 07               	JR	Z,SHE
     857/     58B : CD F1 08            	CALL	SKIPSP
     858/     58E : 7E                  	LD	A,(HL)
     859/     58F : B7                  	OR	A
     860/     590 : 28 03               	JR	Z,SH2
     861/     592 :                     SHE:
     862/     592 : C3 9D 02            	JP	ERR
     863/     595 :                     
     864/     595 :                     SH2:
     865/     595 : DD E5               	PUSH	IX
     866/     597 : E1                  	POP	HL
     867/     598 : EB                  	EX	DE,HL
     868/     599 : 23                  	INC	HL
     869/     59A : B7                  	OR	A
     870/     59B : ED 52               	SBC	HL,DE		; HL = Length
     871/     59D :                     SH3:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 18 - 7/9/2023 8:51:44


     872/     59D : CD BD 05            	CALL	SHL
     873/     5A0 : 7C                  	LD	A,H
     874/     5A1 : B5                  	OR	L
     875/     5A2 : 20 F9               	JR	NZ,SH3
     876/     5A4 :                     
     877/     5A4 : 3A 19 FF            	LD	A,(HEXMOD)
     878/     5A7 : FE 49               	CP	'I'
     879/     5A9 : 20 09               	JR	NZ,SH4
     880/     5AB :                     	;; End record for Intel HEX
     881/     5AB : 21 83 0A            	LD	HL,IHEXER
     882/     5AE : CD 4F 08            	CALL	STROUT
     883/     5B1 : C3 5C 02            	JP	WSTART
     884/     5B4 :                     SH4:
     885/     5B4 :                     	;; End record for Motorola S record
     886/     5B4 : 21 91 0A            	LD	HL,SRECER
     887/     5B7 : CD 4F 08            	CALL	STROUT
     888/     5BA : C3 5C 02            	JP	WSTART
     889/     5BD :                     
     890/     5BD :                     SHL:
     891/     5BD : 0E 10               	LD	C,16
     892/     5BF : 7C                  	LD	A,H
     893/     5C0 : B7                  	OR	A
     894/     5C1 : 20 05               	JR	NZ,SHL0
     895/     5C3 : 7D                  	LD	A,L
     896/     5C4 : B9                  	CP	C
     897/     5C5 : 30 01               	JR	NC,SHL0
     898/     5C7 : 4F                  	LD	C,A
     899/     5C8 :                     SHL0:
     900/     5C8 : 06 00               	LD	B,0
     901/     5CA : B7                  	OR	A
     902/     5CB : ED 42               	SBC	HL,BC
     903/     5CD : 41                  	LD	B,C
     904/     5CE :                     
     905/     5CE : 3A 19 FF            	LD	A,(HEXMOD)
     906/     5D1 : FE 49               	CP	'I'
     907/     5D3 : 20 30               	JR	NZ,SHLS
     908/     5D5 :                     
     909/     5D5 :                     	;; Intel HEX
     910/     5D5 : 3E 3A               	LD	A,':'
     911/     5D7 : CD 46 0D            	CALL	CONOUT
     912/     5DA :                     
     913/     5DA : 78                  	LD	A,B
     914/     5DB : CD 5D 08            	CALL	HEXOUT2		; Length
     915/     5DE : 48                  	LD	C,B		; Checksum
     916/     5DF :                     
     917/     5DF : 7A                  	LD	A,D
     918/     5E0 : CD 5D 08            	CALL	HEXOUT2
     919/     5E3 : 7A                  	LD	A,D
     920/     5E4 : 81                  	ADD	A,C
     921/     5E5 : 4F                  	LD	C,A
     922/     5E6 :                     	
     923/     5E6 : 7B                  	LD	A,E
     924/     5E7 : CD 5D 08            	CALL	HEXOUT2
     925/     5EA : 7B                  	LD	A,E
     926/     5EB : 81                  	ADD	A,C
     927/     5EC : 4F                  	LD	C,A
     928/     5ED :                     	
     929/     5ED : AF                  	XOR	A
     930/     5EE : CD 5D 08            	CALL	HEXOUT2
     931/     5F1 :                     SHLI0:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 19 - 7/9/2023 8:51:44


     932/     5F1 : 1A                  	LD	A,(DE)
     933/     5F2 : F5                  	PUSH	AF
     934/     5F3 : CD 5D 08            	CALL	HEXOUT2
     935/     5F6 : F1                  	POP	AF
     936/     5F7 : 81                  	ADD	A,C
     937/     5F8 : 4F                  	LD	C,A
     938/     5F9 :                     
     939/     5F9 : 13                  	INC	DE
     940/     5FA : 10 F5               	DJNZ	SHLI0
     941/     5FC :                     
     942/     5FC : 79                  	LD	A,C
     943/     5FD : ED 44               	NEG	A
     944/     5FF : CD 5D 08            	CALL	HEXOUT2
     945/     602 : C3 9B 08            	JP	CRLF
     946/     605 :                     
     947/     605 :                     SHLS:
     948/     605 :                     	;; Motorola S record
     949/     605 : 3E 53               	LD	A,'S'
     950/     607 : CD 46 0D            	CALL	CONOUT
     951/     60A : 3E 31               	LD	A,'1'
     952/     60C : CD 46 0D            	CALL	CONOUT
     953/     60F :                     
     954/     60F : 78                  	LD	A,B
     955/     610 : C6 03               	ADD	A,2+1		; DataLength + 2(Addr) + 1(Sum)
     956/     612 : 4F                  	LD	C,A
     957/     613 : CD 5D 08            	CALL	HEXOUT2
     958/     616 :                     
     959/     616 : 7A                  	LD	A,D
     960/     617 : CD 5D 08            	CALL	HEXOUT2
     961/     61A : 7A                  	LD	A,D
     962/     61B : 81                  	ADD	A,C
     963/     61C : 4F                  	LD	C,A
     964/     61D :                     	
     965/     61D : 7B                  	LD	A,E
     966/     61E : CD 5D 08            	CALL	HEXOUT2
     967/     621 : 7B                  	LD	A,E
     968/     622 : 81                  	ADD	A,C
     969/     623 : 4F                  	LD	C,A
     970/     624 :                     SHLS0:
     971/     624 : 1A                  	LD	A,(DE)
     972/     625 : F5                  	PUSH	AF
     973/     626 : CD 5D 08            	CALL	HEXOUT2		; Data
     974/     629 : F1                  	POP	AF
     975/     62A : 81                  	ADD	A,C
     976/     62B : 4F                  	LD	C,A
     977/     62C :                     
     978/     62C : 13                  	INC	DE
     979/     62D : 10 F5               	DJNZ	SHLS0
     980/     62F :                     
     981/     62F : 79                  	LD	A,C
     982/     630 : 2F                  	CPL
     983/     631 : CD 5D 08            	CALL	HEXOUT2
     984/     634 : C3 9B 08            	JP	CRLF
     985/     637 :                     
     986/     637 :                     ;;;
     987/     637 :                     ;;; Port in
     988/     637 :                     ;;; 
     989/     637 :                     
     990/     637 :                     PIN:
     991/     637 : 23                  	INC	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 20 - 7/9/2023 8:51:44


     992/     638 : AF                  	XOR	A
     993/     639 : 32 1C FF            	LD	(SIZE),A
     994/     63C : 3A 1B FF            	LD	A,(PSPEC)
     995/     63F : FE 08               	CP	08H		; Z280
     996/     641 : 20 10               	JR	NZ,PI1
     997/     643 : 7E                  	LD	A,(HL)
     998/     644 : CD F8 08            	CALL	UPPER
     999/     647 : FE 57               	CP	'W'
    1000/     649 : 28 04               	JR	Z,PI0
    1001/     64B : FE 53               	CP	'S'
    1002/     64D : 20 04               	JR	NZ,PI1
    1003/     64F :                     PI0:
    1004/     64F : 23                  	INC	HL
    1005/     650 : 32 1C FF            	LD	(SIZE),A
    1006/     653 :                     PI1:
    1007/     653 : CD F1 08            	CALL	SKIPSP
    1008/     656 : CD 01 09            	CALL	RDHEX
    1009/     659 : 79                  	LD	A,C
    1010/     65A : B7                  	OR	A
    1011/     65B : CA 9D 02            	JP	Z,ERR		; Port no. missing
    1012/     65E : CD F1 08            	CALL	SKIPSP
    1013/     661 : 7E                  	LD	A,(HL)
    1014/     662 : B7                  	OR	A
    1015/     663 : C2 9D 02            	JP	NZ,ERR
    1016/     666 :                     
    1017/     666 : 42                  	LD	B,D
    1018/     667 : 4B                  	LD	C,E
    1019/     668 :                     
    1020/     668 : 3A 1C FF            	LD	A,(SIZE)
    1021/     66B : FE 57               	CP	'W'
    1022/     66D : 28 32               	JR	Z,PIW
    1023/     66F : FE 53               	CP	'S'
    1024/     671 : 28 4B               	JR	Z,PIS
    1025/     673 : 3A 1B FF            	LD	A,(PSPEC)
    1026/     676 : FE 08               	CP	08H		; Z280
    1027/     678 : 28 0B               	JR	Z,PIB
    1028/     67A :                     	;; Byte
    1029/     67A : ED 78               	IN	A,(C)
    1030/     67C : CD 5D 08            	CALL	HEXOUT2
    1031/     67F : CD 9B 08            	CALL	CRLF
    1032/     682 : C3 5C 02            	JP	WSTART
    1033/     685 :                     	;; Byte (Z280 only)
    1034/     685 :                     PIB:
    1035/     685 : 0E 08               	LD	C,08		; I/O Bank register
    1036/     687 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1037/     689 : E5                  	PUSH	HL
    1038/     68A : 3A 1D FF            	LD	A,(IOPAGE)
    1039/     68D : 6F                  	LD	L,A
    1040/     68E : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1041/     690 : 4B                  	LD	C,E
    1042/     691 : ED 78               	IN	A,(C)
    1043/     693 : 0E 08               	LD	C,08H		; I/O Bank register
    1044/     695 : E1                  	POP	HL
    1045/     696 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1046/     698 : CD 5D 08            	CALL	HEXOUT2
    1047/     69B : CD 9B 08            	CALL	CRLF
    1048/     69E : C3 5C 02            	JP	WSTART
    1049/     6A1 :                     	;; Word (Z280 only)
    1050/     6A1 :                     PIW:
    1051/     6A1 : 0E 08               	LD	C,08		; I/O Bank register
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 21 - 7/9/2023 8:51:44


    1052/     6A3 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1053/     6A5 : E5                  	PUSH	HL
    1054/     6A6 : 3A 1D FF            	LD	A,(IOPAGE)
    1055/     6A9 : 6F                  	LD	L,A
    1056/     6AA : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1057/     6AC : 4B                  	LD	C,E
    1058/     6AD : ED B7               	DB	0EDH,0B7H	; IN HL,(C)
    1059/     6AF : E3                  	EX	(SP),HL
    1060/     6B0 : 0E 08               	LD	C,08H
    1061/     6B2 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1062/     6B4 : E1                  	POP	HL
    1063/     6B5 : CD 58 08            	CALL	HEXOUT4
    1064/     6B8 : CD 9B 08            	CALL	CRLF
    1065/     6BB : C3 5C 02            	JP	WSTART
    1066/     6BE :                     	;; Status (Z280 only)
    1067/     6BE :                     PIS:
    1068/     6BE : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1069/     6C0 : CD 58 08            	CALL	HEXOUT4
    1070/     6C3 : CD 9B 08            	CALL	CRLF
    1071/     6C6 : C3 5C 02            	JP	WSTART
    1072/     6C9 :                     
    1073/     6C9 :                     ;;;
    1074/     6C9 :                     ;;; Port out
    1075/     6C9 :                     ;;;
    1076/     6C9 :                     
    1077/     6C9 :                     POUT:
    1078/     6C9 : 23                  	INC	HL
    1079/     6CA : AF                  	XOR	A
    1080/     6CB : 32 1C FF            	LD	(SIZE),A
    1081/     6CE : 3A 1B FF            	LD	A,(PSPEC)
    1082/     6D1 : FE 08               	CP	08H		; Z280
    1083/     6D3 : 20 10               	JR	NZ,PO1
    1084/     6D5 : 7E                  	LD	A,(HL)
    1085/     6D6 : CD F8 08            	CALL	UPPER
    1086/     6D9 : FE 57               	CP	'W'
    1087/     6DB : 28 04               	JR	Z,PO0
    1088/     6DD : FE 53               	CP	'S'
    1089/     6DF : 20 04               	JR	NZ,PO1
    1090/     6E1 :                     PO0:
    1091/     6E1 : 23                  	INC	HL
    1092/     6E2 : 32 1C FF            	LD	(SIZE),A
    1093/     6E5 :                     PO1:
    1094/     6E5 : CD F1 08            	CALL	SKIPSP
    1095/     6E8 : CD 01 09            	CALL	RDHEX
    1096/     6EB : 79                  	LD	A,C
    1097/     6EC : B7                  	OR	A
    1098/     6ED : CA 9D 02            	JP	Z,ERR		; Port no. missing
    1099/     6F0 : D5                  	PUSH	DE
    1100/     6F1 : DD E1               	POP	IX
    1101/     6F3 : CD F1 08            	CALL	SKIPSP
    1102/     6F6 : 7E                  	LD	A,(HL)
    1103/     6F7 : FE 2C               	CP	','
    1104/     6F9 : C2 9D 02            	JP	NZ,ERR
    1105/     6FC : 23                  	INC	HL
    1106/     6FD : CD F1 08            	CALL	SKIPSP
    1107/     700 : CD 01 09            	CALL	RDHEX
    1108/     703 : 79                  	LD	A,C
    1109/     704 : B7                  	OR	A
    1110/     705 : CA 9D 02            	JP	Z,ERR		; Data missing
    1111/     708 : CD F1 08            	CALL	SKIPSP
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 22 - 7/9/2023 8:51:44


    1112/     70B : 7E                  	LD	A,(HL)
    1113/     70C : B7                  	OR	A
    1114/     70D : C2 9D 02            	JP	NZ,ERR
    1115/     710 :                     
    1116/     710 : DD E5               	PUSH	IX
    1117/     712 : C1                  	POP	BC
    1118/     713 :                     
    1119/     713 : 3A 1C FF            	LD	A,(SIZE)
    1120/     716 : FE 57               	CP	'W'
    1121/     718 : 28 27               	JR	Z,POW
    1122/     71A : FE 53               	CP	'S'
    1123/     71C : 28 3D               	JR	Z,POS
    1124/     71E : 3A 1B FF            	LD	A,(PSPEC)
    1125/     721 : FE 08               	CP	08H		; Z280
    1126/     723 : 28 05               	JR	Z,POB
    1127/     725 :                     	;; Byte
    1128/     725 : ED 59               	OUT	(C),E
    1129/     727 : C3 5C 02            	JP	WSTART
    1130/     72A :                     	;; Byte (Z280 only)
    1131/     72A :                     POB:
    1132/     72A : C5                  	PUSH	BC
    1133/     72B : 0E 08               	LD	C,08		; I/O Bank register
    1134/     72D : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1135/     72F : 55                  	LD	D,L
    1136/     730 : 3A 1D FF            	LD	A,(IOPAGE)
    1137/     733 : 6F                  	LD	L,A
    1138/     734 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1139/     736 : C1                  	POP	BC
    1140/     737 : ED 59               	OUT	(C),E
    1141/     739 : 0E 08               	LD	C,08H		; I/O Bank register
    1142/     73B : 6A                  	LD	L,D
    1143/     73C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1144/     73E : C3 5C 02            	JP	WSTART	
    1145/     741 :                     	;; Word (Z280 only)
    1146/     741 :                     POW:
    1147/     741 : DD 69               	DB	0DDH,69H	; LD IXL,C
    1148/     743 : 0E 08               	LD	C,08		; I/O Bank register
    1149/     745 : ED 66               	DB	0EDH,66H	; LDCTL HL,(C)
    1150/     747 : E5                  	PUSH	HL
    1151/     748 : 3A 1D FF            	LD	A,(IOPAGE)
    1152/     74B : 6F                  	LD	L,A
    1153/     74C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1154/     74E : DD 4D               	DB	0DDH,4DH	; LD C,IXL
    1155/     750 : EB                  	EX	DE,HL
    1156/     751 : ED BF               	DB	0EDH,0BFH	; OUT (C),HL
    1157/     753 : 0E 08               	LD	C,08H		; I/O Bank register
    1158/     755 : E1                  	POP	HL
    1159/     756 : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1160/     758 : C3 5C 02            	JP	WSTART
    1161/     75B :                     	;; Control (Z280 only)
    1162/     75B :                     POS:
    1163/     75B : EB                  	EX	DE,HL
    1164/     75C : ED 6E               	DB	0EDH,6EH	; LDCTL (C),HL
    1165/     75E : C3 5C 02            	JP	WSTART
    1166/     761 :                     
    1167/     761 :                     ;;;
    1168/     761 :                     ;;; I/O Bank
    1169/     761 :                     ;;;
    1170/     761 :                     
    1171/     761 :                     PBANK:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 23 - 7/9/2023 8:51:44


    1172/     761 : 3A 1B FF            	LD	A,(PSPEC)
    1173/     764 : FE 08               	CP	08H		; Z280
    1174/     766 : C2 9D 02            	JP	NZ,ERR
    1175/     769 : 23                  	INC	HL
    1176/     76A : CD F1 08            	CALL	SKIPSP
    1177/     76D : CD 01 09            	CALL	RDHEX
    1178/     770 : CD F1 08            	CALL	SKIPSP
    1179/     773 : 7E                  	LD	A,(HL)
    1180/     774 : B7                  	OR	A
    1181/     775 : C2 9D 02            	JP	NZ,ERR
    1182/     778 : 79                  	LD	A,C
    1183/     779 : B7                  	OR	A
    1184/     77A : 28 07               	JR	Z,PB0
    1185/     77C : 7B                  	LD	A,E
    1186/     77D : 32 1D FF            	LD	(IOPAGE),A
    1187/     780 : C3 5C 02            	JP	WSTART
    1188/     783 :                     PB0:
    1189/     783 : 3A 1D FF            	LD	A,(IOPAGE)
    1190/     786 : CD 5D 08            	CALL	HEXOUT2
    1191/     789 : CD 9B 08            	CALL	CRLF
    1192/     78C : C3 5C 02            	JP	WSTART
    1193/     78F :                     
    1194/     78F :                     ;;;
    1195/     78F :                     ;;; Register
    1196/     78F :                     ;;;
    1197/     78F :                     
    1198/     78F : =>TRUE              	IF USE_REGCMD
    1199/     78F :                     
    1200/     78F :                     REG:
    1201/     78F : 23                  	INC	HL
    1202/     790 : CD F1 08            	CALL	SKIPSP
    1203/     793 : CD F8 08            	CALL	UPPER
    1204/     796 : B7                  	OR	A
    1205/     797 : 20 06               	JR	NZ,RG0
    1206/     799 : CD 1F 08            	CALL	RDUMP
    1207/     79C : C3 5C 02            	JP	WSTART
    1208/     79F :                     RG0:
    1209/     79F : EB                  	EX	DE,HL
    1210/     7A0 : 21 9F 0B            	LD	HL,RNTAB
    1211/     7A3 :                     RG1:
    1212/     7A3 : BE                  	CP	(HL)
    1213/     7A4 : 28 0D               	JR	Z,RG2		; Character match
    1214/     7A6 : 4F                  	LD	C,A
    1215/     7A7 : 23                  	INC	HL
    1216/     7A8 : 7E                  	LD	A,(HL)
    1217/     7A9 : B7                  	OR	A
    1218/     7AA : 28 70               	JR	Z,RGE		; Found end mark
    1219/     7AC : 79                  	LD	A,C
    1220/     7AD : 01 05 00            	LD	BC,5
    1221/     7B0 : 09                  	ADD	HL,BC		; Next entry
    1222/     7B1 : 18 F0               	JR	RG1
    1223/     7B3 :                     RG2:
    1224/     7B3 : 23                  	INC	HL
    1225/     7B4 : 7E                  	LD	A,(HL)
    1226/     7B5 : FE 0F               	CP	0FH		; Link code
    1227/     7B7 : 20 0C               	JR	NZ,RG3
    1228/     7B9 :                     	;; Next table
    1229/     7B9 : 23                  	INC	HL
    1230/     7BA : 4E                  	LD	C,(HL)
    1231/     7BB : 23                  	INC	HL
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 24 - 7/9/2023 8:51:44


    1232/     7BC : 66                  	LD	H,(HL)
    1233/     7BD : 69                  	LD	L,C
    1234/     7BE : 13                  	INC	DE
    1235/     7BF : 1A                  	LD	A,(DE)
    1236/     7C0 : CD F8 08            	CALL	UPPER
    1237/     7C3 : 18 DE               	JR	RG1
    1238/     7C5 :                     RG3:
    1239/     7C5 : B7                  	OR	A
    1240/     7C6 : 28 54               	JR	Z,RGE		; Found end mark
    1241/     7C8 :                     
    1242/     7C8 : 4E                  	LD	C,(HL)		; LD C,A???
    1243/     7C9 : 23                  	INC	HL
    1244/     7CA : 5E                  	LD	E,(HL)
    1245/     7CB : 23                  	INC	HL
    1246/     7CC : 56                  	LD	D,(HL)
    1247/     7CD : D5                  	PUSH	DE		; Reg storage address
    1248/     7CE : 23                  	INC	HL
    1249/     7CF : 7E                  	LD	A,(HL)
    1250/     7D0 : 23                  	INC	HL
    1251/     7D1 : 66                  	LD	H,(HL)
    1252/     7D2 : 6F                  	LD	L,A		; HL: Reg name
    1253/     7D3 : CD 4F 08            	CALL	STROUT
    1254/     7D6 : 3E 3D               	LD	A,'='
    1255/     7D8 : CD 46 0D            	CALL	CONOUT
    1256/     7DB :                     
    1257/     7DB : 79                  	LD	A,C
    1258/     7DC : E6 07               	AND	07H
    1259/     7DE : FE 01               	CP	1
    1260/     7E0 : 20 08               	JR	NZ,RG4
    1261/     7E2 :                     	;; 8 bit register
    1262/     7E2 : E1                  	POP	HL
    1263/     7E3 : 7E                  	LD	A,(HL)
    1264/     7E4 : E5                  	PUSH	HL
    1265/     7E5 : CD 5D 08            	CALL	HEXOUT2
    1266/     7E8 : 18 0C               	JR	RG5
    1267/     7EA :                     RG4:
    1268/     7EA :                     	;; 16 bit register
    1269/     7EA : E1                  	POP	HL
    1270/     7EB : E5                  	PUSH	HL
    1271/     7EC : 23                  	INC	HL
    1272/     7ED : 7E                  	LD	A,(HL)
    1273/     7EE : CD 5D 08            	CALL	HEXOUT2
    1274/     7F1 : 2B                  	DEC	HL
    1275/     7F2 : 7E                  	LD	A,(HL)
    1276/     7F3 : CD 5D 08            	CALL	HEXOUT2
    1277/     7F6 :                     RG5:
    1278/     7F6 : 3E 20               	LD	A,' '
    1279/     7F8 : CD 46 0D            	CALL	CONOUT
    1280/     7FB : C5                  	PUSH	BC		; C: reg size
    1281/     7FC : CD A5 08            	CALL	GETLIN
    1282/     7FF : 21 00 FF            	LD	HL,INBUF
    1283/     802 : CD F1 08            	CALL	SKIPSP
    1284/     805 : CD 01 09            	CALL	RDHEX
    1285/     808 : 79                  	LD	A,C
    1286/     809 : B7                  	OR	A
    1287/     80A : 28 0D               	JR	Z,RGR
    1288/     80C : C1                  	POP	BC
    1289/     80D : E1                  	POP	HL
    1290/     80E : 79                  	LD	A,C
    1291/     80F : FE 01               	CP	1
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 25 - 7/9/2023 8:51:44


    1292/     811 : 20 03               	JR	NZ,RG6
    1293/     813 :                     	;; 8 bit register
    1294/     813 : 73                  	LD	(HL),E
    1295/     814 : 18 03               	JR	RG7
    1296/     816 :                     RG6:
    1297/     816 :                     	;; 16 bit register
    1298/     816 : 73                  	LD	(HL),E
    1299/     817 : 23                  	INC	HL
    1300/     818 : 72                  	LD	(HL),D
    1301/     819 :                     RG7:
    1302/     819 :                     RGR:
    1303/     819 : C3 5C 02            	JP	WSTART
    1304/     81C :                     RGE:
    1305/     81C : C3 9D 02            	JP	ERR
    1306/     81F :                     
    1307/     81F :                     RDUMP:
    1308/     81F : 21 F4 0A            	LD	HL,RDTAB
    1309/     822 :                     RD0:
    1310/     822 : 5E                  	LD	E,(HL)
    1311/     823 : 23                  	INC	HL
    1312/     824 : 56                  	LD	D,(HL)
    1313/     825 : 23                  	INC	HL
    1314/     826 : 7A                  	LD	A,D
    1315/     827 : B3                  	OR	E
    1316/     828 : CA 9B 08            	JP	Z,CRLF		; End
    1317/     82B : EB                  	EX	DE,HL
    1318/     82C : CD 4F 08            	CALL	STROUT
    1319/     82F : EB                  	EX	DE,HL
    1320/     830 :                     
    1321/     830 : 5E                  	LD	E,(HL)
    1322/     831 : 23                  	INC	HL
    1323/     832 : 56                  	LD	D,(HL)
    1324/     833 : 23                  	INC	HL
    1325/     834 : 7E                  	LD	A,(HL)
    1326/     835 : 23                  	INC	HL
    1327/     836 : EB                  	EX	DE,HL
    1328/     837 : FE 01               	CP	1
    1329/     839 : 20 07               	JR	NZ,RD1
    1330/     83B :                     	;; 1 byte
    1331/     83B : 7E                  	LD	A,(HL)
    1332/     83C : CD 5D 08            	CALL	HEXOUT2
    1333/     83F : EB                  	EX	DE,HL
    1334/     840 : 18 E0               	JR	RD0
    1335/     842 :                     RD1:
    1336/     842 :                     	;; 2 byte
    1337/     842 : 23                  	INC	HL
    1338/     843 : 7E                  	LD	A,(HL)
    1339/     844 : CD 5D 08            	CALL	HEXOUT2		; High byte
    1340/     847 : 2B                  	DEC	HL
    1341/     848 : 7E                  	LD	A,(HL)
    1342/     849 : CD 5D 08            	CALL	HEXOUT2		; Low byte
    1343/     84C : EB                  	EX	DE,HL
    1344/     84D : 18 D3               	JR	RD0
    1345/     84F :                     
    1346/     84F : [1198]              	ENDIF
    1347/     84F :                     
    1348/     84F :                     ;;;
    1349/     84F :                     ;;; Other support routines
    1350/     84F :                     ;;;
    1351/     84F :                     
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 26 - 7/9/2023 8:51:44


    1352/     84F :                     STROUT:
    1353/     84F : 7E                  	LD	A,(HL)
    1354/     850 : A7                  	AND	A
    1355/     851 : C8                  	RET	Z
    1356/     852 : CD 46 0D            	CALL	CONOUT
    1357/     855 : 23                  	INC	HL
    1358/     856 : 18 F7               	JR	STROUT
    1359/     858 :                     
    1360/     858 :                     HEXOUT4:
    1361/     858 : 7C                  	LD	A,H
    1362/     859 : CD 5D 08            	CALL	HEXOUT2
    1363/     85C : 7D                  	LD	A,L
    1364/     85D :                     HEXOUT2:
    1365/     85D : F5                  	PUSH	AF
    1366/     85E : 1F                  	RRA
    1367/     85F : 1F                  	RRA
    1368/     860 : 1F                  	RRA
    1369/     861 : 1F                  	RRA
    1370/     862 : CD 66 08            	CALL	HEXOUT1
    1371/     865 : F1                  	POP	AF
    1372/     866 :                     HEXOUT1:
    1373/     866 : E6 0F               	AND	0FH
    1374/     868 : C6 30               	ADD	A,'0'
    1375/     86A : FE 3A               	CP	'9'+1
    1376/     86C : DA 46 0D            	JP	C,CONOUT
    1377/     86F : C6 07               	ADD	A,'A'-'9'-1
    1378/     871 : C3 46 0D            	JP	CONOUT
    1379/     874 :                     
    1380/     874 :                     HEXIN:
    1381/     874 : AF                  	XOR	A
    1382/     875 : CD 7C 08            	CALL	HI0
    1383/     878 : 07                  	RLCA
    1384/     879 : 07                  	RLCA
    1385/     87A : 07                  	RLCA
    1386/     87B : 07                  	RLCA
    1387/     87C :                     HI0:
    1388/     87C : C5                  	PUSH	BC
    1389/     87D : 4F                  	LD	C,A
    1390/     87E : CD 38 0D            	CALL	CONIN
    1391/     881 : CD F8 08            	CALL	UPPER
    1392/     884 : FE 30               	CP	'0'
    1393/     886 : 38 11               	JR	C,HIR
    1394/     888 : FE 3A               	CP	'9'+1
    1395/     88A : 38 0A               	JR	C,HI1
    1396/     88C : FE 41               	CP	'A'
    1397/     88E : 38 09               	JR	C,HIR
    1398/     890 : FE 47               	CP	'F'+1
    1399/     892 : 30 05               	JR	NC,HIR
    1400/     894 : D6 07               	SUB	A,'A'-'9'-1
    1401/     896 :                     HI1:
    1402/     896 : D6 30               	SUB	A,'0'
    1403/     898 : B1                  	OR	C
    1404/     899 :                     HIR:
    1405/     899 : C1                  	POP	BC
    1406/     89A : C9                  	RET
    1407/     89B :                     	
    1408/     89B :                     CRLF:
    1409/     89B : 3E 0D               	LD	A,CR
    1410/     89D : CD 46 0D            	CALL	CONOUT
    1411/     8A0 : 3E 0A               	LD	A,LF
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 27 - 7/9/2023 8:51:44


    1412/     8A2 : C3 46 0D            	JP	CONOUT
    1413/     8A5 :                     
    1414/     8A5 :                     GETLIN:
    1415/     8A5 : 21 00 FF            	LD	HL,INBUF
    1416/     8A8 : 06 00               	LD	B,0
    1417/     8AA :                     GL0:
    1418/     8AA : CD 38 0D            	CALL	CONIN
    1419/     8AD : FE 0D               	CP	CR
    1420/     8AF : 28 3A               	JR	Z,GLE
    1421/     8B1 : FE 0A               	CP	LF
    1422/     8B3 : 28 36               	JR	Z,GLE
    1423/     8B5 : FE 08               	CP	BS
    1424/     8B7 : 28 1B               	JR	Z,GLB
    1425/     8B9 : FE 7F               	CP	DEL
    1426/     8BB : 28 17               	JR	Z,GLB
    1427/     8BD : FE 20               	CP	' '
    1428/     8BF : 38 E9               	JR	C,GL0
    1429/     8C1 : FE 80               	CP	80H
    1430/     8C3 : 30 E5               	JR	NC,GL0
    1431/     8C5 : 4F                  	LD	C,A
    1432/     8C6 : 78                  	LD	A,B
    1433/     8C7 : FE 0F               	CP	BUFLEN-1
    1434/     8C9 : 30 DF               	JR	NC,GL0	; Too long
    1435/     8CB : 04                  	INC	B
    1436/     8CC : 79                  	LD	A,C
    1437/     8CD : CD 46 0D            	CALL	CONOUT
    1438/     8D0 : 77                  	LD	(HL),A
    1439/     8D1 : 23                  	INC	HL
    1440/     8D2 : 18 D6               	JR	GL0
    1441/     8D4 :                     GLB:
    1442/     8D4 : 78                  	LD	A,B
    1443/     8D5 : A7                  	AND	A
    1444/     8D6 : 28 D2               	JR	Z,GL0
    1445/     8D8 : 05                  	DEC	B
    1446/     8D9 : 2B                  	DEC	HL
    1447/     8DA : 3E 08               	LD	A,08H
    1448/     8DC : CD 46 0D            	CALL	CONOUT
    1449/     8DF : 3E 20               	LD	A,' '
    1450/     8E1 : CD 46 0D            	CALL	CONOUT
    1451/     8E4 : 3E 08               	LD	A,08H
    1452/     8E6 : CD 46 0D            	CALL	CONOUT
    1453/     8E9 : 18 BF               	JR	GL0
    1454/     8EB :                     GLE:
    1455/     8EB : CD 9B 08            	CALL	CRLF
    1456/     8EE : 36 00               	LD	(HL),00H
    1457/     8F0 : C9                  	RET
    1458/     8F1 :                     
    1459/     8F1 :                     SKIPSP:
    1460/     8F1 : 7E                  	LD	A,(HL)
    1461/     8F2 : FE 20               	CP	A,' '
    1462/     8F4 : C0                  	RET	NZ
    1463/     8F5 : 23                  	INC	HL
    1464/     8F6 : 18 F9               	JR	SKIPSP
    1465/     8F8 :                     
    1466/     8F8 :                     UPPER:
    1467/     8F8 : FE 61               	CP	'a'
    1468/     8FA : D8                  	RET	C
    1469/     8FB : FE 7B               	CP	'z'+1
    1470/     8FD : D0                  	RET	NC
    1471/     8FE : C6 E0               	ADD	A,'A'-'a'
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 28 - 7/9/2023 8:51:44


    1472/     900 : C9                  	RET
    1473/     901 :                     
    1474/     901 :                     RDHEX:
    1475/     901 : 0E 00               	LD	C,0
    1476/     903 : 11 00 00            	LD	DE,0
    1477/     906 :                     RH0:
    1478/     906 : 7E                  	LD	A,(HL)
    1479/     907 : CD F8 08            	CALL	UPPER
    1480/     90A : FE 30               	CP	'0'
    1481/     90C : 38 2C               	JR	C,RHE
    1482/     90E : FE 3A               	CP	'9'+1
    1483/     910 : 38 0A               	JR	C,RH1
    1484/     912 : FE 41               	CP	'A'
    1485/     914 : 38 24               	JR	C,RHE
    1486/     916 : FE 47               	CP	'F'+1
    1487/     918 : 30 20               	JR	NC,RHE
    1488/     91A : D6 07               	SUB	'A'-'9'-1
    1489/     91C :                     RH1:
    1490/     91C : D6 30               	SUB	'0'
    1491/     91E : 17                  	RLA
    1492/     91F : 17                  	RLA
    1493/     920 : 17                  	RLA
    1494/     921 : 17                  	RLA
    1495/     922 : 17                  	RLA
    1496/     923 : CB 13               	RL	E
    1497/     925 : CB 12               	RL	D
    1498/     927 : 17                  	RLA
    1499/     928 : CB 13               	RL	E
    1500/     92A : CB 12               	RL	D
    1501/     92C : 17                  	RLA
    1502/     92D : CB 13               	RL	E
    1503/     92F : CB 12               	RL	D
    1504/     931 : 17                  	RLA
    1505/     932 : CB 13               	RL	E
    1506/     934 : CB 12               	RL	D
    1507/     936 : 23                  	INC	HL
    1508/     937 : 0C                  	INC	C
    1509/     938 : 18 CC               	JR	RH0
    1510/     93A :                     RHE:
    1511/     93A : C9                  	RET
    1512/     93B :                     
    1513/     93B :                     ;;;
    1514/     93B :                     ;;; RST 30H Handler
    1515/     93B :                     ;;;
    1516/     93B :                     
    1517/     93B :                     RST30H:
    1518/     93B : =>TRUE              	IF USE_NEWAPI
    1519/     93B :                     
    1520/     93B : E5                  	PUSH	HL
    1521/     93C : C5                  	PUSH	BC
    1522/     93D : 21 4B 09            	LD	HL,APITBL
    1523/     940 : 06 00               	LD	B,0
    1524/     942 : 09                  	ADD	HL,BC
    1525/     943 : 09                  	ADD	HL,BC
    1526/     944 : 46                  	LD	B,(HL)
    1527/     945 : 23                  	INC	HL
    1528/     946 : 66                  	LD	H,(HL)
    1529/     947 : 68                  	LD	L,B
    1530/     948 : C1                  	POP	BC
    1531/     949 : E3                  	EX	(SP),HL		; Restore HL, jump address on stack top
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 29 - 7/9/2023 8:51:44


    1532/     94A : C9                  	RET
    1533/     94B :                     
    1534/     94B :                     APITBL:
    1535/     94B : 59 09               	DW	API00		; 00: CSTART
    1536/     94D : 5E 09               	DW	API01		; 01: WSTART
    1537/     94F : 46 0D               	DW	CONOUT		; 02: CONOUT
    1538/     951 : 4F 08               	DW	STROUT		; 03: STROUT
    1539/     953 : 38 0D               	DW	CONIN		; 04: CONIN
    1540/     955 : 41 0D               	DW	CONST		; 05: CONST
    1541/     957 : 62 09               	DW	API06		; 06: PSPEC
    1542/     959 :                     
    1543/     959 :                     	;; CSTART
    1544/     959 :                     API00:
    1545/     959 : E1                  	POP	HL		; Drop return address
    1546/     95A : F3                  	DI
    1547/     95B : C3 00 01            	JP	CSTART
    1548/     95E :                     
    1549/     95E :                     	;; WSTART
    1550/     95E :                     API01:
    1551/     95E : E1                  	POP	HL		; Drop return address
    1552/     95F : C3 5C 02            	JP	WSTART
    1553/     962 :                     
    1554/     962 :                     	;; PSPEC
    1555/     962 :                     API06:
    1556/     962 : 3A 1B FF            	LD	A,(PSPEC)
    1557/     965 : C9                  	RET
    1558/     966 :                     
    1559/     966 : =>FALSE             	ELSE			; USE_NEWAPI
    1560/     966 :                     
    1561/     966 :                     	RET
    1562/     966 :                     
    1563/     966 : [1518]              	ENDIF			; USE_NEWAPI
    1564/     966 :                     
    1565/     966 :                     ;;;
    1566/     966 :                     ;;; RST 38H Handler
    1567/     966 :                     ;;;
    1568/     966 :                     
    1569/     966 :                     RST38H:
    1570/     966 : =>TRUE              	IF USE_REGCMD
    1571/     966 :                     
    1572/     966 : F5                  	PUSH	AF
    1573/     967 : ED 5F               	LD	A,R
    1574/     969 : 32 37 FF            	LD	(REGR),A
    1575/     96C : ED 57               	LD	A,I
    1576/     96E : 32 36 FF            	LD	(REGI),A
    1577/     971 : 22 24 FF            	LD	(REGHL),HL
    1578/     974 : ED 53 22 FF         	LD	(REGDE),DE
    1579/     978 : ED 43 20 FF         	LD	(REGBC),BC
    1580/     97C : E1                  	POP	HL
    1581/     97D : 22 1E FF            	LD	(REGAF),HL
    1582/     980 : 08                  	EX	AF,AF'
    1583/     981 : F5                  	PUSH	AF
    1584/     982 : D9                  	EXX
    1585/     983 : 22 2C FF            	LD	(REGHLX),HL
    1586/     986 : ED 53 2A FF         	LD	(REGDEX),DE
    1587/     98A : ED 43 28 FF         	LD	(REGBCX),BC
    1588/     98E : E1                  	POP	HL
    1589/     98F : 22 26 FF            	LD	(REGAFX),HL
    1590/     992 : DD 22 2E FF         	LD	(REGIX),IX
    1591/     996 : FD 22 30 FF         	LD	(REGIY),IY
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 30 - 7/9/2023 8:51:44


    1592/     99A : E1                  	POP	HL
    1593/     99B : 2B                  	DEC	HL
    1594/     99C : 22 34 FF            	LD	(REGPC),HL
    1595/     99F : ED 73 32 FF         	LD	(REGSP),SP
    1596/     9A3 :                     
    1597/     9A3 :                     	;; R register adjustment
    1598/     9A3 : =>TRUE              	IF USE_IDENT
    1599/     9A3 : 3A 1B FF            	LD	A,(PSPEC)
    1600/     9A6 : FE 08               	CP	08H		; Z280
    1601/     9A8 : 28 1F               	JR	Z,R381
    1602/     9AA : FE 09               	CP	09H		; NSC800
    1603/     9AC : 28 13               	JR	Z,R380
    1604/     9AE : 3A 37 FF            	LD	A,(REGR)
    1605/     9B1 : D6 05               	SUB	05H
    1606/     9B3 : E6 7F               	AND	7FH
    1607/     9B5 : 47                  	LD	B,A
    1608/     9B6 : 3A 37 FF            	LD	A,(REGR)
    1609/     9B9 : E6 80               	AND	80H
    1610/     9BB : B0                  	OR	B
    1611/     9BC : 32 37 FF            	LD	(REGR),A
    1612/     9BF : 18 08               	JR	R381
    1613/     9C1 :                     R380:
    1614/     9C1 : 3A 37 FF            	LD	A,(REGR)
    1615/     9C4 : D6 05               	SUB	05H
    1616/     9C6 : 32 37 FF            	LD	(REGR),A
    1617/     9C9 :                     R381:
    1618/     9C9 : [1598]              	ENDIF
    1619/     9C9 :                     
    1620/     9C9 : 21 E3 0A            	LD	HL,RST38MSG
    1621/     9CC : CD 4F 08            	CALL	STROUT
    1622/     9CF : CD 1F 08            	CALL	RDUMP
    1623/     9D2 : C3 5C 02            	JP	WSTART
    1624/     9D5 :                     
    1625/     9D5 : =>FALSE             	ELSE
    1626/     9D5 :                     
    1627/     9D5 :                     	RET
    1628/     9D5 :                     
    1629/     9D5 : [1570]              	ENDIF
    1630/     9D5 :                     
    1631/     9D5 :                     ;;; HD64180/Z180 TRAP Handler
    1632/     9D5 :                     
    1633/     9D5 : =>TRUE              	IF USE_180TRAP
    1634/     9D5 :                     TRAPH:
    1635/     9D5 : =>TRUE              	IF USE_REGCMD
    1636/     9D5 :                     
    1637/     9D5 : 3A 02 FF            	LD	A,(INBUF+2)
    1638/     9D8 : 32 37 FF            	LD	(REGR),A
    1639/     9DB : ED 57               	LD	A,I
    1640/     9DD : 32 36 FF            	LD	(REGI),A
    1641/     9E0 : 22 24 FF            	LD	(REGHL),HL
    1642/     9E3 : ED 53 22 FF         	LD	(REGDE),DE
    1643/     9E7 : E1                  	POP	HL
    1644/     9E8 : 22 20 FF            	LD	(REGBC),HL
    1645/     9EB : E1                  	POP	HL
    1646/     9EC : 22 1E FF            	LD	(REGAF),HL
    1647/     9EF : 08                  	EX	AF,AF'
    1648/     9F0 : F5                  	PUSH	AF
    1649/     9F1 : D9                  	EXX
    1650/     9F2 : 22 2C FF            	LD	(REGHLX),HL
    1651/     9F5 : ED 53 2A FF         	LD	(REGDEX),DE
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 31 - 7/9/2023 8:51:44


    1652/     9F9 : ED 43 28 FF         	LD	(REGBCX),BC
    1653/     9FD : E1                  	POP	HL
    1654/     9FE : 22 26 FF            	LD	(REGAFX),HL
    1655/     A01 : DD 22 2E FF         	LD	(REGIX),IX
    1656/     A05 : FD 22 30 FF         	LD	(REGIY),IY
    1657/     A09 :                     
    1658/     A09 : ED 7B 00 FF         	LD	SP,(INBUF)	; Recover SP
    1659/     A0D : E1                  	POP	HL
    1660/     A0E : 06 0A               	LD	B,10		; for R register adjustment
    1661/     A10 : 3A 03 FF            	LD	A,(INBUF+3)	; ITC
    1662/     A13 : E6 40               	AND	40H
    1663/     A15 : 28 02               	JR	Z,TH0
    1664/     A17 : 2B                  	DEC	HL
    1665/     A18 : 04                  	INC	B
    1666/     A19 :                     TH0:
    1667/     A19 : 2B                  	DEC	HL
    1668/     A1A : 22 34 FF            	LD	(REGPC),HL
    1669/     A1D : ED 73 32 FF         	LD	(REGSP),SP
    1670/     A21 :                     
    1671/     A21 :                     	;; R register adjustment
    1672/     A21 : 3A 37 FF            	LD	A,(REGR)
    1673/     A24 : 90                  	SUB	B
    1674/     A25 : E6 7F               	AND	7FH
    1675/     A27 : 47                  	LD	B,A
    1676/     A28 : 3A 37 FF            	LD	A,(REGR)
    1677/     A2B : E6 80               	AND	80H
    1678/     A2D : B0                  	OR	B
    1679/     A2E : 32 37 FF            	LD	(REGR),A
    1680/     A31 :                     
    1681/     A31 : 21 ED 0A            	LD	HL,TRAPMSG
    1682/     A34 : CD 4F 08            	CALL	STROUT
    1683/     A37 : CD 1F 08            	CALL	RDUMP
    1684/     A3A : C3 5C 02            	JP	WSTART
    1685/     A3D :                     
    1686/     A3D : =>FALSE             	ELSE			; USE_REGCMD
    1687/     A3D :                     
    1688/     A3D :                     	LD	SP,(INBUF)	; Recover SP
    1689/     A3D :                     	POP	HL		; Drop return address
    1690/     A3D :                     	
    1691/     A3D :                     	LD	HL,TRAPMSG
    1692/     A3D :                     	CALL	STROUT
    1693/     A3D :                     	JP	WSTART
    1694/     A3D :                     	
    1695/     A3D : [1635]              	ENDIF			; USE_REGCMD
    1696/     A3D :                     
    1697/     A3D : [1633]              	ENDIF			; USE_180TRAP
    1698/     A3D :                     
    1699/     A3D :                     ;;;
    1700/     A3D :                     ;;; Messages
    1701/     A3D :                     ;;;
    1702/     A3D :                     	
    1703/     A3D :                     OPNMSG:
    1704/     A3D : 0D 0A 55 6E 69 76   	DB	CR,LF,"Universal Monitor Z80",CR,LF,00H
              A43 : 65 72 73 61 6C 20 
              A49 : 4D 6F 6E 69 74 6F 
              A4F : 72 20 5A 38 30 0D 
              A55 : 0A 00             
    1705/     A57 :                     
    1706/     A57 :                     PROMPT:
    1707/     A57 : 5D 20 00            	DB	"] ",00H
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 32 - 7/9/2023 8:51:44


    1708/     A5A :                     
    1709/     A5A :                     IHEMSG:
    1710/     A5A : 45 72 72 6F 72 20   	DB	"Error ihex",CR,LF,00H
              A60 : 69 68 65 78 0D 0A 
              A66 : 00                
    1711/     A67 :                     SHEMSG:
    1712/     A67 : 45 72 72 6F 72 20   	DB	"Error srec",CR,LF,00H
              A6D : 73 72 65 63 0D 0A 
              A73 : 00                
    1713/     A74 :                     ERRMSG:
    1714/     A74 : 45 72 72 6F 72 0D   	DB	"Error",CR,LF,00H
              A7A : 0A 00             
    1715/     A7C :                     
    1716/     A7C :                     DSEP0:
    1717/     A7C : 20 3A 00            	DB	" :",00H
    1718/     A7F :                     DSEP1:
    1719/     A7F : 20 3A 20 00         	DB	" : ",00H
    1720/     A83 :                     IHEXER:
    1721/     A83 : 3A 30 30 30 30 30           DB	":00000001FF",CR,LF,00H
              A89 : 30 30 31 46 46 0D 
              A8F : 0A 00             
    1722/     A91 :                     SRECER:
    1723/     A91 : 53 39 30 33 30 30           DB	"S9030000FC",CR,LF,00H
              A97 : 30 30 46 43 0D 0A 
              A9D : 00                
    1724/     A9E :                     
    1725/     A9E : =>TRUE              	IF USE_IDENT
    1726/     A9E :                     IM80:
    1727/     A9E : 5A 38 30 0D 0A 00   	DB	"Z80",CR,LF,00H
    1728/     AA4 :                     IM180:
    1729/     AA4 : 48 44 36 34 31 38   	DB	"HD64180R",CR,LF,00H
              AAA : 30 52 0D 0A 00    
    1730/     AAF :                     IM180Z:
    1731/     AAF : 48 44 36 34 31 38   	DB	"HD64180Z",CR,LF,00H
              AB5 : 30 5A 0D 0A 00    
    1732/     ABA :                     IM1960:
    1733/     ABA : 5A 38 53 31 38 30   	DB	"Z8S180 SL1960",CR,LF,00H
              AC0 : 20 53 4C 31 39 36 
              AC6 : 30 0D 0A 00       
    1734/     ACA :                     IMZ8S:
    1735/     ACA : 5A 38 53 31 38 30   	DB	"Z8S180",CR,LF,00H
              AD0 : 0D 0A 00          
    1736/     AD3 :                     IM280:
    1737/     AD3 : 5A 32 38 30 0D 0A   	DB	"Z280",CR,LF,00H
              AD9 : 00                
    1738/     ADA :                     IMNSC:
    1739/     ADA : 4E 53 43 38 30 30   	DB	"NSC800",CR,LF,00H
              AE0 : 0D 0A 00          
    1740/     AE3 : [1725]              	ENDIF
    1741/     AE3 :                     
    1742/     AE3 :                     RST38MSG:
    1743/     AE3 : 52 53 54 20 33 38   	DB	"RST 38H",CR,LF,00H
              AE9 : 48 0D 0A 00       
    1744/     AED :                     
    1745/     AED : =>TRUE              	IF USE_180TRAP
    1746/     AED :                     TRAPMSG:
    1747/     AED : 54 52 41 50 0D 0A   	DB	"TRAP",CR,LF,00H
              AF3 : 00                
    1748/     AF4 : [1745]              	ENDIF
    1749/     AF4 :                     
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 33 - 7/9/2023 8:51:44


    1750/     AF4 : =>TRUE              	IF USE_REGCMD
    1751/     AF4 :                     
    1752/     AF4 :                     	;; Register dump table
    1753/     AF4 : 49 0B 1F FF         RDTAB:	DW	RDSA,   REGAF+1
    1754/     AF8 : 01                  	DB	1
    1755/     AF9 : 4D 0B 20 FF         	DW	RDSBC,  REGBC
    1756/     AFD : 02                  	DB	2
    1757/     AFE : 53 0B 22 FF         	DW	RDSDE,  REGDE
    1758/     B02 : 02                  	DB	2
    1759/     B03 : 59 0B 24 FF         	DW	RDSHL,  REGHL
    1760/     B07 : 02                  	DB	2
    1761/     B08 : 5F 0B 1E FF         	DW	RDSF,   REGAF
    1762/     B0C : 01                  	DB	1
    1763/     B0D :                     
    1764/     B0D : 64 0B 2E FF         	DW	RDSIX,  REGIX
    1765/     B11 : 02                  	DB	2
    1766/     B12 : 6A 0B 30 FF         	DW	RDSIY,  REGIY
    1767/     B16 : 02                  	DB	2
    1768/     B17 :                     
    1769/     B17 : 6F 0B 27 FF         	DW	RDSAX,  REGAFX+1
    1770/     B1B : 01                  	DB	1
    1771/     B1C : 75 0B 28 FF         	DW	RDSBCX, REGBCX
    1772/     B20 : 02                  	DB	2
    1773/     B21 : 7B 0B 2A FF         	DW	RDSDEX, REGDEX
    1774/     B25 : 02                  	DB	2
    1775/     B26 : 81 0B 2C FF         	DW	RDSHLX, REGHLX
    1776/     B2A : 02                  	DB	2
    1777/     B2B : 87 0B 26 FF         	DW	RDSFX,  REGAFX
    1778/     B2F : 01                  	DB	1
    1779/     B30 :                     
    1780/     B30 : 8C 0B 32 FF         	DW	RDSSP,  REGSP
    1781/     B34 : 02                  	DB	2
    1782/     B35 : 92 0B 34 FF         	DW	RDSPC,  REGPC
    1783/     B39 : 02                  	DB	2
    1784/     B3A : 97 0B 36 FF         	DW	RDSI,   REGI
    1785/     B3E : 01                  	DB	1
    1786/     B3F : 9B 0B 37 FF         	DW	RDSR,   REGR
    1787/     B43 : 01                  	DB	1
    1788/     B44 :                     
    1789/     B44 : 00 00 00 00         	DW	0000H,  0000H
    1790/     B48 : 00                  	DB	0
    1791/     B49 :                     
    1792/     B49 : 41 20 3D 00         RDSA:	DB	"A =",00H
    1793/     B4D : 20 42 43 20 3D 00   RDSBC:	DB	" BC =",00H
    1794/     B53 : 20 44 45 20 3D 00   RDSDE:	DB	" DE =",00H
    1795/     B59 : 20 48 4C 20 3D 00   RDSHL:	DB	" HL =",00H
    1796/     B5F : 20 46 20 3D 00      RDSF:	DB	" F =",00H
    1797/     B64 : 20 20 49 58 3D 00   RDSIX:	DB	"  IX=",00H
    1798/     B6A : 20 49 59 3D 00      RDSIY:	DB	" IY=",00H
    1799/     B6F : 0D 0A 41 27 3D 00   RDSAX:	DB	CR,LF,"A'=",00H
    1800/     B75 : 20 42 43 27 3D 00   RDSBCX:	DB	" BC'=",00H
    1801/     B7B : 20 44 45 27 3D 00   RDSDEX:	DB	" DE'=",00H
    1802/     B81 : 20 48 4C 27 3D 00   RDSHLX:	DB	" HL'=",00H
    1803/     B87 : 20 46 27 3D 00      RDSFX:	DB	" F'=",00H
    1804/     B8C : 20 20 53 50 3D 00   RDSSP:	DB	"  SP=",00H
    1805/     B92 : 20 50 43 3D 00      RDSPC:	DB	" PC=",00H
    1806/     B97 : 20 49 3D 00         RDSI:	DB	" I=",00H
    1807/     B9B : 20 52 3D 00         RDSR:	DB	" R=",00H
    1808/     B9F :                     
    1809/     B9F :                     RNTAB:
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 34 - 7/9/2023 8:51:44


    1810/     B9F : 41 0F               	DB	'A',0FH		; "A?"
    1811/     BA1 : E9 0B 00 00         	DW	RNTABA,0
    1812/     BA5 : 42 0F               	DB	'B',0FH		; "B?"
    1813/     BA7 : F7 0B 00 00         	DW	RNTABB,0
    1814/     BAB : 43 0F               	DB	'C',0FH		; "C?"
    1815/     BAD : 19 0C 00 00         	DW	RNTABC,0
    1816/     BB1 : 44 0F               	DB	'D',0FH		; "D?"
    1817/     BB3 : 27 0C 00 00         	DW	RNTABD,0
    1818/     BB7 : 45 0F               	DB	'E',0FH		; "E?"
    1819/     BB9 : 49 0C 00 00         	DW	RNTABE,0
    1820/     BBD : 46 0F               	DB	'F',0FH		; "F?"
    1821/     BBF : 57 0C 00 00         	DW	RNTABF,0
    1822/     BC3 : 48 0F               	DB	'H',0FH		; "H?"
    1823/     BC5 : 65 0C 00 00         	DW	RNTABH,0
    1824/     BC9 : 49 0F               	DB	'I',0FH		; "I?"
    1825/     BCB : 95 0C 00 00         	DW	RNTABI,0
    1826/     BCF : 4C 0F               	DB	'L',0FH		; "L?"
    1827/     BD1 : 87 0C 00 00         	DW	RNTABL,0
    1828/     BD5 : 50 0F               	DB	'P',0FH		; "P?"
    1829/     BD7 : A9 0C 00 00         	DW	RNTABP,0
    1830/     BDB : 52 01               	DB	'R',1		; "R"
    1831/     BDD : 37 FF 04 0D         	DW	REGR,RNR
    1832/     BE1 : 53 0F               	DB	'S',0FH		; "S?"
    1833/     BE3 : B1 0C 00 00         	DW	RNTABS,0
    1834/     BE7 :                     
    1835/     BE7 : 00 00               	DB	00H,0		; End mark
    1836/     BE9 :                     
    1837/     BE9 :                     RNTABA:
    1838/     BE9 : 00 01               	DB	00H,1		; "A"
    1839/     BEB : 1F FF B9 0C         	DW	REGAF+1,RNA
    1840/     BEF : 27 01               	DB	'\'',1		; "A'"
    1841/     BF1 : 27 FF D2 0C         	DW	REGAFX+1,RNAX
    1842/     BF5 :                     
    1843/     BF5 : 00 00               	DB	00H,0
    1844/     BF7 :                     	
    1845/     BF7 :                     RNTABB:
    1846/     BF7 : 00 01               	DB	00H,1		; "B"
    1847/     BF9 : 21 FF BE 0C         	DW	REGBC+1,RNB
    1848/     BFD : 27 01               	DB	'\'',1		; "B'"
    1849/     BFF : 29 FF D9 0C         	DW	REGBCX+1,RNBX
    1850/     C03 : 43 0F               	DB	'C',0FH		; "BC?"
    1851/     C05 : 0B 0C 00 00         	DW	RNTABBC,0
    1852/     C09 :                     
    1853/     C09 : 00 00               	DB	00H,0		; End mark
    1854/     C0B :                     
    1855/     C0B :                     RNTABBC:
    1856/     C0B : 00 02               	DB	00H,2		; "BC"
    1857/     C0D : 20 FF BB 0C         	DW	REGBC,RNBC
    1858/     C11 : 27 02               	DB	'\'',2		; "BC'"
    1859/     C13 : 28 FF D5 0C         	DW	REGBCX,RNBCX
    1860/     C17 :                     
    1861/     C17 : 00 00               	DB	00H,0
    1862/     C19 :                     	
    1863/     C19 :                     RNTABC:
    1864/     C19 : 00 01               	DB	00H,1		; "C"
    1865/     C1B : 20 FF C0 0C         	DW	REGBC,RNC
    1866/     C1F : 27 01               	DB	'\'',1		; "C'"
    1867/     C21 : 28 FF DC 0C         	DW	REGBCX,RNCX
    1868/     C25 :                     
    1869/     C25 : 00 00               	DB	00H,0
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 35 - 7/9/2023 8:51:44


    1870/     C27 :                     	
    1871/     C27 :                     RNTABD:
    1872/     C27 : 00 01               	DB	00H,1		; "D"
    1873/     C29 : 23 FF C5 0C         	DW	REGDE+1,RND
    1874/     C2D : 27 01               	DB	'\'',1		; "D'"
    1875/     C2F : 2B FF E3 0C         	DW	REGDEX+1,RNDX
    1876/     C33 : 45 0F               	DB	'E',0FH		; "DE?"
    1877/     C35 : 3B 0C 00 00         	DW	RNTABDE,0
    1878/     C39 :                     
    1879/     C39 : 00 00               	DB	00H,0
    1880/     C3B :                     
    1881/     C3B :                     RNTABDE:
    1882/     C3B : 00 02               	DB	00H,2		; "DE"
    1883/     C3D : 22 FF C2 0C         	DW	REGDE,RNDE
    1884/     C41 : 27 02               	DB	'\'',2		; "DE'"
    1885/     C43 : 2A FF DF 0C         	DW	REGDEX,RNDEX
    1886/     C47 :                     
    1887/     C47 : 00 00               	DB	00H,0
    1888/     C49 :                     	
    1889/     C49 :                     RNTABE:
    1890/     C49 : 00 01               	DB	00H,1		; "E"
    1891/     C4B : 22 FF C7 0C         	DW	REGDE,RNE
    1892/     C4F : 27 01               	DB	'\'',1		; "E'"
    1893/     C51 : 2A FF E6 0C         	DW	REGDEX,RNEX
    1894/     C55 :                     
    1895/     C55 : 00 00               	DB	00H,0
    1896/     C57 :                     	
    1897/     C57 :                     RNTABF:
    1898/     C57 : 00 01               	DB	00H,1		; "F"
    1899/     C59 : 1E FF D0 0C         	DW	REGAF,RNF
    1900/     C5D : 27 01               	DB	'\'',1		; "F'"
    1901/     C5F : 26 FF F3 0C         	DW	REGAFX,RNFX
    1902/     C63 :                     
    1903/     C63 : 00 00               	DB	00H,0
    1904/     C65 :                     	
    1905/     C65 :                     RNTABH:
    1906/     C65 : 00 01               	DB	00H,1		; "H"
    1907/     C67 : 25 FF CC 0C         	DW	REGHL+1,RNH
    1908/     C6B : 27 01               	DB	'\'',1		; "H'"
    1909/     C6D : 2D FF ED 0C         	DW	REGHLX+1,RNHX
    1910/     C71 : 4C 0F               	DB	'L',0FH		; "HL?"
    1911/     C73 : 79 0C 00 00         	DW	RNTABHL,0
    1912/     C77 :                     
    1913/     C77 : 00 00               	DB	00H,0
    1914/     C79 :                     
    1915/     C79 :                     RNTABHL:
    1916/     C79 : 00 02               	DB	00H,2		; "HL"
    1917/     C7B : 24 FF C9 0C         	DW	REGHL,RNHL
    1918/     C7F : 27 02               	DB	'\'',2		; "HL'"
    1919/     C81 : 2C FF E9 0C         	DW	REGHLX,RNHLX
    1920/     C85 :                     
    1921/     C85 : 00 00               	DB	00H,0
    1922/     C87 :                     	
    1923/     C87 :                     RNTABL:
    1924/     C87 : 00 01               	DB	00H,1		; "L"
    1925/     C89 : 24 FF CE 0C         	DW	REGHL,RNL
    1926/     C8D : 27 01               	DB	'\'',1		; "L'"
    1927/     C8F : 2C FF F0 0C         	DW	REGHLX,RNLX
    1928/     C93 :                     
    1929/     C93 : 00 00               	DB	00H,0
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 36 - 7/9/2023 8:51:44


    1930/     C95 :                     	
    1931/     C95 :                     RNTABI:
    1932/     C95 : 00 01               	DB	00H,1		; "I"
    1933/     C97 : 36 FF 02 0D         	DW	REGI,RNI
    1934/     C9B : 58 02               	DB	'X',2		; "IX"
    1935/     C9D : 2E FF F6 0C         	DW	REGIX,RNIX
    1936/     CA1 : 59 02               	DB	'Y',2		; "IY"
    1937/     CA3 : 30 FF F9 0C         	DW	REGIY,RNIY
    1938/     CA7 :                     	
    1939/     CA7 : 00 00               	DB	00H,0
    1940/     CA9 :                     
    1941/     CA9 :                     RNTABP:
    1942/     CA9 : 43 02               	DB	'C',2		; "PC"
    1943/     CAB : 34 FF FF 0C         	DW	REGPC,RNPC
    1944/     CAF :                     
    1945/     CAF : 00 00               	DB	00H,0
    1946/     CB1 :                     
    1947/     CB1 :                     RNTABS:
    1948/     CB1 : 50 02               	DB	'P',2		; "SP"
    1949/     CB3 : 32 FF FC 0C         	DW	REGSP,RNSP
    1950/     CB7 :                     
    1951/     CB7 : 00 00               	DB	00H,0
    1952/     CB9 :                     
    1953/     CB9 : 41 00               RNA:	DB	"A",00H
    1954/     CBB : 42 43 00            RNBC:	DB	"BC",00H
    1955/     CBE : 42 00               RNB:	DB	"B",00H
    1956/     CC0 : 43 00               RNC:	DB	"C",00H
    1957/     CC2 : 44 45 00            RNDE:	DB	"DE",00H
    1958/     CC5 : 44 00               RND:	DB	"D",00H
    1959/     CC7 : 45 00               RNE:	DB	"E",00H
    1960/     CC9 : 48 4C 00            RNHL:	DB	"HL",00H
    1961/     CCC : 48 00               RNH:	DB	"H",00H
    1962/     CCE : 4C 00               RNL:	DB	"L",00H
    1963/     CD0 : 46 00               RNF:	DB	"F",00H
    1964/     CD2 : 41 27 00            RNAX:	DB	"A'",00H
    1965/     CD5 : 42 43 27 00         RNBCX:	DB	"BC'",00H
    1966/     CD9 : 42 27 00            RNBX:	DB	"B'",00H
    1967/     CDC : 43 27 00            RNCX:	DB	"C'",00H
    1968/     CDF : 44 45 27 00         RNDEX:	DB	"DE'",00H
    1969/     CE3 : 44 27 00            RNDX:	DB	"D'",00H
    1970/     CE6 : 45 27 00            RNEX:	DB	"E'",00H
    1971/     CE9 : 48 4C 27 00         RNHLX:	DB	"HL'",00H
    1972/     CED : 48 27 00            RNHX:	DB	"H'",00H
    1973/     CF0 : 4C 27 00            RNLX:	DB	"L'",00H
    1974/     CF3 : 46 27 00            RNFX:	DB	"F'",00H
    1975/     CF6 : 49 58 00            RNIX:	DB	"IX",00H
    1976/     CF9 : 49 59 00            RNIY:	DB	"IY",00H
    1977/     CFC : 53 50 00            RNSP:	DB	"SP",00H
    1978/     CFF : 50 43 00            RNPC:	DB	"PC",00H
    1979/     D02 : 49 00               RNI:	DB	"I",00H
    1980/     D04 : 52 00               RNR:	DB	"R",00H
    1981/     D06 :                     
    1982/     D06 : [1750]              	ENDIF
    1983/     D06 :                     
    1984/     D06 :                     ;;;
    1985/     D06 :                     ;;; Console drivers
    1986/     D06 :                     ;;;
    1987/     D06 :                     
    1988/     D06 : =>FALSE             	IF USE_DEV_8251
    1989/     D06 :                     	INCLUDE	"dev/dev_8251.asm"
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 37 - 7/9/2023 8:51:44


    1990/     D06 : [1988]              	ENDIF
    1991/     D06 :                     
    1992/     D06 : =>TRUE              	IF USE_DEV_Z80SIO
    1993/     D06 :                     	INCLUDE	"dev/dev_z80sio.asm"
(1)    1/     D06 :                     ;;;
(1)    2/     D06 :                     ;;;	Z80 SIO Console Driver
(1)    3/     D06 :                     ;;; 
(1)    4/     D06 :                     
(1)    5/     D06 :                     INIT:
(1)    6/     D06 :                     	;; Initialize SIO
(1)    7/     D06 : DB 19               	IN	A,(SIOAC)
(1)    8/     D08 : DB 1B               	IN	A,(SIOBC)
(1)    9/     D0A :                     	;; Reset both Ch.
(1)   10/     D0A : 3E 18               	LD	A,18H
(1)   11/     D0C : D3 19               	OUT	(SIOAC),A
(1)   12/     D0E : D3 1B               	OUT	(SIOBC),A
(1)   13/     D10 :                     
(1)   14/     D10 : =>TRUE              	IF USE_Z80CTC
(1)   15/     D10 : 3E 07               	LD	A,07H		; Timer mode, 1/16, fall-edge, no ext trigger
(1)   16/     D12 : D3 13               	OUT	(CTC0),A
(1)   17/     D14 : 3E 05               	LD	A,TC_V
(1)   18/     D16 : D3 13               	OUT	(CTC0),A
(1)   19/     D18 : [14]                	ENDIF			; USE_CTC
(1)   20/     D18 :                     	
(1)   21/     D18 :                     	;; Ch.A WR1
(1)   22/     D18 : 3E 01               	LD	A,01H
(1)   23/     D1A : D3 19               	OUT	(SIOAC),A
(1)   24/     D1C : AF                  	XOR	A
(1)   25/     D1D : D3 19               	OUT	(SIOAC),A
(1)   26/     D1F :                     
(1)   27/     D1F :                     	;; Ch.A WR4
(1)   28/     D1F : 3E 04               	LD	A,04H
(1)   29/     D21 : D3 19               	OUT	(SIOAC),A
(1)   30/     D23 : 3E 44               	LD	A,44H		; x16 1 N
(1)   31/     D25 : D3 19               	OUT	(SIOAC),A
(1)   32/     D27 :                     
(1)   33/     D27 :                     	;; Ch.A WR3
(1)   34/     D27 : 3E 03               	LD	A,03H
(1)   35/     D29 : D3 19               	OUT	(SIOAC),A
(1)   36/     D2B : 3E C1               	LD	A,0C1H		; 8bit Receiver enable
(1)   37/     D2D : D3 19               	OUT	(SIOAC),A
(1)   38/     D2F :                     	
(1)   39/     D2F :                     	;; Ch.A WR5
(1)   40/     D2F : 3E 05               	LD	A,05H
(1)   41/     D31 : D3 19               	OUT	(SIOAC),A
(1)   42/     D33 : 3E EA               	LD	A,0EAH		; 8bit Transmitter enable
(1)   43/     D35 : D3 19               	OUT	(SIOAC),A
(1)   44/     D37 :                     
(1)   45/     D37 : C9                  	RET
(1)   46/     D38 :                     
(1)   47/     D38 :                     ;;;
(1)   48/     D38 :                     ;;; SIO Ch.A conin/const/conout w/o interrupt
(1)   49/     D38 :                     ;;;
(1)   50/     D38 :                     
(1)   51/     D38 :                     CONIN:
(1)   52/     D38 : DB 19               	IN	A,(SIOAC)
(1)   53/     D3A : E6 01               	AND	01H
(1)   54/     D3C : 28 FA               	JR	Z,CONIN
(1)   55/     D3E : DB 18               	IN	A,(SIOAD)
(1)   56/     D40 : C9                  	RET
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm(dev/dev_z80sio.asm) - Page 38 - 7/9/2023 8:51:44


(1)   57/     D41 :                     
(1)   58/     D41 :                     CONST:
(1)   59/     D41 : DB 19               	IN	A,(SIOAC)
(1)   60/     D43 : E6 01               	AND	01H
(1)   61/     D45 : C9                  	RET
(1)   62/     D46 :                     
(1)   63/     D46 :                     CONOUT:
(1)   64/     D46 : F5                  	PUSH	AF
(1)   65/     D47 :                     CO0:
(1)   66/     D47 : DB 19               	IN	A,(SIOAC)
(1)   67/     D49 : E6 04               	AND	04H
(1)   68/     D4B : 28 FA               	JR	Z,CO0
(1)   69/     D4D : F1                  	POP	AF
(1)   70/     D4E : D3 18               	OUT	(SIOAD),A
(1)   71/     D50 : C9                  	RET
(1)   72/     D51 :                     
    1994/     D51 : [1992]              	ENDIF
    1995/     D51 :                     
    1996/     D51 : =>FALSE             	IF USE_DEV_NSC858
    1997/     D51 :                     	INCLUDE	"dev/dev_nsc858.asm"
    1998/     D51 : [1996]              	ENDIF
    1999/     D51 :                     
    2000/     D51 : =>FALSE             	IF USE_DEV_Z280
    2001/     D51 :                     	INCLUDE	"dev/dev_z280.asm"
    2002/     D51 : [2000]              	ENDIF
    2003/     D51 :                     
    2004/     D51 : =>FALSE             	IF USE_DEV_64180
    2005/     D51 :                     	INCLUDE	"dev/dev_64180.asm"
    2006/     D51 : [2004]              	ENDIF
    2007/     D51 :                     
    2008/     D51 : =>FALSE             	IF USE_DEV_EMILY
    2009/     D51 :                     	INCLUDE	"dev/dev_emily.asm"
    2010/     D51 : [2008]              	ENDIF
    2011/     D51 :                     
    2012/     D51 :                     ;;;
    2013/     D51 :                     ;;; RAM area
    2014/     D51 :                     ;;;
    2015/     D51 :                     
    2016/     D51 :                     	;;
    2017/     D51 :                     	;; Work Area
    2018/     D51 :                     	;;
    2019/     D51 :                     	
    2020/    FF00 :                     	ORG	WORK_B
    2021/    FF00 :                     
    2022/    FF00 :                     INBUF:	DS	BUFLEN	; Line input buffer
    2023/    FF10 :                     DSADDR:	DS	2	; Dump start address
    2024/    FF12 :                     DEADDR:	DS	2	; Dump end address
    2025/    FF14 :                     DSTATE:	DS	1	; Dump state
    2026/    FF15 :                     GADDR:	DS	2	; Go address
    2027/    FF17 :                     SADDR:	DS	2	; Set address
    2028/    FF19 :                     HEXMOD:	DS	1	; HEX file mode
    2029/    FF1A :                     RECTYP:	DS	1	; Record type
    2030/    FF1B :                     PSPEC:	DS	1	; Processor spec.
    2031/    FF1C :                     SIZE:	DS	1	; I/O Size 00H,'W','S'
    2032/    FF1D :                     IOPAGE:	DS	1	; I/O Page (for Z280)
    2033/    FF1E :                     
    2034/    FF1E : =>TRUE              	IF USE_REGCMD
    2035/    FF1E :                     
    2036/    FF1E :                     REG_B:	
    2037/    FF1E :                     REGAF:	DS	2
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 39 - 7/9/2023 8:51:44


    2038/    FF20 :                     REGBC:	DS	2
    2039/    FF22 :                     REGDE:	DS	2
    2040/    FF24 :                     REGHL:	DS	2
    2041/    FF26 :                     REGAFX:	DS	2		; Register AF'
    2042/    FF28 :                     REGBCX:	DS	2
    2043/    FF2A :                     REGDEX:	DS	2
    2044/    FF2C :                     REGHLX:	DS	2		; Register HL'
    2045/    FF2E :                     REGIX:	DS	2
    2046/    FF30 :                     REGIY:	DS	2
    2047/    FF32 :                     REGSP:	DS	2
    2048/    FF34 :                     REGPC:	DS	2
    2049/    FF36 :                     REGI:	DS	1
    2050/    FF37 :                     REGR:	DS	1
    2051/    FF38 :                     REG_E:
    2052/    FF38 : [2034]              	ENDIF
    2053/    FF38 :                     
    2054/    FF38 : =>TRUE              	IF USE_RAMCHK
    2055/    FF38 :                     RAMEND:	DS	2
    2056/    FF3A : [2054]              	ENDIF
    2057/    FF3A :                     	
    2058/    FF3A :                     	END
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 40 - 7/9/2023 8:51:44


  Symbol Table (* = unused):
  --------------------------

 API00 :                        959 C |  API01 :                        95E C |
 API06 :                        962 C |  APITBL :                       94B C |
*ARCHITECTURE :                                        "i386-unknown-win32" - |
 BS :                             8 - |  BTCR_V :                        30 - |
 BTIR_V :                        40 - |  BUFLEN :                        10 - |
*CASESENSITIVE :                  0 - |  CCR1_V :                         0 - |
 CCR_V :                          0 - |  CO0 :                         0D47 C |
 CONIN :                       0D38 C |  CONOUT :                      0D46 C |
 CONST :                       0D41 C | *CONSTPI :        3.141592653589793 - |
 CR :                            0D - |  CRLF :                         89B C |
 CS0 :                          131 C |  CSTART :                       100 C |
 CTC0 :                          13 - | *DATE :                  "7/9/2023" - |
 DCNTL_V :                        0 - |  DEADDR :                     0FF12 C |
 DEL :                           7F - |  DP0 :                          2C3 C |
 DP1 :                          2DB C |  DPB :                          35F C |
 DPB0 :                         376 C |  DPB1 :                         385 C |
 DPB2 :                         38A C |  DPL :                          325 C |
 DPL0 :                         336 C |  DPL1 :                         346 C |
 DPL2 :                         355 C |  DPL3 :                         35A C |
 DPM :                          2F3 C |  DPM0 :                         2FE C |
 DPM1 :                         31C C |  DSADDR :                     0FF10 C |
 DSEP0 :                       0A7C C |  DSEP1 :                       0A7F C |
 DSTATE :                     0FF14 C |  DUMP :                         2A5 C |
 ENTRY :                         80 - |  ERR :                          29D C |
 ERRMSG :                      0A74 C | *E_CONIN :                      0A0 C |
*E_CONOUT :                      90 C | *E_CONST :                      0A8 C |
*E_CSTART :                      80 C | *E_STROUT :                      98 C |
*E_WSTART :                      88 C | *FALSE :                          0 - |
*FULLPMMU :                       1 - |  G0 :                           3BF C |
 G01 :                          3DD C |  G1 :                           3E5 C |
 GADDR :                      0FF15 C |  GETLIN :                       8A5 C |
 GL0 :                          8AA C |  GLB :                          8D4 C |
 GLE :                          8EB C |  GO :                           3AB C |
*HAS64 :                          0 - | *HASFPU :                         0 - |
*HASPMMU :                        0 - |  HEXIN :                        874 C |
 HEXMOD :                     0FF19 C |  HEXOUT1 :                      866 C |
 HEXOUT2 :                      85D C |  HEXOUT4 :                      858 C |
 HI0 :                          87C C |  HI1 :                          896 C |
 HIR :                          899 C |  IDE :                          205 C |
 ID_180 :                       17C C |  ID_180Z :                      19E C |
 ID_1960 :                      1BF C |  ID_280 :                       1D7 C |
 ID_NSC :                       200 C |  ID_Z8S :                       1CB C |
 IHEMSG :                      0A5A C |  IHEXER :                      0A83 C |
 IM180 :                       0AA4 C |  IM180Z :                      0AAF C |
 IM1960 :                      0ABA C |  IM280 :                       0AD3 C |
 IM80 :                        0A9E C |  IMNSC :                       0ADA C |
 IMZ8S :                       0ACA C |  INBUF :                      0FF00 C |
 INIT :                        0D06 C | *INSUPMODE :                      0 - |
 IOBASE :                       0C0 - |  IOPAGE :                     0FF1D C |
 IR0 :                          229 C |  LF :                            0A - |
 LH0 :                          49F C | *LH1 :                          4A9 C |
 LH2 :                          4AD C |  LH3 :                          4B5 C |
 LHI0 :                         4BA C |  LHI1 :                         4D8 C |
 LHI2 :                         4EA C |  LHI20 :                        4E9 C |
 LHI3 :                         4EC C |  LHIE :                         4FC C |
 LHS0 :                         505 C |  LHS1 :                         522 C |
 LHS2 :                         534 C |  LHS20 :                        535 C |
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 41 - 7/9/2023 8:51:44


 LHS3 :                         537 C |  LHSE :                         551 C |
 LHSR :                         557 C | *LISTON :                         1 - |
 LOADH :                        489 C | *MACEXP :                         7 - |
*MOMCPU :                        80 - | *MOMCPUNAME :                 "Z80" - |
*NESTMAX :                      100 - |  OMCR_V :                        40 - |
 OPNMSG :                      0A3D C | *PADDING :                        1 - |
 PB0 :                          783 C |  PBANK :                        761 C |
 PI0 :                          64F C |  PI1 :                          653 C |
 PIB :                          685 C |  PIN :                          637 C |
 PIS :                          6BE C |  PIW :                          6A1 C |
 PO0 :                          6E1 C |  PO1 :                          6E5 C |
 POB :                          72A C |  POS :                          75B C |
 POUT :                         6C9 C |  POW :                          741 C |
 PROMPT :                      0A57 C |  PSPEC :                      0FF1B C |
 R380 :                         9C1 C |  R381 :                         9C9 C |
 RAMEND :                     0FF38 C |  RAM_B :                       8000 - |
 RC0 :                          13A C |  RC1 :                          14A C |
 RC2 :                          14F C |  RCE :                          158 C |
 RD0 :                          822 C |  RD1 :                          842 C |
 RDHEX :                        901 C |  RDSA :                        0B49 C |
 RDSAX :                       0B6F C |  RDSBC :                       0B4D C |
 RDSBCX :                      0B75 C |  RDSDE :                       0B53 C |
 RDSDEX :                      0B7B C |  RDSF :                        0B5F C |
 RDSFX :                       0B87 C |  RDSHL :                       0B59 C |
 RDSHLX :                      0B81 C |  RDSI :                        0B97 C |
 RDSIX :                       0B64 C |  RDSIY :                       0B6A C |
 RDSPC :                       0B92 C |  RDSR :                        0B9B C |
 RDSSP :                       0B8C C |  RDTAB :                       0AF4 C |
 RDUMP :                        81F C |  RECTYP :                     0FF1A C |
 REG :                          78F C |  REGAF :                      0FF1E C |
 REGAFX :                     0FF26 C |  REGBC :                      0FF20 C |
 REGBCX :                     0FF28 C |  REGDE :                      0FF22 C |
 REGDEX :                     0FF2A C |  REGHL :                      0FF24 C |
 REGHLX :                     0FF2C C |  REGI :                       0FF36 C |
 REGIX :                      0FF2E C |  REGIY :                      0FF30 C |
 REGPC :                      0FF34 C |  REGR :                       0FF37 C |
 REGSP :                      0FF32 C |  REG_B :                      0FF1E C |
 REG_E :                      0FF38 C | *RELAXED :                        0 - |
 RG0 :                          79F C |  RG1 :                          7A3 C |
 RG2 :                          7B3 C |  RG3 :                          7C5 C |
 RG4 :                          7EA C |  RG5 :                          7F6 C |
 RG6 :                          816 C |  RG7 :                          819 C |
 RGE :                          81C C |  RGR :                          819 C |
 RH0 :                          906 C |  RH1 :                          91C C |
 RHE :                          93A C |  RMR_V :                         83 - |
 RNA :                         0CB9 C |  RNAX :                        0CD2 C |
 RNB :                         0CBE C |  RNBC :                        0CBB C |
 RNBCX :                       0CD5 C |  RNBX :                        0CD9 C |
 RNC :                         0CC0 C |  RNCX :                        0CDC C |
 RND :                         0CC5 C |  RNDE :                        0CC2 C |
 RNDEX :                       0CDF C |  RNDX :                        0CE3 C |
 RNE :                         0CC7 C |  RNEX :                        0CE6 C |
 RNF :                         0CD0 C |  RNFX :                        0CF3 C |
 RNH :                         0CCC C |  RNHL :                        0CC9 C |
 RNHLX :                       0CE9 C |  RNHX :                        0CED C |
 RNI :                         0D02 C |  RNIX :                        0CF6 C |
 RNIY :                        0CF9 C |  RNL :                         0CCE C |
 RNLX :                        0CF0 C |  RNPC :                        0CFF C |
 RNR :                         0D04 C |  RNSP :                        0CFC C |
 RNTAB :                       0B9F C |  RNTABA :                      0BE9 C |
 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 42 - 7/9/2023 8:51:44


 RNTABB :                      0BF7 C |  RNTABBC :                     0C0B C |
 RNTABC :                      0C19 C |  RNTABD :                      0C27 C |
 RNTABDE :                     0C3B C |  RNTABE :                      0C49 C |
 RNTABF :                      0C57 C |  RNTABH :                      0C65 C |
 RNTABHL :                     0C79 C |  RNTABI :                      0C95 C |
 RNTABL :                      0C87 C |  RNTABP :                      0CA9 C |
 RNTABS :                      0CB1 C |  RRR_V :                         38 - |
 RST30H :                       93B C |  RST38H :                       966 C |
 RST38MSG :                    0AE3 C |  SADDR :                      0FF17 C |
 SAVEH :                        55A C |  SETM :                         422 C |
 SH0 :                          567 C |  SH1 :                          56B C |
 SH2 :                          595 C |  SH3 :                          59D C |
 SH4 :                          5B4 C |  SHE :                          592 C |
 SHEMSG :                      0A67 C |  SHL :                          5BD C |
 SHL0 :                         5C8 C |  SHLI0 :                        5F1 C |
 SHLS :                         605 C |  SHLS0 :                        624 C |
 SIOAC :                         19 - |  SIOAD :                         18 - |
 SIOBC :                         1B - | *SIOBD :                         1A - |
 SIZE :                       0FF1C C |  SKIPSP :                       8F1 C |
 SM0 :                          439 C |  SM1 :                          43A C |
 SM2 :                          463 C |  SM3 :                          46E C |
 SM4 :                          479 C |  SRECER :                      0A91 C |
 STACK :                          0 - |  STROUT :                       84F C |
*TARGET :                     "Z80" - |  TC_V :                           5 - |
 TH0 :                         0A19 C | *TIME :                   "8:51:44" - |
 TL :                           235 C |  TRAPH :                        9D5 C |
 TRAPMSG :                     0AED C | *TRUE :                           1 - |
 UPPER :                        8F8 C |  USE_180TRAP :                    1 - |
 USE_DEV_64180 :                  0 - |  USE_DEV_8251 :                   0 - |
 USE_DEV_EMILY :                  0 - |  USE_DEV_NSC858 :                 0 - |
 USE_DEV_Z280 :                   0 - |  USE_DEV_Z80SIO :                 1 - |
 USE_IDENT :                      1 - |  USE_NEWAPI :                     1 - |
 USE_RAMCHK :                     1 - |  USE_REGCMD :                     1 - |
 USE_SPINIT :                     0 - |  USE_WARMUP :                     0 - |
 USE_Z80CTC :                     1 - | *VERSION :                     142F - |
 WORK_B :                     0FF00 - |  WSTART :                       25C C |

    305 symbols
     29 unused symbols

 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 43 - 7/9/2023 8:51:44


  Defined Functions:
  ------------------

HIGH                                  | LOW                                  

 AS V1.42 Beta [Bld 246] - Source File unimon_z80.asm - Page 44 - 7/9/2023 8:51:44


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.04 seconds assembly time

   2280 lines source file
      2 passes
      0 errors
      0 warnings
